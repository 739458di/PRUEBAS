<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FYRADRIVE - CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- CRM en tiempo real -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --dark: #111827;
            --gray: #6b7280;
            --gray-light: #9ca3af;
            --border: #e5e7eb;
            --bg: #f5f5f4;
            --white: #ffffff;
            --cyan: #0891b2;
            --green: #10b981;
            --orange: #f59e0b;
            --red: #ef4444;
            --purple: #7c3aed;
            --blue: #3b82f6;
            --pink: #ec4899;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            color: var(--dark);
        }

        /* SYNC INDICATOR */
        .sync-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 3px;
            background: var(--cyan); z-index: 9999;
            transform: scaleX(0); transform-origin: left;
            transition: transform 0.3s;
        }
        .sync-bar.active { transform: scaleX(1); }
        .sync-badge {
            position: fixed; bottom: 20px; right: 20px;
            padding: 8px 16px; border-radius: 50px;
            font-size: 11px; font-weight: 700;
            display: flex; align-items: center; gap: 6px;
            z-index: 1000; box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }
        .sync-badge.online { background: #d1fae5; color: #065f46; }
        .sync-badge.offline { background: #fecaca; color: #991b1b; }
        .sync-dot {
            width: 8px; height: 8px; border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .sync-badge.online .sync-dot { background: #10b981; }
        .sync-badge.offline .sync-dot { background: #ef4444; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* NAV */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 32px;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 22px; font-weight: 900; letter-spacing: 0.04em; color: var(--dark); text-decoration: none; }
        .nav-links { display: flex; align-items: center; gap: 24px; }
        .nav-links a { text-decoration: none; color: #374151; font-size: 12px; font-weight: 600; letter-spacing: 0.04em; transition: color 0.2s; cursor: pointer; }
        .nav-links a:hover { color: var(--dark); }
        .nav-links a.active { color: var(--cyan); border-bottom: 2px solid var(--cyan); padding-bottom: 2px; }
        .user-badge {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 14px; background: #f0fdf4; border-radius: 50px;
            font-size: 12px; font-weight: 700; color: #065f46;
            border: 1px solid #d1fae5; cursor: pointer;
        }

        /* HEADER */
        .crm-header {
            padding: 28px 32px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .crm-header h1 { font-size: 26px; font-weight: 900; }
        .crm-header p { font-size: 13px; color: var(--gray); margin-top: 2px; }
        .header-actions { display: flex; gap: 10px; }

        /* STATS */
        .stats-row {
            display: flex; gap: 12px; padding: 0 32px 20px; flex-wrap: wrap;
        }
        .stat-card {
            flex: 1; min-width: 140px;
            background: var(--white); border-radius: 12px; padding: 16px 18px;
            border: 1px solid var(--border);
        }
        .stat-label { font-size: 10px; font-weight: 700; color: var(--gray); text-transform: uppercase; letter-spacing: 0.06em; }
        .stat-value { font-size: 28px; font-weight: 900; margin-top: 4px; }
        .stat-sub { font-size: 11px; color: var(--gray); margin-top: 2px; }

        /* TABS */
        .tabs-bar {
            display: flex; gap: 0; padding: 0 32px; border-bottom: 1px solid var(--border); background: var(--white);
        }
        .tab-btn {
            padding: 14px 24px; border: none; background: transparent;
            font-size: 13px; font-weight: 700; color: var(--gray);
            cursor: pointer; border-bottom: 3px solid transparent;
            transition: all 0.2s; font-family: 'Inter', sans-serif;
        }
        .tab-btn:hover { color: var(--dark); }
        .tab-btn.active { color: var(--cyan); border-bottom-color: var(--cyan); }
        .tab-count {
            display: inline-flex; align-items: center; justify-content: center;
            min-width: 20px; height: 20px; border-radius: 50px;
            background: #f3f4f6; font-size: 11px; font-weight: 800;
            margin-left: 6px; padding: 0 6px;
        }
        .tab-btn.active .tab-count { background: #ecfeff; color: var(--cyan); }

        /* TOOLBAR */
        .toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 32px; gap: 12px; flex-wrap: wrap;
        }
        .toolbar-left { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .search-box {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 14px; background: var(--white);
            border: 1.5px solid var(--border); border-radius: 8px;
            min-width: 240px;
        }
        .search-box input {
            border: none; outline: none; font-size: 13px;
            font-family: 'Inter', sans-serif; width: 100%; background: transparent;
        }
        .filter-btn {
            padding: 8px 14px; background: var(--white);
            border: 1.5px solid var(--border); border-radius: 8px;
            font-size: 12px; font-weight: 600; color: var(--gray);
            cursor: pointer; font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }
        .filter-btn:hover { border-color: var(--cyan); color: var(--cyan); }
        .filter-btn.active-filter { border-color: var(--cyan); color: var(--cyan); background: #ecfeff; }
        .btn-new {
            padding: 10px 20px; background: var(--cyan); color: var(--white);
            border: none; border-radius: 8px; font-size: 13px; font-weight: 700;
            cursor: pointer; font-family: 'Inter', sans-serif; transition: all 0.2s;
            display: flex; align-items: center; gap: 6px;
        }
        .btn-new:hover { background: #0e7490; transform: translateY(-1px); }

        /* TABLE */
        .table-container {
            padding: 0 32px 32px; overflow-x: auto;
        }
        table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            background: var(--white); border-radius: 12px;
            border: 1px solid var(--border); overflow: hidden;
        }
        thead th {
            padding: 12px 16px; text-align: left;
            font-size: 10px; font-weight: 700; color: var(--gray);
            text-transform: uppercase; letter-spacing: 0.06em;
            background: #f9fafb; border-bottom: 1px solid var(--border);
            white-space: nowrap; position: sticky; top: 0;
        }
        tbody td {
            padding: 14px 16px; font-size: 13px; font-weight: 500;
            border-bottom: 1px solid #f3f4f6; vertical-align: middle;
        }
        tbody tr { transition: background 0.15s; }
        tbody tr:hover { background: #f9fafb; }
        tbody tr:last-child td { border-bottom: none; }

        .client-name {
            font-weight: 700; color: var(--dark); display: flex;
            align-items: center; gap: 10px; white-space: nowrap;
        }
        .client-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 800; color: var(--white);
            flex-shrink: 0;
        }
        .client-phone {
            display: flex; align-items: center; gap: 6px;
            font-size: 12px; color: var(--gray);
        }
        .client-phone a {
            color: #25d366; text-decoration: none; font-weight: 700;
            display: flex; align-items: center; gap: 3px;
        }

        /* BADGES */
        .badge {
            display: inline-flex; align-items: center; padding: 4px 10px;
            border-radius: 50px; font-size: 11px; font-weight: 700;
            white-space: nowrap; letter-spacing: 0.02em;
        }
        .badge-alta { background: #d1fae5; color: #065f46; }
        .badge-media { background: #fef3c7; color: #92400e; }
        .badge-baja { background: #fecaca; color: #991b1b; }
        .badge-info { background: #e0e7ff; color: #3730a3; }
        .badge-publicado { background: #d1fae5; color: #065f46; }
        .badge-publicar { background: #dbeafe; color: #1e40af; }
        .badge-carece { background: #fef3c7; color: #92400e; }
        .badge-previa { background: #f3f4f6; color: #374151; }
        .badge-agendada { background: #dbeafe; color: #1e40af; }
        .badge-concretada { background: #d1fae5; color: #065f46; }
        .badge-tramite { background: #fef3c7; color: #92400e; }
        .badge-separado { background: #e9d5ff; color: #6b21a8; }
        .badge-vendido { background: #10b981; color: var(--white); }
        .badge-fallida { background: #fecaca; color: #991b1b; }

        .responsable-tag {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 3px 10px; border-radius: 50px; font-size: 11px; font-weight: 700;
        }
        .resp-sebastian { background: #ede9fe; color: #5b21b6; }
        .resp-mario { background: #fce7f3; color: #9d174d; }

        .description-cell {
            max-width: 180px; font-size: 12px; color: var(--gray);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .actions-cell {
            display: flex; gap: 6px;
        }
        .btn-icon {
            width: 32px; height: 32px; border: 1px solid var(--border);
            border-radius: 8px; background: var(--white); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: all 0.2s;
        }
        .btn-icon:hover { background: #f3f4f6; border-color: var(--cyan); }
        .btn-icon.delete:hover { background: #fef2f2; border-color: var(--red); }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
            display: none; align-items: center; justify-content: center;
            z-index: 1000; padding: 20px;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--white); border-radius: 16px;
            width: 100%; max-width: 560px; max-height: 90vh;
            overflow-y: auto; box-shadow: 0 24px 64px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 20px 24px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h2 { font-size: 18px; font-weight: 800; }
        .modal-close {
            width: 32px; height: 32px; border-radius: 8px; border: none;
            background: #f3f4f6; cursor: pointer; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .modal-close:hover { background: #e5e7eb; }
        .modal-body { padding: 24px; }
        .modal-footer {
            padding: 16px 24px; border-top: 1px solid var(--border);
            display: flex; justify-content: flex-end; gap: 10px;
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 14px; }
        .form-row.full { grid-template-columns: 1fr; }
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label {
            font-size: 11px; font-weight: 700; color: var(--gray);
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .form-group input, .form-group select, .form-group textarea {
            padding: 10px 12px; border: 1.5px solid var(--border);
            border-radius: 8px; font-size: 13px; font-family: 'Inter', sans-serif;
            font-weight: 500; transition: border-color 0.2s; background: var(--white);
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--cyan);
        }
        .form-group textarea { resize: vertical; min-height: 60px; }
        .btn-save {
            padding: 10px 24px; background: var(--cyan); color: var(--white);
            border: none; border-radius: 8px; font-size: 13px; font-weight: 700;
            cursor: pointer; font-family: 'Inter', sans-serif;
        }
        .btn-save:hover { background: #0e7490; }
        .btn-cancel {
            padding: 10px 24px; background: #f3f4f6; color: var(--dark);
            border: none; border-radius: 8px; font-size: 13px; font-weight: 700;
            cursor: pointer; font-family: 'Inter', sans-serif;
        }

        /* CITA FIELDS (conditional) */
        .cita-fields {
            display: none; margin-top: 14px; padding: 16px;
            background: #f0f9ff; border-radius: 10px; border: 1px solid #bae6fd;
        }
        .cita-fields.show { display: block; }
        .cita-fields h4 {
            font-size: 12px; font-weight: 800; color: #0369a1;
            text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px;
        }

        /* ======================== */
        /* SEGUIMIENTO STYLES      */
        /* ======================== */
        .badge-preagendacion { background: #f3f4f6; color: #374151; }
        .badge-citaconfirmada { background: #dbeafe; color: #1e40af; }
        .badge-encamino { background: #fef3c7; color: #92400e; }
        .badge-llegoallugar { background: #e9d5ff; color: #6b21a8; }
        .badge-encita { background: #fce7f3; color: #9d174d; }
        .badge-postcita { background: #d1fae5; color: #065f46; }
        .badge-tramitebancario { background: #fef3c7; color: #92400e; }
        .badge-separado { background: #e9d5ff; color: #6b21a8; }
        .badge-vendido { background: #10b981; color: var(--white); }
        .badge-ventafallida { background: #fecaca; color: #991b1b; }

        /* Seguimiento indicator in table */
        .seg-indicator {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 50px; font-size: 10px; font-weight: 700;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .seg-aldia { background: #d1fae5; color: #065f46; }
        .seg-pendiente { background: #fef3c7; color: #92400e; }
        .seg-urgente { background: #fecaca; color: #991b1b; animation: urgentPulse 1.5s infinite; }
        .seg-indicator:hover { transform: scale(1.05); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        @keyframes urgentPulse { 0%,100% { opacity:1; } 50% { opacity:0.7; } }

        /* Alert badge (table) */
        .seg-alert-badge {
            display: inline-flex; align-items: center; gap: 3px;
            padding: 2px 7px; border-radius: 50px; font-size: 9px; font-weight: 800;
            background: #ef4444; color: white; margin-left: 4px;
            animation: alertBounce 1s infinite;
        }
        @keyframes alertBounce { 0%,100% { transform: scale(1); } 50% { transform: scale(1.15); } }

        /* Panel de Seguimiento */
        .seg-panel {
            position: fixed; top: 0; right: -500px; width: 480px; height: 100vh;
            background: var(--white); box-shadow: -8px 0 32px rgba(0,0,0,0.15);
            z-index: 1200; transition: right 0.3s ease; overflow-y: auto;
        }
        .seg-panel.open { right: 0; }
        .seg-panel-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.3); z-index: 1199; display:none;
        }
        .seg-panel-overlay.show { display: block; }
        .seg-panel-header {
            padding: 20px 24px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; background: var(--white); z-index: 5;
        }
        .seg-panel-header h3 { font-size: 16px; font-weight: 800; }
        .seg-close {
            width: 32px; height: 32px; border-radius: 8px; border: none;
            background: #f3f4f6; cursor: pointer; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
        }
        .seg-section { padding: 16px 24px; border-bottom: 1px solid #f3f4f6; }
        .seg-section-title {
            font-size: 10px; font-weight: 700; color: var(--gray);
            text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px;
        }

        /* CRONOMETRO en tiempo real */
        .seg-crono {
            text-align: center; padding: 24px; border-radius: 16px; position: relative;
            overflow: hidden;
        }
        .seg-crono.fresh { background: linear-gradient(135deg, #ecfdf5, #d1fae5); }
        .seg-crono.attention { background: linear-gradient(135deg, #fffbeb, #fef3c7); }
        .seg-crono.urgent { background: linear-gradient(135deg, #fef2f2, #fecaca); }
        .seg-crono-time {
            font-size: 48px; font-weight: 900; font-family: 'Courier New', monospace;
            letter-spacing: 2px; line-height: 1;
        }
        .seg-crono-sub { font-size: 11px; font-weight: 600; margin-top: 6px; opacity: 0.8; }
        .seg-crono-label {
            font-size: 10px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1px; margin-top: 8px; opacity: 0.6;
        }
        /* Progress bar inside crono */
        .seg-crono-progress {
            height: 4px; background: rgba(0,0,0,0.1); border-radius: 4px;
            margin-top: 12px; overflow: hidden;
        }
        .seg-crono-progress-fill {
            height: 100%; border-radius: 4px; transition: width 1s linear;
        }
        .seg-crono.fresh .seg-crono-progress-fill { background: #10b981; }
        .seg-crono.attention .seg-crono-progress-fill { background: #f59e0b; }
        .seg-crono.urgent .seg-crono-progress-fill { background: #ef4444; }

        /* Alerta de mensaje sugerido */
        .seg-alerta {
            background: linear-gradient(135deg, #fef2f2, #fecaca); border: 2px solid #f87171;
            border-radius: 12px; padding: 14px; margin-bottom: 12px;
            animation: alertGlow 2s infinite;
        }
        @keyframes alertGlow { 0%,100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.3); } 50% { box-shadow: 0 0 16px 4px rgba(239,68,68,0.15); } }
        .seg-alerta-title {
            font-size: 12px; font-weight: 800; color: #dc2626;
            display: flex; align-items: center; gap: 6px; margin-bottom: 4px;
        }
        .seg-alerta-desc { font-size: 11px; color: #7f1d1d; }

        /* State flow */
        .seg-state-flow { display: flex; gap: 2px; margin-bottom: 12px; flex-wrap: wrap; }
        .seg-state-dot {
            padding: 4px 8px; border-radius: 4px; font-size: 9px; font-weight: 700;
            background: #f3f4f6; color: var(--gray-light); white-space: nowrap;
        }
        .seg-state-dot.active { background: var(--cyan); color: white; }
        .seg-state-dot.done { background: #d1fae5; color: #065f46; }

        /* Mensaje editable area */
        .seg-mensaje-box {
            background: #f0fdf4; border: 1.5px solid #bbf7d0; border-radius: 12px;
            padding: 14px; position: relative;
        }
        .seg-mensaje-textarea {
            width: 100%; min-height: 80px; border: none; background: transparent;
            font-size: 13px; line-height: 1.6; color: #1a1a1a; resize: vertical;
            font-family: 'Inter', sans-serif; font-weight: 500; outline: none;
        }
        .seg-mensaje-label {
            font-size: 9px; font-weight: 700; color: #065f46; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 6px;
        }
        .seg-mensaje-actions { display: flex; gap: 8px; margin-top: 10px; }
        .seg-btn-wa {
            flex: 1; padding: 12px; background: #25d366; color: white; border: none;
            border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer;
            font-family: 'Inter', sans-serif; display: flex; align-items: center;
            justify-content: center; gap: 6px; transition: all 0.2s;
        }
        .seg-btn-wa:hover { background: #1da851; }
        .seg-btn-alt {
            padding: 12px 16px; background: #f3f4f6; color: var(--dark); border: none;
            border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer;
            font-family: 'Inter', sans-serif; transition: all 0.2s;
        }
        .seg-btn-alt:hover { background: #e5e7eb; }

        /* Options row */
        .seg-opciones { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
        .seg-opcion-btn {
            padding: 6px 12px; border: 1.5px solid var(--border); border-radius: 50px;
            background: var(--white); cursor: pointer; font-size: 11px; font-weight: 700;
            font-family: 'Inter', sans-serif; transition: all 0.2s; color: var(--dark);
        }
        .seg-opcion-btn:hover { border-color: var(--cyan); background: #ecfeff; }
        .seg-opcion-btn.active { border-color: var(--cyan); background: var(--cyan); color: white; }

        /* Historial */
        .seg-historial-item {
            display: flex; align-items: flex-start; gap: 10px; padding: 8px 0;
            border-bottom: 1px solid #f9fafb; font-size: 12px;
        }
        .seg-historial-item:last-child { border-bottom: none; }
        .seg-hist-dot { width: 8px; height: 8px; border-radius: 50%; background: #25d366; margin-top: 4px; flex-shrink: 0; }
        .seg-hist-time { font-size: 10px; color: var(--gray); }
        .seg-hist-msg { color: var(--dark); font-weight: 500; }

        /* Avanzar estado */
        .seg-btn-advance {
            width: 100%; padding: 12px; background: linear-gradient(135deg, var(--cyan), #06b6d4);
            color: white; border: none; border-radius: 10px; font-size: 13px; font-weight: 700;
            cursor: pointer; font-family: 'Inter', sans-serif; margin-top: 8px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .seg-btn-advance:hover { background: linear-gradient(135deg, #0e7490, var(--cyan)); }

        /* Token */
        .seg-token-box {
            text-align: center; padding: 16px; background: linear-gradient(135deg, #1e1b4b, #312e81);
            border-radius: 12px; color: white;
        }
        .seg-token-code { font-size: 32px; font-weight: 900; letter-spacing: 8px; margin: 8px 0; font-family: 'Courier New', monospace; }
        .seg-token-label { font-size: 10px; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }

        /* Panico */
        .seg-btn-panico {
            width: 100%; padding: 14px; background: #dc2626; color: white;
            border: none; border-radius: 10px; font-size: 14px; font-weight: 800;
            cursor: pointer; font-family: 'Inter', sans-serif;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            animation: panicoPulse 2s infinite;
        }
        @keyframes panicoPulse { 0%,100% { box-shadow: 0 0 0 0 rgba(220,38,38,0.4); } 50% { box-shadow: 0 0 0 12px rgba(220,38,38,0); } }

        /* Post-cita resultado */
        .seg-postcita-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .seg-postcita-btn {
            padding: 10px; border: 1.5px solid var(--border); border-radius: 8px;
            background: var(--white); cursor: pointer; text-align: center;
            font-family: 'Inter', sans-serif; transition: all 0.2s; font-size: 11px; font-weight: 700;
        }
        .seg-postcita-btn:hover { border-color: var(--cyan); background: #ecfeff; }
        .seg-postcita-btn.selected { border-color: var(--cyan); background: #ecfeff; }

        /* CRM Alert Notification (top banner) */
        .seg-crm-alert {
            position: fixed; top: 56px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(135deg, #dc2626, #ef4444); color: white;
            padding: 10px 20px; border-radius: 12px; font-size: 12px; font-weight: 700;
            display: none; align-items: center; gap: 10px; z-index: 1100;
            box-shadow: 0 8px 32px rgba(220,38,38,0.3); cursor: pointer;
            animation: alertSlideIn 0.4s ease-out;
        }
        .seg-crm-alert.show { display: flex; }
        @keyframes alertSlideIn { from { transform: translateX(-50%) translateY(-20px); opacity:0; } to { transform: translateX(-50%) translateY(0); opacity:1; } }

        /* NOTIFICATION */
        .notification {
            position: fixed; top: 72px; right: 20px;
            background: var(--dark); color: var(--white);
            padding: 12px 18px; border-radius: 10px; font-size: 13px; font-weight: 600;
            display: flex; align-items: center; gap: 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transform: translateX(400px); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 1100; max-width: 340px;
        }
        .notification.show { transform: translateX(0); }

        /* EMPTY STATE */
        .empty-state {
            text-align: center; padding: 60px 20px; color: var(--gray);
        }
        .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-state p { font-size: 14px; }

        /* LOADING */
        .loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9); display: flex;
            align-items: center; justify-content: center; z-index: 2000;
            flex-direction: column; gap: 16px;
        }
        .loading-overlay.hidden { display: none; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--border);
            border-top-color: var(--cyan); border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* FOOTER */
        footer {
            text-align: center; padding: 20px; color: var(--gray);
            font-size: 11px; border-top: 1px solid var(--border); background: var(--white);
        }

        /* ======================== */
        /* COTIZADOR STYLES        */
        /* ======================== */
        .cot-container { padding: 12px 32px 32px; max-width: 560px; margin: 0 auto; }
        .cot-card {
            background: var(--white); border-radius: 14px; padding: 14px;
            margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid var(--border);
        }
        .cot-card-title {
            font-size: 12px; font-weight: 700; color: var(--cyan);
            margin-bottom: 12px; display: flex; align-items: center; gap: 6px;
        }
        .cot-card-title::before {
            content: ''; width: 3px; height: 14px; background: var(--cyan); border-radius: 2px;
        }
        .cot-input-group { margin-bottom: 12px; }
        .cot-input-group label {
            display: block; font-size: 11px; color: var(--gray); margin-bottom: 4px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.04em;
        }
        .cot-input-group input, .cot-input-group select {
            width: 100%; padding: 12px 14px; font-size: 16px;
            border: 2px solid var(--border); border-radius: 10px;
            background: var(--bg); color: var(--dark); font-weight: 600;
            font-family: 'Inter', sans-serif;
        }
        .cot-input-group input:focus, .cot-input-group select:focus {
            outline: none; border-color: var(--cyan); background: white;
        }
        .cot-input-group select {
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpolyline points='6,9 12,15 18,9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 12px center; padding-right: 40px;
        }
        .cot-input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .cot-enganche-box {
            background: linear-gradient(135deg, rgba(8,145,178,0.08), rgba(6,182,212,0.08));
            border-radius: 10px; padding: 12px; margin-top: 6px;
        }
        .cot-enganche-label { font-size: 11px; font-weight: 600; color: var(--cyan); margin-bottom: 10px; }
        .cot-enganche-display {
            display: flex; justify-content: space-between; align-items: center;
            background: white; padding: 10px 14px; border-radius: 8px; margin-top: 10px;
        }
        .cot-enganche-display .pct { font-size: 18px; font-weight: 700; color: var(--cyan); }
        .cot-enganche-display .amount { font-size: 15px; font-weight: 600; }
        .cot-plazo-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        .cot-plazo-btn {
            padding: 14px 6px; background: var(--bg); border: 2px solid var(--border);
            border-radius: 10px; font-size: 14px; font-weight: 700; color: var(--dark);
            cursor: pointer; text-align: center; font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }
        .cot-plazo-btn:active { transform: scale(0.95); }
        .cot-plazo-btn.active {
            background: linear-gradient(135deg, var(--cyan), #06b6d4);
            border-color: var(--cyan); color: white;
        }
        .cot-plazo-btn.disabled { opacity: 0.3; pointer-events: none; }
        .cot-resultado {
            background: linear-gradient(135deg, var(--green), #34d399);
            border-radius: 16px; padding: 20px; text-align: center; color: white;
            box-shadow: 0 6px 20px rgba(16,185,129,0.25); margin-bottom: 12px;
        }
        .cot-resultado-header {
            display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 6px;
        }
        .cot-check {
            width: 28px; height: 28px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }
        .cot-check svg { width: 18px; height: 18px; stroke: var(--green); }
        .cot-resultado-label {
            font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
        }
        .cot-resultado-monto { font-size: 38px; font-weight: 800; margin: 6px 0; }
        .cot-resultado-nota { font-size: 11px; opacity: 0.9; }
        .cot-desglose-item {
            display: flex; justify-content: space-between; padding: 8px 0;
            border-bottom: 1px solid var(--border); font-size: 13px;
        }
        .cot-desglose-item:last-child { border-bottom: none; }
        .cot-desglose-item .label { color: var(--gray); }
        .cot-desglose-item .value { font-weight: 600; }
        .cot-desglose-item.total {
            background: linear-gradient(135deg, rgba(8,145,178,0.1), rgba(6,182,212,0.1));
            margin: 10px -14px -14px; padding: 12px 14px;
            border-radius: 0 0 14px 14px; border-bottom: none;
        }
        .cot-desglose-item.total .label { font-weight: 700; color: var(--cyan); }
        .cot-desglose-item.total .value { font-size: 16px; color: var(--cyan); }
        .cot-resumen-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .cot-resumen-box {
            background: var(--bg); border-radius: 10px; padding: 12px; text-align: center;
        }
        .cot-resumen-box .label {
            font-size: 9px; color: var(--gray); text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 3px;
        }
        .cot-resumen-box .value { font-size: 14px; font-weight: 700; }
        .cot-resumen-box .value.accent { color: var(--cyan); }
        .cot-reglas-info {
            background: #fef3c7; border-radius: 8px; padding: 8px 12px;
            font-size: 10px; color: #92400e; margin-bottom: 12px;
        }
        .cot-warning {
            background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;
            padding: 8px 12px; font-size: 11px; color: #dc2626; margin-top: 8px; display: none;
        }
        .cot-warning.show { display: block; }
        .cot-btn-pdf {
            width: 100%; padding: 16px;
            background: linear-gradient(135deg, var(--green), #34d399);
            border: none; border-radius: 12px; color: white; font-size: 15px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            gap: 10px; box-shadow: 0 4px 12px rgba(16,185,129,0.3); margin-bottom: 12px;
            font-family: 'Inter', sans-serif;
        }
        .cot-btn-pdf:active { transform: scale(0.98); }
        .cot-btn-pdf svg { width: 20px; height: 20px; }
        .cot-header-bar {
            background: linear-gradient(135deg, var(--cyan), #06b6d4);
            padding: 16px 32px; text-align: center; display: none;
        }
        .cot-header-bar h2 { color: white; font-size: 20px; font-weight: 800; letter-spacing: 2px; }
        .cot-header-bar p { color: rgba(255,255,255,0.9); font-size: 11px; margin-top: 2px; }

        /* ======================== */
        /* CALENDARIO STYLES       */
        /* ======================== */
        .cal-container { padding: 0 0 32px; }
        .cal-toolbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 32px; background: var(--white); border-bottom: 1px solid var(--border);
        }
        .cal-toolbar-left { display: flex; align-items: center; gap: 12px; }
        .cal-toolbar h2 { font-size: 20px; font-weight: 800; }
        .cal-nav-btn {
            width: 34px; height: 34px; border: 1px solid var(--border); border-radius: 8px;
            background: var(--white); cursor: pointer; font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Inter', sans-serif; transition: all 0.2s;
        }
        .cal-nav-btn:hover { background: #f3f4f6; border-color: var(--cyan); }
        .cal-today-btn {
            padding: 6px 16px; border: 1px solid var(--border); border-radius: 8px;
            background: var(--white); cursor: pointer; font-size: 12px; font-weight: 700;
            font-family: 'Inter', sans-serif; transition: all 0.2s;
        }
        .cal-today-btn:hover { background: var(--cyan); color: white; border-color: var(--cyan); }
        .cal-legend {
            display: flex; gap: 14px; align-items: center;
        }
        .cal-legend-item {
            display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 600; color: var(--gray);
        }
        .cal-legend-dot {
            width: 10px; height: 10px; border-radius: 3px;
        }
        .cal-week {
            display: grid; grid-template-columns: 60px repeat(7, 1fr);
            border-bottom: 1px solid var(--border);
        }
        .cal-week-header {
            display: grid; grid-template-columns: 60px repeat(7, 1fr);
            background: var(--white); border-bottom: 1px solid var(--border);
            position: sticky; top: 56px; z-index: 10;
        }
        .cal-day-header {
            padding: 12px 8px; text-align: center;
            font-size: 11px; font-weight: 700; color: var(--gray);
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .cal-day-header .cal-day-num {
            display: flex; align-items: center; justify-content: center;
            width: 32px; height: 32px; border-radius: 50%; margin: 4px auto 0;
            font-size: 16px; font-weight: 800; color: var(--dark);
        }
        .cal-day-header .cal-day-num.today {
            background: var(--cyan); color: white;
        }
        .cal-time-col {
            border-right: 1px solid var(--border); background: #fafafa;
        }
        .cal-time-label {
            height: 60px; display: flex; align-items: flex-start; justify-content: center;
            font-size: 10px; font-weight: 600; color: var(--gray-light);
            padding-top: 0; position: relative; top: -6px;
        }
        .cal-day-col {
            border-right: 1px solid #f3f4f6; position: relative; min-height: 0;
        }
        .cal-day-col:last-child { border-right: none; }
        .cal-hour-slot {
            height: 60px; border-bottom: 1px solid #f5f5f4; position: relative;
            cursor: pointer;
        }
        .cal-hour-slot:hover { background: rgba(8,145,178,0.06); }
        .cal-hour-slot:active { background: rgba(8,145,178,0.12); }
        /* Quick-create popup */
        .cal-popup {
            position: fixed; background: var(--white); border-radius: 14px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.2); z-index: 1100;
            width: 320px; overflow: hidden; display: none;
            animation: calPopIn 0.15s ease-out;
        }
        @keyframes calPopIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .cal-popup.show { display: block; }
        .cal-popup-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 16px; border-bottom: 1px solid var(--border);
        }
        .cal-popup-close {
            width: 28px; height: 28px; border: none; background: #f3f4f6;
            border-radius: 6px; cursor: pointer; font-size: 16px;
            display: flex; align-items: center; justify-content: center;
        }
        .cal-popup-body { padding: 14px 16px; }
        .cal-popup-title-input {
            width: 100%; border: none; outline: none; font-size: 18px;
            font-weight: 700; font-family: 'Inter', sans-serif;
            color: var(--dark); padding: 0; margin-bottom: 14px;
        }
        .cal-popup-title-input::placeholder { color: var(--gray-light); }
        .cal-popup-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 10px;
            font-size: 12px; color: var(--gray);
        }
        .cal-popup-row .icon { font-size: 16px; width: 20px; text-align: center; flex-shrink: 0; }
        .cal-popup-row input, .cal-popup-row select {
            padding: 6px 10px; border: 1.5px solid var(--border); border-radius: 6px;
            font-size: 12px; font-family: 'Inter', sans-serif; font-weight: 600;
            background: var(--white);
        }
        .cal-popup-row input:focus, .cal-popup-row select:focus {
            outline: none; border-color: var(--cyan);
        }
        .cal-popup-types {
            display: flex; gap: 0; border: 1.5px solid var(--border); border-radius: 8px;
            overflow: hidden; margin-bottom: 14px;
        }
        .cal-popup-type {
            flex: 1; padding: 8px; text-align: center; font-size: 11px; font-weight: 700;
            cursor: pointer; background: var(--white); color: var(--gray);
            border: none; font-family: 'Inter', sans-serif; transition: all 0.2s;
            border-right: 1px solid var(--border);
        }
        .cal-popup-type:last-child { border-right: none; }
        .cal-popup-type:hover { background: #f9fafb; }
        .cal-popup-type.active-ev { background: var(--cyan); color: white; }
        .cal-popup-type.active-cita { background: #3b82f6; color: white; }
        .cal-popup-type.active-pend { background: #8b5cf6; color: white; }
        .cal-popup-footer {
            padding: 10px 16px; border-top: 1px solid var(--border);
            display: flex; justify-content: flex-end; gap: 8px;
        }
        .cal-popup-save {
            padding: 8px 20px; background: var(--cyan); color: white;
            border: none; border-radius: 8px; font-size: 12px; font-weight: 700;
            cursor: pointer; font-family: 'Inter', sans-serif;
        }
        .cal-popup-save:hover { background: #0e7490; }
        .cal-popup-cancel {
            padding: 8px 16px; background: #f3f4f6; color: var(--dark);
            border: none; border-radius: 8px; font-size: 12px; font-weight: 700;
            cursor: pointer; font-family: 'Inter', sans-serif;
        }
        /* Current time line */
        .cal-now-line {
            position: absolute; left: 0; right: 0; height: 2px;
            background: #ef4444; z-index: 8; pointer-events: none;
        }
        .cal-now-dot {
            position: absolute; left: -5px; top: -4px;
            width: 10px; height: 10px; border-radius: 50%;
            background: #ef4444;
        }
        .cal-event {
            position: absolute; left: 3px; right: 3px;
            border-radius: 6px; padding: 4px 8px; font-size: 11px; font-weight: 600;
            overflow: hidden; cursor: default; z-index: 5;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .cal-event:hover { transform: scale(1.02); z-index: 10; }
        .cal-event-title {
            font-weight: 700; font-size: 11px; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        .cal-event-time { font-size: 9px; opacity: 0.8; font-weight: 600; }
        .cal-event-cita {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white; border-left: 3px solid #1d4ed8;
        }
        .cal-event-pendiente {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
            color: white; border-left: 3px solid #6d28d9;
        }
        .cal-event-manual {
            background: linear-gradient(135deg, var(--cyan), #22d3ee);
            color: white; border-left: 3px solid #0e7490;
        }
        .cal-grid-scroll {
            max-height: calc(100vh - 200px); overflow-y: auto;
            overflow-x: hidden;
        }
        .cal-gmt {
            padding: 12px 0; text-align: center;
            font-size: 9px; font-weight: 600; color: var(--gray-light);
            border-right: 1px solid var(--border); background: #fafafa;
        }
        .cal-allday {
            padding: 6px 8px; min-height: 32px; border-right: 1px solid #f3f4f6;
            border-bottom: 1px solid var(--border);
        }
        .cal-allday-label {
            padding: 6px 0; text-align: center; font-size: 9px; font-weight: 600;
            color: var(--gray-light); border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border); background: #fafafa;
        }

        /* ======================== */
        /* PROYECTOS STYLES        */
        /* ======================== */
        .proy-container { padding: 20px 32px 32px; }
        .proy-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        .proy-header h2 { font-size: 22px; font-weight: 900; }
        .proy-header p { font-size: 12px; color: var(--gray); margin-top: 2px; }
        .proy-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 16px;
        }
        .proy-card {
            background: var(--white); border-radius: 14px; border: 1px solid var(--border);
            overflow: hidden; transition: box-shadow 0.2s;
        }
        .proy-card:hover { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .proy-card-header {
            padding: 16px 18px 12px; display: flex; justify-content: space-between;
            align-items: flex-start; border-bottom: 1px solid #f3f4f6;
        }
        .proy-card-title { font-size: 15px; font-weight: 800; color: var(--dark); }
        .proy-card-desc {
            font-size: 12px; color: var(--gray); margin-top: 3px;
            max-width: 260px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }
        .proy-card-actions { display: flex; gap: 4px; }
        .proy-card-actions button {
            width: 28px; height: 28px; border: 1px solid var(--border); border-radius: 6px;
            background: var(--white); cursor: pointer; font-size: 12px;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .proy-card-actions button:hover { background: #f3f4f6; }
        .proy-card-actions button.delete:hover { background: #fef2f2; border-color: var(--red); }
        .proy-status-bar {
            display: flex; align-items: center; gap: 8px; padding: 10px 18px;
            background: #fafafa; border-bottom: 1px solid #f3f4f6;
        }
        .proy-priority {
            display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 50px;
            font-size: 10px; font-weight: 700; letter-spacing: 0.03em;
        }
        .proy-p-urgente { background: #fecaca; color: #991b1b; }
        .proy-p-alta { background: #fed7aa; color: #9a3412; }
        .proy-p-media { background: #fef3c7; color: #92400e; }
        .proy-p-baja { background: #d1fae5; color: #065f46; }
        .proy-estado {
            display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 50px;
            font-size: 10px; font-weight: 700;
        }
        .proy-e-activo { background: #dbeafe; color: #1e40af; }
        .proy-e-pausado { background: #f3f4f6; color: #374151; }
        .proy-e-completado { background: #d1fae5; color: #065f46; }
        .proy-e-cancelado { background: #fecaca; color: #991b1b; }
        .proy-resp-tag {
            font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 50px;
        }
        .proy-progress-bar {
            height: 4px; background: #e5e7eb; border-radius: 4px; overflow: hidden;
            margin: 0 18px;
        }
        .proy-progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--cyan), var(--green));
            border-radius: 4px; transition: width 0.4s;
        }
        .proy-pendientes { padding: 12px 18px 16px; }
        .proy-pendientes-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .proy-pendientes-header span {
            font-size: 11px; font-weight: 700; color: var(--gray);
            text-transform: uppercase; letter-spacing: 0.05em;
        }
        .proy-pendientes-header .proy-count {
            font-size: 10px; font-weight: 800; color: var(--cyan);
        }
        .proy-add-pendiente {
            border: none; background: none; color: var(--cyan); font-size: 18px;
            cursor: pointer; font-weight: 700; line-height: 1; padding: 0 4px;
        }
        .proy-pendiente-item {
            display: flex; align-items: flex-start; gap: 8px; padding: 6px 0;
            border-bottom: 1px solid #f9fafb; font-size: 13px;
        }
        .proy-pendiente-item:last-child { border-bottom: none; }
        .proy-check {
            width: 18px; height: 18px; border: 2px solid var(--border); border-radius: 4px;
            cursor: pointer; flex-shrink: 0; margin-top: 1px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; font-size: 10px; color: transparent;
        }
        .proy-check:hover { border-color: var(--cyan); }
        .proy-check.done { background: var(--green); border-color: var(--green); color: white; }
        .proy-pendiente-text { flex: 1; font-weight: 500; color: var(--dark); }
        .proy-pendiente-text.done { text-decoration: line-through; color: var(--gray-light); }
        .proy-pendiente-delete {
            border: none; background: none; color: var(--gray-light); font-size: 14px;
            cursor: pointer; opacity: 0; transition: opacity 0.2s; padding: 0 2px;
        }
        .proy-pendiente-item:hover .proy-pendiente-delete { opacity: 1; }
        .proy-pendiente-delete:hover { color: var(--red); }
        .proy-add-input {
            width: 100%; padding: 8px 10px; border: 1.5px dashed var(--border);
            border-radius: 6px; font-size: 12px; font-family: 'Inter', sans-serif;
            font-weight: 500; margin-top: 6px; background: #fafafa;
        }
        .proy-add-input:focus { outline: none; border-color: var(--cyan); background: white; }
        .proy-empty {
            text-align: center; padding: 60px 20px; color: var(--gray);
        }
        .proy-empty .empty-icon { font-size: 48px; margin-bottom: 12px; }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            nav { padding: 12px 16px; }
            .nav-links { gap: 12px; }
            .nav-links a { font-size: 10px; }
            .crm-header { padding: 20px 16px 16px; flex-direction: column; align-items: flex-start; gap: 12px; }
            .stats-row { padding: 0 16px 16px; }
            .toolbar { padding: 12px 16px; }
            .table-container { padding: 0 16px 16px; }
            .search-box { min-width: 160px; }
            .form-row { grid-template-columns: 1fr; }
            .tabs-bar { padding: 0 16px; overflow-x: auto; }
            .proy-container { padding: 16px; }
            .proy-grid { grid-template-columns: 1fr; }
            .proy-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .cal-toolbar { padding: 12px 16px; flex-direction: column; gap: 10px; }
            .cal-event { font-size: 9px; padding: 2px 4px; }
            .cal-event-time { display: none; }
            .cal-legend { display: none; }
        }
    </style>
</head>
<body>

    <!-- LOADING -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <div style="font-size:14px;font-weight:700;color:var(--dark);">Conectando a la base de datos...</div>
    </div>

    <!-- SYNC BAR -->
    <div class="sync-bar" id="sync-bar"></div>

    <!-- NAV -->
    <nav>
        <a href="index.html" class="logo">FYRADRIVE CRM</a>
        <div class="nav-links">
            <a class="active" id="nav-vendedores" onclick="switchCRMTab('vendedores')">VENDEDORES</a>
            <a id="nav-compradores" onclick="switchCRMTab('compradores')">COMPRADORES</a>
            <a id="nav-cotizador" onclick="switchCRMTab('cotizador')">COTIZADOR</a>
            <a id="nav-proyectos" onclick="switchCRMTab('proyectos')">PROYECTOS</a>
            <a id="nav-calendario" onclick="switchCRMTab('calendario')">CALENDARIO</a>
            <a id="nav-bolamagica" onclick="switchCRMTab('bolamagica')" style="color:var(--purple);"> BOLA MGICA</a>
        </div>
        <div class="user-badge" id="user-badge" onclick="toggleUser()">
            <span id="user-dot" style="width:8px;height:8px;border-radius:50%;background:#10b981;"></span>
            <span id="user-name-display">Sebastian</span>
            <span style="font-size:10px;opacity:0.6;cursor:pointer;">&#9660;</span>
        </div>
    </nav>

    <!-- HEADER -->
    <div class="crm-header">
        <div>
            <h1>CRM FYRADRIVE</h1>
            <p>Seguimiento de clientes vendedores y compradores  <strong>en tiempo real</strong></p>
        </div>
        <div class="header-actions">
            <button class="btn-new" onclick="openModal('vendedor')">+ Nuevo Vendedor</button>
            <button class="btn-new" style="background:var(--green);" onclick="openModal('comprador')">+ Nuevo Comprador</button>
        </div>
    </div>

    <!-- STATS -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-label">Vendedores</div>
            <div class="stat-value" id="stat-vendedores" style="color:var(--cyan);">0</div>
            <div class="stat-sub">Leads activos</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Compradores</div>
            <div class="stat-value" id="stat-compradores" style="color:var(--green);">0</div>
            <div class="stat-sub">En seguimiento</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Citas Agendadas</div>
            <div class="stat-value" id="stat-citas" style="color:var(--blue);">0</div>
            <div class="stat-sub">Pendientes</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Vendidos</div>
            <div class="stat-value" id="stat-vendidos" style="color:var(--purple);">0</div>
            <div class="stat-sub">Este mes</div>
        </div>
    </div>

    <!-- TABS -->
    <div class="tabs-bar">
        <button class="tab-btn active" id="tab-btn-vendedores" onclick="switchCRMTab('vendedores')">
            Vendedores <span class="tab-count" id="count-vendedores">0</span>
        </button>
        <button class="tab-btn" id="tab-btn-compradores" onclick="switchCRMTab('compradores')">
            Compradores <span class="tab-count" id="count-compradores">0</span>
        </button>
        <button class="tab-btn" id="tab-btn-cotizador" onclick="switchCRMTab('cotizador')">
            Cotizador
        </button>
        <button class="tab-btn" id="tab-btn-proyectos" onclick="switchCRMTab('proyectos')">
            Proyectos <span class="tab-count" id="count-proyectos">0</span>
        </button>
        <button class="tab-btn" id="tab-btn-calendario" onclick="switchCRMTab('calendario')">
            Calendario
        </button>
        <button class="tab-btn" id="tab-btn-bolamagica" onclick="switchCRMTab('bolamagica')" style="font-weight:800;">
             Bola Mgica
        </button>
    </div>

    <!-- VENDEDORES TAB -->
    <div id="tab-vendedores">
        <div class="toolbar">
            <div class="toolbar-left">
                <div class="search-box">
                    <span>&#128269;</span>
                    <input type="text" placeholder="Buscar vendedor..." id="search-vendedores" oninput="renderVendedores()">
                </div>
                <button class="filter-btn" onclick="filterResp('vendedores','todos')">Todos</button>
                <button class="filter-btn" onclick="filterResp('vendedores','Sebastian')">Sebastian</button>
                <button class="filter-btn" onclick="filterResp('vendedores','Mario')">Mario</button>
            </div>
            <button class="btn-new" onclick="openModal('vendedor')">+ Agregar</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Telefono</th>
                        <th>Auto</th>
                        <th>Seriedad</th>
                        <th>Estado</th>
                        <th>Responsable</th>
                        <th>Que sigue</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="vendedores-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- COMPRADORES TAB -->
    <div id="tab-compradores" style="display:none;">
        <div class="toolbar">
            <div class="toolbar-left">
                <div class="search-box">
                    <span>&#128269;</span>
                    <input type="text" placeholder="Buscar comprador..." id="search-compradores" oninput="renderCompradores()">
                </div>
                <button class="filter-btn" onclick="filterResp('compradores','todos')">Todos</button>
                <button class="filter-btn" onclick="filterResp('compradores','Sebastian')">Sebastian</button>
                <button class="filter-btn" onclick="filterResp('compradores','Mario')">Mario</button>
            </div>
            <button class="btn-new" style="background:var(--green);" onclick="openModal('comprador')">+ Agregar</button>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Telefono</th>
                        <th>Vehiculo</th>
                        <th>Estado</th>
                        <th>Seguimiento</th>
                        <th>Responsable</th>
                        <th>Notas</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="compradores-tbody"></tbody>
            </table>
        </div>
    </div>

    <!-- ======================== -->
    <!-- CALENDARIO TAB           -->
    <!-- ======================== -->
    <div id="tab-calendario" style="display:none;">
        <div class="cal-container">
            <div class="cal-toolbar">
                <div class="cal-toolbar-left">
                    <button class="cal-today-btn" onclick="calGoToday()">Hoy</button>
                    <button class="cal-nav-btn" onclick="calPrev()">&#8249;</button>
                    <button class="cal-nav-btn" onclick="calNext()">&#8250;</button>
                    <h2 id="cal-month-title">Febrero de 2026</h2>
                </div>
                <div class="cal-legend">
                    <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#3b82f6;"></div> Citas CRM</div>
                    <div class="cal-legend-item"><div class="cal-legend-dot" style="background:#8b5cf6;"></div> Pendientes Proyectos</div>
                    <div class="cal-legend-item"><div class="cal-legend-dot" style="background:var(--cyan);"></div> Eventos Manuales</div>
                </div>
            </div>
            <div id="cal-header" class="cal-week-header"></div>
            <div class="cal-grid-scroll" id="cal-scroll">
                <div id="cal-grid" class="cal-week"></div>
            </div>
        </div>

        <!-- Quick-create popup -->
        <div class="cal-popup" id="cal-popup">
            <div class="cal-popup-header">
                <span style="font-size:16px;">&#9776;</span>
                <button class="cal-popup-close" onclick="calClosePopup()">&times;</button>
            </div>
            <div class="cal-popup-body">
                <input type="text" class="cal-popup-title-input" id="calev-titulo" placeholder="Anade un titulo" autofocus>
                <div class="cal-popup-types">
                    <button class="cal-popup-type active-ev" data-type="evento" onclick="calSetType('evento')">Evento</button>
                    <button class="cal-popup-type" data-type="cita" onclick="calSetType('cita')">Cita</button>
                    <button class="cal-popup-type" data-type="pendiente" onclick="calSetType('pendiente')">Pendiente</button>
                </div>
                <div class="cal-popup-row">
                    <span class="icon">&#128339;</span>
                    <span id="calev-fecha-display" style="font-weight:600;color:var(--dark);"></span>
                </div>
                <div class="cal-popup-row">
                    <span class="icon">&#128339;</span>
                    <input type="time" id="calev-hora-inicio" style="width:110px;">
                    <span>&ndash;</span>
                    <input type="time" id="calev-hora-fin" style="width:110px;">
                </div>
                <div class="cal-popup-row">
                    <span class="icon">&#128100;</span>
                    <select id="calev-responsable">
                        <option value="Sebastian">Sebastian</option>
                        <option value="Mario">Mario</option>
                        <option value="Ambos">Ambos</option>
                    </select>
                </div>
                <div class="cal-popup-row" id="calev-desc-row">
                    <span class="icon">&#128221;</span>
                    <input type="text" id="calev-descripcion" placeholder="Descripcion (opcional)" style="flex:1;">
                </div>
            </div>
            <div class="cal-popup-footer">
                <button class="cal-popup-cancel" onclick="calClosePopup()">Cancelar</button>
                <button class="cal-popup-save" id="calev-save-btn" onclick="calSaveEvent()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- ======================== -->
    <!-- COTIZADOR TAB            -->
    <!-- ======================== -->
    <div id="tab-cotizador" style="display:none;">
        <div class="cot-header-bar" id="cot-pdf-header">
            <h2>FYRADRIVE</h2>
            <p>Cotizador de Financiamiento &bull; Tasa 15.99%</p>
        </div>
        <div class="cot-container" id="cot-content">
            <div class="cot-card">
                <div class="cot-card-title">DATOS DEL VEHICULO</div>
                <div class="cot-reglas-info">
                    &#128203; <b>2021+:</b> Min 25%, Max 60m | <b>2018-20:</b> Min 35%, Max 48m
                </div>
                <div class="cot-input-group cot-no-pdf">
                    <label>Marca y Modelo</label>
                    <input type="text" id="cot-carName" value="Tesla Model Y Performance">
                </div>
                <div class="cot-desglose-item" id="cot-carNameDisplay" style="display:none; padding: 12px 0;">
                    <span class="label">Vehiculo</span>
                    <span class="value" id="cot-carNamePDF">Tesla Model Y Performance</span>
                </div>
                <div class="cot-input-row cot-no-pdf">
                    <div class="cot-input-group">
                        <label>Ano</label>
                        <select id="cot-carYear">
                            <option value="2025">2025</option>
                            <option value="2024">2024</option>
                            <option value="2023" selected>2023</option>
                            <option value="2022">2022</option>
                            <option value="2021">2021</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                            <option value="2018">2018</option>
                        </select>
                    </div>
                    <div class="cot-input-group">
                        <label>Precio ($)</label>
                        <input type="tel" id="cot-carPrice" value="590000" inputmode="numeric">
                    </div>
                </div>
                <div class="cot-enganche-box cot-no-pdf">
                    <div class="cot-enganche-label">&#128179; Enganche  <span id="cot-engancheRule">Minimo 25%</span></div>
                    <div class="cot-input-row">
                        <div class="cot-input-group" style="margin-bottom:0">
                            <label>Monto ($)</label>
                            <input type="tel" id="cot-enganchePesos" inputmode="numeric" value="147500">
                        </div>
                        <div class="cot-input-group" style="margin-bottom:0">
                            <label>Porcentaje (%)</label>
                            <input type="tel" id="cot-enganchePct" inputmode="decimal" value="25">
                        </div>
                    </div>
                    <div class="cot-enganche-display">
                        <span class="pct" id="cot-engancheDisplayPct">25.00%</span>
                        <span class="amount" id="cot-engancheDisplayAmount">$147,500</span>
                    </div>
                    <div class="cot-warning" id="cot-engancheWarning">
                        &#9888;&#65039; El enganche minimo es <b id="cot-minEnganche">25%</b>
                    </div>
                </div>
            </div>

            <div class="cot-card cot-no-pdf">
                <div class="cot-card-title">PLAZO (MESES)</div>
                <div class="cot-plazo-grid">
                    <div class="cot-plazo-btn" data-plazo="12" onclick="cotSetPlazo(12)">12</div>
                    <div class="cot-plazo-btn" data-plazo="24" onclick="cotSetPlazo(24)">24</div>
                    <div class="cot-plazo-btn" data-plazo="36" onclick="cotSetPlazo(36)">36</div>
                    <div class="cot-plazo-btn" data-plazo="48" onclick="cotSetPlazo(48)">48</div>
                    <div class="cot-plazo-btn active" data-plazo="60" onclick="cotSetPlazo(60)">60</div>
                </div>
            </div>

            <div class="cot-resultado">
                <div class="cot-resultado-header">
                    <div class="cot-check">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <span class="cot-resultado-label">Mensualidad</span>
                </div>
                <div class="cot-resultado-monto" id="cot-mensualidad">$0</div>
                <div class="cot-resultado-nota">Pago mensual fijo a <span id="cot-plazoTexto">60</span> meses</div>
            </div>

            <div class="cot-card">
                <div class="cot-resumen-grid">
                    <div class="cot-resumen-box">
                        <div class="label">Precio Vehiculo</div>
                        <div class="value" id="cot-precioDisplay">$590,000</div>
                    </div>
                    <div class="cot-resumen-box">
                        <div class="label">Enganche</div>
                        <div class="value accent" id="cot-engancheResumen">$147,500</div>
                    </div>
                </div>
            </div>

            <div class="cot-card">
                <div class="cot-card-title">DESGLOSE</div>
                <div class="cot-desglose-item">
                    <span class="label">Financiamiento Vehiculo</span>
                    <span class="value" id="cot-financiamiento">$0</span>
                </div>
                <div class="cot-desglose-item">
                    <span class="label">+ Seguro Vida/Desempleo</span>
                    <span class="value">$1,800</span>
                </div>
                <div class="cot-desglose-item">
                    <span class="label">+ IVA 16%</span>
                    <span class="value" id="cot-iva">$0</span>
                </div>
                <div class="cot-desglose-item total">
                    <span class="label">Monto a Financiar</span>
                    <span class="value" id="cot-montoFinanciar">$0</span>
                </div>
            </div>

            <div class="cot-card">
                <div class="cot-resumen-grid">
                    <div class="cot-resumen-box">
                        <div class="label">Comision Apertura</div>
                        <div class="value" id="cot-comision">$0</div>
                    </div>
                    <div class="cot-resumen-box">
                        <div class="label">Desembolso Inicial</div>
                        <div class="value accent" id="cot-desembolso">$0</div>
                    </div>
                </div>
                <div class="cot-resumen-grid" style="margin-top:10px">
                    <div class="cot-resumen-box">
                        <div class="label">Tasa Anual</div>
                        <div class="value">15.99%</div>
                    </div>
                    <div class="cot-resumen-box">
                        <div class="label">Total a Pagar</div>
                        <div class="value" id="cot-totalPagar">$0</div>
                    </div>
                </div>
            </div>

            <button class="cot-btn-pdf cot-no-pdf" onclick="cotDescargarPDF()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 10v6m0 0l-3-3m3 3l3-3"></path>
                    <path d="M3 17v3a2 2 0 002 2h14a2 2 0 002-2v-3"></path>
                </svg>
                Descargar PDF
            </button>

            <div style="text-align:center;padding:12px;font-size:10px;color:var(--gray);">
                CAT 25.6% sin IVA &bull; Cotizacion informativa<br>
                Fyradrive &copy; 2026 | Monterrey, N.L.
            </div>
        </div>
    </div>

    <!-- ======================== -->
    <!-- PROYECTOS TAB            -->
    <!-- ======================== -->
    <div id="tab-proyectos" style="display:none;">
        <div class="proy-container">
            <div class="proy-header">
                <div>
                    <h2>Proyectos FYRADRIVE</h2>
                    <p>Seguimiento de proyectos y pendientes  en tiempo real con Mario</p>
                </div>
                <button class="btn-new" style="background:var(--purple);" onclick="openProyectoModal()">+ Nuevo Proyecto</button>
            </div>
            <div class="proy-grid" id="proy-grid"></div>
        </div>
    </div>

    <!-- ======================== -->
    <!--  BOLA MGICA TAB       -->
    <!-- ======================== -->
    <div id="tab-bolamagica" style="display:none;">
        <div style="max-width:1200px;margin:0 auto;padding:20px 32px;">
            <!-- HEADER -->
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
                <div>
                    <h2 style="font-size:28px;font-weight:900;"> La Bola Mgica</h2>
                    <p style="color:var(--gray);font-size:13px;margin-top:4px;">Cerebro estratgico  Comportamientos, emociones y patrones de tus clientes</p>
                </div>
                <div style="display:flex;gap:10px;">
                    <select id="bm-periodo" onchange="cargarBolaMagica()" style="padding:8px 14px;border-radius:8px;border:1px solid var(--border);font-size:13px;font-weight:600;">
                        <option value="7">ltimos 7 das</option>
                        <option value="14">ltimos 14 das</option>
                        <option value="30">ltimos 30 das</option>
                        <option value="90">ltimos 90 das</option>
                    </select>
                    <button onclick="generarLicuadora()" style="padding:8px 18px;background:var(--purple);color:white;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;">
                         Generar Licuadora Semanal
                    </button>
                </div>
            </div>

            <!-- MTRICAS DURAS -->
            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;" id="bm-metricas">
                <div style="background:white;border-radius:12px;padding:18px;border:1px solid var(--border);">
                    <div style="font-size:11px;color:var(--gray);font-weight:600;text-transform:uppercase;">Conversaciones</div>
                    <div style="font-size:32px;font-weight:900;color:var(--cyan);" id="bm-total-convs">0</div>
                    <div style="font-size:11px;color:var(--gray);">clientes nicos</div>
                </div>
                <div style="background:white;border-radius:12px;padding:18px;border:1px solid var(--border);">
                    <div style="font-size:11px;color:var(--gray);font-weight:600;text-transform:uppercase;">Pidieron Cotizacin</div>
                    <div style="font-size:32px;font-weight:900;color:var(--green);" id="bm-cotizaciones">0</div>
                    <div style="font-size:11px;color:var(--gray);" id="bm-tasa-cot">0% de conversaciones</div>
                </div>
                <div style="background:white;border-radius:12px;padding:18px;border:1px solid var(--border);">
                    <div style="font-size:11px;color:var(--gray);font-weight:600;text-transform:uppercase;">Completaron Cotizacin</div>
                    <div style="font-size:32px;font-weight:900;color:var(--purple);" id="bm-completadas">0</div>
                    <div style="font-size:11px;color:var(--gray);" id="bm-tasa-comp">0% de los que pidieron</div>
                </div>
                <div style="background:white;border-radius:12px;padding:18px;border:1px solid var(--border);">
                    <div style="font-size:11px;color:var(--gray);font-weight:600;text-transform:uppercase;">Seriedad Promedio</div>
                    <div style="font-size:32px;font-weight:900;" id="bm-seriedad">0</div>
                    <div style="font-size:11px;color:var(--gray);">de 10</div>
                </div>
            </div>

            <!-- FILA EMOCIONAL -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:24px;">
                <!-- EMOCIONES -->
                <div style="background:white;border-radius:12px;padding:20px;border:1px solid var(--border);">
                    <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;"> Emociones Dominantes</h3>
                    <div id="bm-emociones" style="font-size:13px;line-height:2;"></div>
                </div>
                <!-- MIEDOS -->
                <div style="background:white;border-radius:12px;padding:20px;border:1px solid var(--border);">
                    <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;"> Miedos que Frenan</h3>
                    <div id="bm-miedos" style="font-size:13px;line-height:2;"></div>
                </div>
                <!-- DESEOS -->
                <div style="background:white;border-radius:12px;padding:20px;border:1px solid var(--border);">
                    <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;"> Deseos Reales</h3>
                    <div id="bm-deseos" style="font-size:13px;line-height:2;"></div>
                </div>
            </div>

            <!-- SEALES + INTENCIONES -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px;">
                <div style="background:white;border-radius:12px;padding:20px;border:1px solid var(--border);">
                    <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;"> Seales Detectadas</h3>
                    <div id="bm-senales" style="font-size:13px;line-height:2;"></div>
                </div>
                <div style="background:white;border-radius:12px;padding:20px;border:1px solid var(--border);">
                    <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;"> Intenciones</h3>
                    <div id="bm-intenciones" style="font-size:13px;line-height:2;"></div>
                </div>
            </div>

            <!-- LTIMOS ANLISIS IA -->
            <div style="background:white;border-radius:12px;padding:20px;border:1px solid var(--border);margin-bottom:24px;">
                <h3 style="font-size:14px;font-weight:800;margin-bottom:16px;"> ltimos Anlisis de la IA</h3>
                <div id="bm-analisis" style="max-height:400px;overflow-y:auto;"></div>
            </div>

            <!-- BARRA DE INTUICIONES -->
            <div style="background:linear-gradient(135deg,#7c3aed11,#ec489911);border-radius:12px;padding:20px;border:2px solid var(--purple);margin-bottom:24px;">
                <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;"> Tu Barra de Intuiciones</h3>
                <p style="font-size:12px;color:var(--gray);margin-bottom:12px;">Escribe lo que percibiste, lo que sentiste en la conversacin, lo que crees que estaba viviendo el cliente. Esto alimenta la Bola Mgica.</p>
                <div style="display:flex;gap:8px;margin-bottom:12px;">
                    <select id="intuicion-tipo" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);font-size:12px;">
                        <option value="general"> General</option>
                        <option value="cliente"> Sobre un cliente</option>
                        <option value="mercado"> Mercado</option>
                        <option value="objecion"> Objecin frecuente</option>
                        <option value="cierre"> Insight de cierre</option>
                        <option value="producto"> Idea de producto</option>
                    </select>
                    <input id="intuicion-telefono" type="text" placeholder="Tel. del cliente (opcional)" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);font-size:12px;width:160px;">
                </div>
                <div style="display:flex;gap:8px;">
                    <textarea id="intuicion-texto" placeholder="Escribe tu intuicin, observacin o feeling..." style="flex:1;padding:12px;border-radius:8px;border:1px solid var(--border);font-size:13px;min-height:60px;resize:vertical;font-family:Inter,sans-serif;"></textarea>
                    <button onclick="guardarIntuicion()" style="padding:12px 20px;background:var(--purple);color:white;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;align-self:flex-end;">
                        Guardar 
                    </button>
                </div>
                <div id="intuiciones-lista" style="margin-top:16px;"></div>
            </div>

            <!-- LICUADORA SEMANAL -->
            <div style="background:white;border-radius:12px;padding:20px;border:1px solid var(--border);">
                <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;"> Licuadora Semanal</h3>
                <p style="font-size:12px;color:var(--gray);margin-bottom:16px;">Reporte generado por la IA mezclando datos reales + tus intuiciones</p>
                <div id="bm-licuadora" style="font-size:14px;line-height:1.8;white-space:pre-wrap;color:#374151;">
                    <em style="color:var(--gray);">Haz clic en " Generar Licuadora Semanal" para generar tu reporte</em>
                </div>
            </div>

            <!-- CHATBOT IA CONFIG -->
            <div style="background:linear-gradient(135deg,#06b6d411,#8b5cf611);border-radius:12px;padding:20px;border:2px solid var(--cyan);margin-bottom:24px;">
                <h3 style="font-size:14px;font-weight:800;margin-bottom:12px;"> Chatbot IA de Ventas</h3>
                <p style="font-size:12px;color:var(--gray);margin-bottom:16px;">La IA responde mensajes de WhatsApp como Seb: emptico, directo, siempre buscando solucin. Aprende de tus mensajes reales.</p>

                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <label style="font-weight:700;font-size:13px;">Estado:</label>
                    <button id="ai-toggle-btn" onclick="toggleAI()" style="padding:6px 16px;border-radius:8px;border:none;font-weight:700;cursor:pointer;font-size:13px;">
                         Cargando...
                    </button>
                </div>

                <div>
                    <label style="font-weight:700;font-size:13px;display:block;margin-bottom:6px;">
                         Documento de Ventas de Sebastian
                    </label>
                    <p style="font-size:11px;color:var(--gray);margin-bottom:8px;">
                        Escribe tus tcnicas de venta, frases que funcionan, cmo manejas objeciones, tu filosofa. La IA usa esto como referencia para responder como t.
                    </p>
                    <div id="ai-drop-zone" style="position:relative;border:2px dashed var(--border);border-radius:8px;transition:all 0.2s;">
                        <textarea id="ai-sales-doc" rows="8" style="width:100%;padding:12px;border:none;border-radius:8px;font-size:13px;font-family:inherit;resize:vertical;box-sizing:border-box;background:transparent;" placeholder="Ejemplo: Siempre empiezo preguntando qu tipo de auto buscan y para qu lo necesitan. Cuando dicen que es muy caro, les pregunto cunto traen de enganche y les muestro que con facilidades queda accesible..."></textarea>
                        <div id="ai-drop-overlay" style="display:none;position:absolute;inset:0;background:rgba(8,145,178,0.1);border-radius:8px;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;">
                            <div style="font-size:28px;"></div>
                            <div style="font-size:13px;font-weight:700;color:var(--cyan);margin-top:4px;">Suelta el archivo aqu</div>
                        </div>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap;">
                        <button onclick="guardarAIConfig()" style="padding:8px 18px;background:var(--cyan);color:white;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;">
                             Guardar Documento
                        </button>
                        <label style="padding:8px 18px;background:#f0f9ff;color:#0369a1;border:1px dashed #0369a1;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:4px;">
                             Subir Archivo
                            <input type="file" id="ai-file-upload" accept=".txt,.pdf,.doc,.docx,.csv,.md" style="display:none;" onchange="cargarArchivoAI(this)">
                        </label>
                        <span id="ai-config-status" style="font-size:12px;color:var(--gray);"></span>
                    </div>
                    <p style="font-size:10px;color:var(--gray-light);margin-top:4px;">Arrastra archivos aqu o usa el botn. Acepta: TXT, PDF, CSV, MD.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL PROYECTO -->
    <div class="modal-overlay" id="modal-proyecto">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-proyecto-title">Nuevo Proyecto</h2>
                <button class="modal-close" onclick="closeProyectoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="p-edit-id">
                <div class="form-row full">
                    <div class="form-group">
                        <label>Nombre del Proyecto</label>
                        <input type="text" id="p-nombre" placeholder="Ej: Integrar ManyChat al CRM">
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>Descripcion</label>
                        <textarea id="p-descripcion" placeholder="Descripcion breve del proyecto..."></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Prioridad</label>
                        <select id="p-prioridad">
                            <option value="Urgente">Urgente</option>
                            <option value="Alta">Alta</option>
                            <option value="Media" selected>Media</option>
                            <option value="Baja">Baja</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="p-estado">
                            <option value="Activo" selected>Activo</option>
                            <option value="Pausado">Pausado</option>
                            <option value="Completado">Completado</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Responsable</label>
                        <select id="p-responsable">
                            <option value="Sebastian">Sebastian</option>
                            <option value="Mario">Mario</option>
                            <option value="Ambos">Ambos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha Limite (opcional)</label>
                        <input type="date" id="p-fecha">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeProyectoModal()">Cancelar</button>
                <button class="btn-save" style="background:var(--purple);" onclick="saveProyecto()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL VENDEDOR -->
    <div class="modal-overlay" id="modal-vendedor">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-vendedor-title">Nuevo Vendedor</h2>
                <button class="modal-close" onclick="closeModal('vendedor')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="v-edit-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre completo</label>
                        <input type="text" id="v-nombre" placeholder="Ej: Juan Perez">
                    </div>
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="tel" id="v-telefono" placeholder="Ej: 8112345678">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Auto (Modelo y Ano)</label>
                        <input type="text" id="v-auto" placeholder="Ej: BMW X5 2022">
                    </div>
                    <div class="form-group">
                        <label>Seriedad</label>
                        <select id="v-seriedad">
                            <option value="Alta">Alta</option>
                            <option value="Media">Media</option>
                            <option value="Baja">Baja</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Estado del Vehiculo</label>
                        <select id="v-estado">
                            <option value="Carece Informacion">Carece Informacion</option>
                            <option value="Publicar Fyra">Publicar en FYRA</option>
                            <option value="Publicado">Publicado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Responsable</label>
                        <select id="v-responsable">
                            <option value="Sebastian">Sebastian</option>
                            <option value="Mario">Mario</option>
                        </select>
                    </div>
                </div>
                <div class="form-row full">
                    <div class="form-group">
                        <label>Que sigue / Notas</label>
                        <textarea id="v-notas" placeholder="Descripcion breve de que sigue..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('vendedor')">Cancelar</button>
                <button class="btn-save" onclick="saveVendedor()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL COMPRADOR -->
    <div class="modal-overlay" id="modal-comprador">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-comprador-title">Nuevo Comprador</h2>
                <button class="modal-close" onclick="closeModal('comprador')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="c-edit-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nombre completo</label>
                        <input type="text" id="c-nombre" placeholder="Ej: Maria Lopez">
                    </div>
                    <div class="form-group">
                        <label>Telefono</label>
                        <input type="tel" id="c-telefono" placeholder="Ej: 8112345678">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Vehiculo de Interes</label>
                        <input type="text" id="c-vehiculo" placeholder="Ej: Mercedes GLE 2020">
                    </div>
                    <div class="form-group">
                        <label>Responsable</label>
                        <select id="c-responsable">
                            <option value="Sebastian">Sebastian</option>
                            <option value="Mario">Mario</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Estado</label>
                        <select id="c-estado" onchange="toggleCitaFields()">
                            <option value="Pre-Agendacion">Pre-Agendacion</option>
                            <option value="Cita Confirmada">Cita Confirmada</option>
                            <option value="En Camino">En Camino</option>
                            <option value="Llego al Lugar">Llego al Lugar</option>
                            <option value="En Cita">En Cita</option>
                            <option value="Post-Cita">Post-Cita</option>
                            <option value="Tramite Bancario">Tramite Bancario</option>
                            <option value="Separado">Separado</option>
                            <option value="Vendido">Vendido</option>
                            <option value="Venta Fallida">Venta Fallida</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Resultado Cita</label>
                        <select id="c-postcita">
                            <option value=""> Sin resultado </option>
                            <option value="Lo va a pensar">Lo va a pensar</option>
                            <option value="Quiere credito">Quiere credito</option>
                            <option value="Quiere separar">Quiere separar</option>
                            <option value="Negociacion">Negociacion</option>
                            <option value="No interesado">No interesado</option>
                        </select>
                    </div>
                </div>

                <!-- CITA FIELDS (conditional) -->
                <div class="cita-fields" id="cita-fields">
                    <h4>Datos de la Cita</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Fecha de Cita</label>
                            <input type="date" id="c-cita-fecha">
                        </div>
                        <div class="form-group">
                            <label>Hora de Cita</label>
                            <input type="time" id="c-cita-hora">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Tel. Dueno del Vehiculo</label>
                            <input type="tel" id="c-tel-dueno" placeholder="Telefono del vendedor">
                        </div>
                        <div class="form-group">
                            <label>Tel. Quien ve el Vehiculo</label>
                            <input type="tel" id="c-tel-comprador" placeholder="Telefono del comprador">
                        </div>
                    </div>
                    <div class="form-row full">
                        <div class="form-group">
                            <label>Tel. Responsable</label>
                            <input type="tel" id="c-tel-responsable" placeholder="Tu telefono para notificaciones">
                        </div>
                    </div>
                </div>

                <div class="form-row full" style="margin-top:14px;">
                    <div class="form-group">
                        <label>Notas</label>
                        <textarea id="c-notas" placeholder="Notas sobre el cliente..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('comprador')">Cancelar</button>
                <button class="btn-save" style="background:var(--green);" onclick="saveComprador()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- CRM ALERT (top banner notification) -->
    <div class="seg-crm-alert" id="seg-crm-alert" onclick="handleCRMAlert()">
        <span>&#128680;</span>
        <span id="seg-crm-alert-text">Toca darle seguimiento a un comprador</span>
        <span style="font-size:10px; opacity:0.8; margin-left:8px;">Click para abrir</span>
    </div>

    <!-- PANEL DE SEGUIMIENTO (slide-in lateral) -->
    <div class="seg-panel-overlay" id="seg-overlay" onclick="closeSeguimiento()"></div>
    <div class="seg-panel" id="seg-panel">
        <div class="seg-panel-header">
            <h3 id="seg-title">Seguimiento</h3>
            <button class="seg-close" onclick="closeSeguimiento()">&times;</button>
        </div>
        <!-- State flow visual -->
        <div class="seg-section">
            <div class="seg-section-title">Flujo de Compra</div>
            <div class="seg-state-flow" id="seg-flow"></div>
        </div>
        <!-- CRONOMETRO en tiempo real -->
        <div class="seg-section">
            <div class="seg-crono" id="seg-crono">
                <div class="seg-crono-time" id="seg-crono-time">00:00:00:00</div>
                <div class="seg-crono-sub" id="seg-crono-sub"></div>
                <div class="seg-crono-label" id="seg-crono-label">tiempo en este estado</div>
                <div class="seg-crono-progress"><div class="seg-crono-progress-fill" id="seg-crono-fill"></div></div>
            </div>
        </div>
        <!-- ALERTA: toca mandar mensaje -->
        <div class="seg-section" id="seg-alerta-section" style="display:none;">
            <div class="seg-alerta" id="seg-alerta">
                <div class="seg-alerta-title">&#128680; <span id="seg-alerta-title-text">Toca mandar mensaje</span></div>
                <div class="seg-alerta-desc" id="seg-alerta-desc">Lleva tiempo sin seguimiento, no dejes que se enfrie</div>
            </div>
        </div>
        <!-- Token de seguridad -->
        <div class="seg-section" id="seg-token-section" style="display:none;">
            <div class="seg-section-title">Token de Seguridad</div>
            <div class="seg-token-box">
                <div class="seg-token-label">Codigo de verificacion</div>
                <div class="seg-token-code" id="seg-token-code">0000</div>
                <div class="seg-token-label">Comprador y vendedor deben coincidir</div>
            </div>
        </div>
        <!-- Boton de panico -->
        <div class="seg-section" id="seg-panico-section" style="display:none;">
            <button class="seg-btn-panico" onclick="activarPanico()">&#128680; BOTON DE PANICO &#128680;</button>
            <div style="font-size:10px; color:var(--gray); text-align:center; margin-top:6px;">Envia alerta inmediata por WhatsApp</div>
        </div>
        <!-- Live location -->
        <div class="seg-section" id="seg-liveloc-section" style="display:none;">
            <div class="seg-section-title">Ubicacion en Vivo</div>
            <button class="seg-btn-wa" style="width:100%;" onclick="compartirUbicacion()">&#128205; Compartir ubicacion por WhatsApp</button>
        </div>
        <!-- Post-cita resultado -->
        <div class="seg-section" id="seg-postcita-section" style="display:none;">
            <div class="seg-section-title">En que quedaron?</div>
            <div class="seg-postcita-btns" id="seg-postcita-btns"></div>
        </div>
        <!-- MENSAJE SUGERIDO (el CRM te dice que mandar) -->
        <div class="seg-section" id="seg-mensaje-section">
            <div class="seg-section-title" id="seg-msg-label">Mensaje Sugerido</div>
            <div class="seg-opciones" id="seg-opciones"></div>
            <div class="seg-mensaje-box">
                <div class="seg-mensaje-label">Editable  modifica antes de enviar</div>
                <textarea class="seg-mensaje-textarea" id="seg-mensaje-textarea"></textarea>
            </div>
            <div class="seg-mensaje-actions">
                <button class="seg-btn-wa" onclick="enviarWhatsAppAPI()" id="seg-btn-wa-api" title="Envia directo desde FYRADRIVE sin abrir WhatsApp">&#128640; Enviar Directo</button>
                <button class="seg-btn-wa" onclick="enviarWhatsApp()" style="background:#25d366;" title="Abre WhatsApp con el mensaje listo">&#128172; Abrir WhatsApp</button>
                <button class="seg-btn-alt" onclick="copiarMensaje()">&#128203; Copiar</button>
                <button class="seg-btn-alt" onclick="regenerarMensaje()">&#128260; Otra opcion</button>
            </div>
            <div id="seg-wa-status" style="display:none;padding:6px 10px;margin-top:6px;border-radius:8px;font-size:12px;text-align:center;"></div>
        </div>
        <!-- Avanzar estado -->
        <div class="seg-section">
            <button class="seg-btn-advance" id="seg-btn-avanzar" onclick="avanzarEstado()">Avanzar al siguiente estado &#10132;</button>
        </div>
        <!-- MINI CHAT WhatsApp -->
        <div class="seg-section">
            <div class="seg-section-title" id="seg-chat-title"> Chat</div>
            <div id="seg-chat-container" style="background:#e5ddd5;border-radius:10px;padding:10px;max-height:350px;overflow-y:auto;margin-bottom:8px;">
                <div id="seg-chat-messages" style="display:flex;flex-direction:column;gap:6px;">
                    <div style="text-align:center;color:#888;font-size:12px;padding:20px;">Cargando chat...</div>
                </div>
            </div>
            <div style="display:flex;gap:6px;">
                <input type="text" id="seg-chat-input" placeholder="Escribe un mensaje..." style="flex:1;padding:8px 12px;border-radius:20px;border:1px solid #ccc;font-size:13px;" onkeydown="if(event.key==='Enter')enviarChatDirecto()">
                <button onclick="enviarChatDirecto()" style="background:#25d366;color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:16px;cursor:pointer;" title="Enviar">&#10148;</button>
            </div>
            <div style="text-align:center;margin-top:4px;">
                <button onclick="cargarChat()" style="background:none;border:none;color:#128c7e;font-size:11px;cursor:pointer;">&#128260; Actualizar chat</button>
            </div>
        </div>
        <!-- Historial -->
        <div class="seg-section">
            <div class="seg-section-title">Historial de Mensajes</div>
            <div id="seg-historial"></div>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div class="notification" id="notification">
        <span id="notif-icon">&#9989;</span>
        <span id="notif-text"></span>
    </div>

    <!-- SYNC BADGE -->
    <div class="sync-badge online" id="sync-badge">
        <div class="sync-dot"></div>
        <span id="sync-text">En vivo</span>
    </div>

    <!-- FOOTER -->
    <footer>
        <p>&copy; 2026 FYRADRIVE CRM &mdash; Sebastian &amp; Mario | Base de datos en tiempo real</p>
    </footer>

    <script>
        // ==========================================
        // CLOUD DATABASE API
        // ==========================================
        const API_URL = '/api/db';
        let vendedores = [];
        let compradores = [];
        let proyectos = [];
        let eventos = [];
        let currentUser = localStorage.getItem('fyra_crm_user') || 'Sebastian';
        let activeFilter = { vendedores: 'todos', compradores: 'todos' };
        let isConnected = false;
        let pollInterval = null;
        let lastDataHash = '';

        // ==========================================
        // SYNC - Load data from cloud
        // ==========================================
        async function loadFromCloud() {
            try {
                const resp = await fetch(API_URL);
                const data = await resp.json();

                const cloudV = data.vendedores || [];
                const cloudC = data.compradores || [];
                const cloudP = data.proyectos || [];
                const cloudE = data.eventos || [];

                // Protection: if cloud returns empty but localStorage has data, restore from backup
                const localV = JSON.parse(localStorage.getItem('fyra_crm_vendedores') || '[]');
                const localC = JSON.parse(localStorage.getItem('fyra_crm_compradores') || '[]');
                const localP = JSON.parse(localStorage.getItem('fyra_crm_proyectos') || '[]');
                const localE = JSON.parse(localStorage.getItem('fyra_crm_eventos') || '[]');

                const cloudTotal = cloudV.length + cloudC.length + cloudP.length + cloudE.length;
                const localTotal = localV.length + localC.length + localP.length + localE.length;

                if (cloudTotal === 0 && localTotal > 0) {
                    // Cloud lost data! Restore from localStorage backup
                    console.warn('Cloud data empty but localStorage has data - restoring backup!');
                    vendedores = localV;
                    compradores = localC;
                    proyectos = localP;
                    eventos = localE;
                    // Push backup to cloud
                    await fetch(API_URL, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ vendedores, compradores, proyectos, eventos })
                    });
                    showNotif('Datos restaurados desde respaldo local');
                } else {
                    vendedores = cloudV;
                    compradores = cloudC;
                    proyectos = cloudP;
                    eventos = cloudE;
                    // Save cloud data to localStorage as backup
                    if (cloudTotal > 0) {
                        localStorage.setItem('fyra_crm_vendedores', JSON.stringify(vendedores));
                        localStorage.setItem('fyra_crm_compradores', JSON.stringify(compradores));
                        localStorage.setItem('fyra_crm_proyectos', JSON.stringify(proyectos));
                        localStorage.setItem('fyra_crm_eventos', JSON.stringify(eventos));
                    }
                }

                const newHash = JSON.stringify({ vendedores, compradores, proyectos, eventos });
                if (newHash !== lastDataHash) {
                    lastDataHash = newHash;
                    renderVendedores();
                    renderCompradores();
                    renderProyectos();
                    renderCalendar();
                    updateStats();
                    flashSync();
                }

                if (!isConnected) {
                    isConnected = true;
                    updateSyncBadge();
                }

                document.getElementById('loading').classList.add('hidden');
            } catch (err) {
                console.error('Error loading:', err);
                isConnected = false;
                updateSyncBadge();
                // Fallback to localStorage
                vendedores = JSON.parse(localStorage.getItem('fyra_crm_vendedores') || '[]');
                compradores = JSON.parse(localStorage.getItem('fyra_crm_compradores') || '[]');
                proyectos = JSON.parse(localStorage.getItem('fyra_crm_proyectos') || '[]');
                eventos = JSON.parse(localStorage.getItem('fyra_crm_eventos') || '[]');
                renderVendedores();
                renderCompradores();
                renderProyectos();
                renderCalendar();
                updateStats();
                document.getElementById('loading').classList.add('hidden');
            }
        }

        async function saveToCloud() {
            const data = { vendedores, compradores, proyectos, eventos };
            lastDataHash = JSON.stringify(data);

            // Also save to localStorage as backup
            localStorage.setItem('fyra_crm_vendedores', JSON.stringify(vendedores));
            localStorage.setItem('fyra_crm_compradores', JSON.stringify(compradores));
            localStorage.setItem('fyra_crm_proyectos', JSON.stringify(proyectos));
            localStorage.setItem('fyra_crm_eventos', JSON.stringify(eventos));

            try {
                await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                flashSync();
            } catch (err) {
                console.error('Error saving:', err);
                showNotif('Error guardando en la nube', true);
            }
        }

        function startPolling() {
            loadFromCloud();
            pollInterval = setInterval(loadFromCloud, 3000); // Check every 3 seconds
        }

        function updateSyncBadge() {
            const badge = document.getElementById('sync-badge');
            const text = document.getElementById('sync-text');
            if (isConnected) {
                badge.className = 'sync-badge online';
                text.textContent = 'En vivo';
            } else {
                badge.className = 'sync-badge offline';
                text.textContent = 'Sin conexion';
            }
        }

        function flashSync() {
            const bar = document.getElementById('sync-bar');
            bar.classList.add('active');
            setTimeout(() => bar.classList.remove('active'), 500);
        }

        // ==========================================
        // USER TOGGLE
        // ==========================================
        function toggleUser() {
            currentUser = currentUser === 'Sebastian' ? 'Mario' : 'Sebastian';
            localStorage.setItem('fyra_crm_user', currentUser);
            document.getElementById('user-name-display').textContent = currentUser;
            showNotif('Cambiaste a ' + currentUser);
        }

        // ==========================================
        // TABS
        // ==========================================
        function switchCRMTab(tab) {
            var tabs = ['vendedores','compradores','cotizador','proyectos','calendario','bolamagica'];
            tabs.forEach(function(t) {
                var btn = document.getElementById('tab-btn-' + t);
                var nav = document.getElementById('nav-' + t);
                var panel = document.getElementById('tab-' + t);
                if (btn) btn.classList.toggle('active', tab === t);
                if (nav) nav.classList.toggle('active', tab === t);
                if (panel) panel.style.display = tab === t ? 'block' : 'none';
            });

            // Show/hide CRM-only sections
            var isCRM = tab === 'vendedores' || tab === 'compradores';
            document.querySelector('.crm-header').style.display = isCRM ? 'flex' : 'none';
            document.querySelector('.stats-row').style.display = isCRM ? 'flex' : 'none';

            if (tab === 'proyectos') renderProyectos();
            if (tab === 'calendario') renderCalendar();
            if (tab === 'bolamagica') startBMPolling(); else stopBMPolling();
        }

        // ==========================================
        // FILTERS
        // ==========================================
        function filterResp(tab, resp) {
            activeFilter[tab] = resp;
            const toolbar = document.getElementById('tab-' + tab);
            toolbar.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.toggle('active-filter', b.textContent.trim() === resp || (resp === 'todos' && b.textContent.trim() === 'Todos'));
            });
            if (tab === 'vendedores') renderVendedores();
            else renderCompradores();
        }

        // ==========================================
        // MODAL
        // ==========================================
        function openModal(type, id) {
            const modal = document.getElementById('modal-' + type);
            modal.classList.add('show');

            if (type === 'vendedor') {
                if (id) {
                    const v = vendedores.find(x => x.id === id);
                    document.getElementById('modal-vendedor-title').textContent = 'Editar Vendedor';
                    document.getElementById('v-edit-id').value = id;
                    document.getElementById('v-nombre').value = v.nombre;
                    document.getElementById('v-telefono').value = v.telefono;
                    document.getElementById('v-auto').value = v.auto;
                    document.getElementById('v-seriedad').value = v.seriedad;
                    document.getElementById('v-estado').value = v.estado;
                    document.getElementById('v-responsable').value = v.responsable;
                    document.getElementById('v-notas').value = v.notas;
                } else {
                    document.getElementById('modal-vendedor-title').textContent = 'Nuevo Vendedor';
                    document.getElementById('v-edit-id').value = '';
                    document.querySelectorAll('#modal-vendedor input, #modal-vendedor textarea').forEach(i => { if(i.type !== 'hidden') i.value = ''; });
                    document.getElementById('v-seriedad').value = 'Alta';
                    document.getElementById('v-estado').value = 'Carece Informacion';
                    document.getElementById('v-responsable').value = currentUser;
                }
            } else {
                if (id) {
                    const c = compradores.find(x => x.id === id);
                    document.getElementById('modal-comprador-title').textContent = 'Editar Comprador';
                    document.getElementById('c-edit-id').value = id;
                    document.getElementById('c-nombre').value = c.nombre;
                    document.getElementById('c-telefono').value = c.telefono;
                    document.getElementById('c-vehiculo').value = c.vehiculo;
                    document.getElementById('c-responsable').value = c.responsable;
                    document.getElementById('c-estado').value = c.estado;
                    document.getElementById('c-notas').value = c.notas || '';
                    document.getElementById('c-cita-fecha').value = c.citaFecha || '';
                    document.getElementById('c-cita-hora').value = c.citaHora || '';
                    document.getElementById('c-tel-dueno').value = c.telDueno || '';
                    document.getElementById('c-tel-comprador').value = c.telComprador || '';
                    document.getElementById('c-tel-responsable').value = c.telResponsable || '';
                    document.getElementById('c-postcita').value = c.postcita || '';
                    toggleCitaFields();
                } else {
                    document.getElementById('modal-comprador-title').textContent = 'Nuevo Comprador';
                    document.getElementById('c-edit-id').value = '';
                    document.querySelectorAll('#modal-comprador input, #modal-comprador textarea, #modal-comprador select').forEach(i => { if(i.type !== 'hidden') i.value = ''; });
                    document.getElementById('c-estado').value = 'Pre-Agendacion';
                    document.getElementById('c-postcita').value = '';
                    document.getElementById('c-responsable').value = currentUser;
                    toggleCitaFields();
                }
            }
        }

        function closeModal(type) {
            document.getElementById('modal-' + type).classList.remove('show');
        }

        function toggleCitaFields() {
            const estado = document.getElementById('c-estado').value;
            const needsCita = ['Cita Confirmada','En Camino','Llego al Lugar','En Cita','Post-Cita'].includes(estado);
            document.getElementById('cita-fields').classList.toggle('show', needsCita);
        }

        // ==========================================
        // SAVE VENDEDOR (Firebase)
        // ==========================================
        function saveVendedor() {
            const nombre = document.getElementById('v-nombre').value.trim();
            const telefono = document.getElementById('v-telefono').value.trim();
            const auto = document.getElementById('v-auto').value.trim();
            const seriedad = document.getElementById('v-seriedad').value;
            const estado = document.getElementById('v-estado').value;
            const responsable = document.getElementById('v-responsable').value;
            const notas = document.getElementById('v-notas').value.trim();
            const editId = document.getElementById('v-edit-id').value;

            if (!nombre || !auto) {
                showNotif('Completa nombre y auto', true);
                return;
            }

            const data = { nombre, telefono, auto, seriedad, estado, responsable, notas, updated: Date.now() };

            if (editId) {
                const idx = vendedores.findIndex(x => x.id === editId);
                if (idx >= 0) {
                    data.id = editId;
                    data.created = vendedores[idx].created;
                    vendedores[idx] = data;
                }
                showNotif('Vendedor actualizado');
            } else {
                data.id = 'V' + Date.now();
                data.created = Date.now();
                vendedores.push(data);
                showNotif('Vendedor agregado');
            }

            saveToCloud();
            renderVendedores();
            updateStats();
            closeModal('vendedor');
        }

        // ==========================================
        // SAVE COMPRADOR (Firebase)
        // ==========================================
        function saveComprador() {
            const nombre = document.getElementById('c-nombre').value.trim();
            const telefono = document.getElementById('c-telefono').value.trim();
            const vehiculo = document.getElementById('c-vehiculo').value.trim();
            const responsable = document.getElementById('c-responsable').value;
            const estado = document.getElementById('c-estado').value;
            const notas = document.getElementById('c-notas').value.trim();
            const citaFecha = document.getElementById('c-cita-fecha').value;
            const citaHora = document.getElementById('c-cita-hora').value;
            const telDueno = document.getElementById('c-tel-dueno').value.trim();
            const telComprador = document.getElementById('c-tel-comprador').value.trim();
            const telResponsable = document.getElementById('c-tel-responsable').value.trim();
            const postcita = document.getElementById('c-postcita').value;
            const editId = document.getElementById('c-edit-id').value;

            if (!nombre || !vehiculo) {
                showNotif('Completa nombre y vehiculo', true);
                return;
            }

            const data = {
                nombre, telefono, vehiculo, responsable, estado, notas,
                citaFecha, citaHora, telDueno, telComprador, telResponsable,
                postcita: postcita || '',
                updated: Date.now()
            };

            if (editId) {
                const idx = compradores.findIndex(x => x.id === editId);
                if (idx >= 0) {
                    const old = compradores[idx];
                    data.id = editId;
                    data.created = old.created;
                    data.mensajesEnviados = old.mensajesEnviados || [];
                    data.tokenSeguridad = old.tokenSeguridad || '';
                    // Track state change
                    if (old.estado !== estado) {
                        data.estadoCambio = Date.now();
                        // Generate token when entering En Camino
                        if (estado === 'En Camino' && !data.tokenSeguridad) {
                            data.tokenSeguridad = String(Math.floor(1000 + Math.random() * 9000));
                        }
                    } else {
                        data.estadoCambio = old.estadoCambio || Date.now();
                    }
                    compradores[idx] = data;
                }
                showNotif('Comprador actualizado');
            } else {
                data.id = 'C' + Date.now();
                data.created = Date.now();
                data.estadoCambio = Date.now();
                data.mensajesEnviados = [];
                data.tokenSeguridad = '';
                compradores.push(data);
                showNotif('Comprador agregado');
            }

            saveToCloud();
            renderCompradores();
            updateStats();
            closeModal('comprador');
        }


        // ==========================================
        // DELETE (Firebase)
        // ==========================================
        // ==========================================
        // WHATSAPP NUMBER FORMATTER
        // Handles ANY format: 8112345678, 528112345678, +528112345678,
        // 81-1234-5678, +52 1 81 1234 5678, etc.
        // Returns clean number for wa.me link
        // ==========================================
        function formatWA(tel) {
            if (!tel) return '';
            // Remove everything except digits
            var clean = tel.replace(/\D/g, '');
            // If starts with '+' it was international format, already handled by removing +

            // If 10 digits (local MX: 8112345678) -> add 52
            if (clean.length === 10) return '52' + clean;
            // If 12 digits starting with 52 (528112345678) -> use as is
            if (clean.length === 12 && clean.startsWith('52')) return clean;
            // If 13 digits starting with 521 (5218112345678) -> use as is
            if (clean.length === 13 && clean.startsWith('521')) return clean;
            // If 11 digits starting with 1 (18112345678, old MX mobile format) -> add 52
            if (clean.length === 11 && clean.startsWith('1')) return '52' + clean;
            // If already looks international (starts with country code), use as is
            if (clean.length >= 11) return clean;
            // Fallback: assume MX, add 52
            return '52' + clean;
        }

        function waLink(tel, text) {
            // Messenger contacts no tienen link de wa.me
            if (tel && tel.startsWith('fb_')) return '#';
            var num = formatWA(tel);
            if (!num) return '#';
            var url = 'https://wa.me/' + num;
            if (text) url += '?text=' + encodeURIComponent(text);
            return url;
        }

        function deleteVendedor(id) {
            if (!confirm('Eliminar este vendedor?')) return;
            vendedores = vendedores.filter(x => x.id !== id);
            saveToCloud();
            renderVendedores();
            updateStats();
            showNotif('Vendedor eliminado');
        }

        function deleteComprador(id) {
            if (!confirm('Eliminar este comprador?')) return;
            compradores = compradores.filter(x => x.id !== id);
            saveToCloud();
            renderCompradores();
            updateStats();
            showNotif('Comprador eliminado');
        }

        // ==========================================
        // RENDER VENDEDORES
        // ==========================================
        function renderVendedores() {
            const tbody = document.getElementById('vendedores-tbody');
            const searchEl = document.getElementById('search-vendedores');
            const search = searchEl ? searchEl.value.toLowerCase() : '';
            const filter = activeFilter.vendedores;

            let data = vendedores.filter(v => {
                const matchSearch = v.nombre.toLowerCase().includes(search) || v.auto.toLowerCase().includes(search);
                const matchFilter = filter === 'todos' || v.responsable === filter;
                return matchSearch && matchFilter;
            });

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">&#128203;</div><p>No hay vendedores. Agrega uno nuevo.</p></div></td></tr>';
                document.getElementById('count-vendedores').textContent = vendedores.length;
                return;
            }

            tbody.innerHTML = data.map(v => '<tr>' +
                '<td><div class="client-name"><div class="client-avatar" style="background:' + avatarColor(v.nombre) + '">' + initials(v.nombre) + '</div>' + v.nombre + '</div></td>' +
                '<td><div class="client-phone">' + (v.telefono || '-') + (v.telefono ? (v.telefono.startsWith('fb_') ? ' <span title="Messenger" style="cursor:default;"></span>' : ' <a href="' + waLink(v.telefono) + '" target="_blank" title="WhatsApp"></a>') : '') + '</div></td>' +
                '<td style="font-weight:600;">' + v.auto + '</td>' +
                '<td><span class="badge badge-' + v.seriedad.toLowerCase() + '">' + v.seriedad + '</span></td>' +
                '<td><span class="badge badge-' + estadoVClass(v.estado) + '">' + v.estado + '</span></td>' +
                '<td><span class="responsable-tag resp-' + v.responsable.toLowerCase() + '">' + (v.responsable === 'Sebastian' ? '&#128156;' : '&#128153;') + ' ' + v.responsable + '</span></td>' +
                '<td><div class="description-cell" title="' + (v.notas || '') + '">' + (v.notas || '-') + '</div></td>' +
                '<td><div class="actions-cell"><button class="btn-icon" onclick="openModal(\'vendedor\',\'' + v.id + '\')" title="Editar">&#9998;</button><button class="btn-icon delete" onclick="deleteVendedor(\'' + v.id + '\')" title="Eliminar">&#128465;</button></div></td>' +
                '</tr>').join('');

            document.getElementById('count-vendedores').textContent = vendedores.length;
        }

        // ==========================================
        // RENDER COMPRADORES
        // ==========================================
        function renderCompradores() {
            const tbody = document.getElementById('compradores-tbody');
            const searchEl = document.getElementById('search-compradores');
            const search = searchEl ? searchEl.value.toLowerCase() : '';
            const filter = activeFilter.compradores;

            let data = compradores.filter(c => {
                const matchSearch = c.nombre.toLowerCase().includes(search) || c.vehiculo.toLowerCase().includes(search);
                const matchFilter = filter === 'todos' || c.responsable === filter;
                return matchSearch && matchFilter;
            });

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><div class="empty-icon">&#128100;</div><p>No hay compradores. Agrega uno nuevo.</p></div></td></tr>';
                document.getElementById('count-compradores').textContent = compradores.length;
                return;
            }

            tbody.innerHTML = data.map(c => '<tr>' +
                '<td><div class="client-name"><div class="client-avatar" style="background:' + avatarColor(c.nombre) + '">' + initials(c.nombre) + '</div>' + c.nombre + '</div></td>' +
                '<td><div class="client-phone">' + (c.telefono || '-') + (c.telefono ? (c.telefono.startsWith('fb_') ? ' <span title="Messenger" style="cursor:default;"></span>' : ' <a href="' + waLink(c.telefono) + '" target="_blank" title="WhatsApp"></a>') : '') + '</div></td>' +
                '<td style="font-weight:600;">' + c.vehiculo + '</td>' +
                '<td><span class="badge badge-' + estadoCClass(c.estado) + '">' + c.estado + '</span></td>' +
                '<td>' + getSeguimientoHTML(c) + '</td>' +
                '<td><span class="responsable-tag resp-' + c.responsable.toLowerCase() + '">' + (c.responsable === 'Sebastian' ? '&#128156;' : '&#128153;') + ' ' + c.responsable + '</span></td>' +
                '<td><div class="description-cell" title="' + (c.notas || '') + '">' + (c.notas || '-') + '</div></td>' +
                '<td><div class="actions-cell"><button class="btn-icon" onclick="openSeguimiento(\'' + c.id + '\')" title="Seguimiento">&#128202;</button><button class="btn-icon" onclick="openModal(\'comprador\',\'' + c.id + '\')" title="Editar">&#9998;</button><button class="btn-icon delete" onclick="deleteComprador(\'' + c.id + '\')" title="Eliminar">&#128465;</button></div></td>' +
                '</tr>').join('');

            document.getElementById('count-compradores').textContent = compradores.length;
        }

        // ==========================================
        // STATS
        // ==========================================
        function updateStats() {
            document.getElementById('stat-vendedores').textContent = vendedores.length;
            document.getElementById('stat-compradores').textContent = compradores.length;
            document.getElementById('stat-citas').textContent = compradores.filter(c => ['Cita Confirmada','En Camino','Llego al Lugar','En Cita'].includes(c.estado)).length;
            document.getElementById('stat-vendidos').textContent = compradores.filter(c => c.estado === 'Vendido').length;
        }

        // ==========================================
        // UTILITIES
        // ==========================================
        function initials(name) {
            return name.split(' ').map(function(w) { return w[0]; }).join('').toUpperCase().slice(0, 2);
        }
        function avatarColor(name) {
            var colors = ['#7c3aed','#0891b2','#10b981','#f59e0b','#ef4444','#3b82f6','#ec4899','#8b5cf6','#06b6d4','#84cc16'];
            var hash = 0;
            for (var i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        }
        function formatDate(dateStr) {
            if (!dateStr) return '';
            var months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
            var d = new Date(dateStr + 'T00:00:00');
            return d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
        }
        function estadoVClass(estado) {
            var map = { 'Carece Informacion': 'carece', 'Publicar Fyra': 'publicar', 'Publicado': 'publicado' };
            return map[estado] || 'info';
        }
        function estadoCClass(estado) {
            var map = {
                'Pre-Agendacion': 'preagendacion', 'Cita Confirmada': 'citaconfirmada',
                'En Camino': 'encamino', 'Llego al Lugar': 'llegoallugar',
                'En Cita': 'encita', 'Post-Cita': 'postcita',
                'Tramite Bancario': 'tramitebancario', 'Separado': 'separado',
                'Vendido': 'vendido', 'Venta Fallida': 'ventafallida',
                // backwards compat
                'Previa Agendacion': 'preagendacion', 'Cita Agendada': 'citaconfirmada',
                'Cita Concretada': 'postcita'
            };
            return map[estado] || 'info';
        }

        function getDiasEnEstado(c) {
            var cambio = c.estadoCambio || c.created || Date.now();
            return Math.floor((Date.now() - cambio) / 86400000);
        }

        function getUrgenciaClass(dias, estado) {
            if (['Vendido','Venta Fallida'].includes(estado)) return 'cd-fresh';
            if (dias <= 1) return 'cd-fresh';
            if (dias <= 3) return 'cd-attention';
            return 'cd-urgent';
        }

        function getSeguimientoHTML(c) {
            var dias = getDiasEnEstado(c);
            var cls = getUrgenciaClass(dias, c.estado);
            var horas = (Date.now() - (c.estadoCambio || c.created || Date.now())) / 3600000;
            var label = horas < 1 ? Math.floor(horas*60) + 'min' : horas < 24 ? Math.floor(horas) + 'h' : dias + 'd';
            var segCls = cls === 'cd-fresh' ? 'seg-aldia' : cls === 'cd-attention' ? 'seg-pendiente' : 'seg-urgente';
            var emoji = cls === 'cd-fresh' ? '&#9989;' : cls === 'cd-attention' ? '&#9888;' : '&#128308;';

            // Check if alert is active
            var tl = getTimelineAction(c);
            var alertBadge = '';
            if (tl && tl.action && tl.shouldAlert && !['Vendido','Venta Fallida','En Camino','Llego al Lugar','En Cita'].includes(c.estado)) {
                alertBadge = '<span class="seg-alert-badge">MENSAJE</span>';
            }

            return '<span class="seg-indicator ' + segCls + '" onclick="openSeguimiento(\'' + c.id + '\')" title="Abrir seguimiento">' +
                emoji + ' ' + label + '</span>' + alertBadge;
        }
        function showNotif(text, isError) {
            var n = document.getElementById('notification');
            document.getElementById('notif-icon').innerHTML = isError ? '&#9888;' : '&#9989;';
            document.getElementById('notif-text').textContent = text;
            n.style.background = isError ? '#ef4444' : '#111827';
            n.classList.add('show');
            setTimeout(function() { n.classList.remove('show'); }, 2500);
        }

        // ==========================================
        // PROYECTOS
        // ==========================================
        function openProyectoModal(id) {
            var modal = document.getElementById('modal-proyecto');
            modal.classList.add('show');

            if (id) {
                var p = proyectos.find(function(x) { return x.id === id; });
                document.getElementById('modal-proyecto-title').textContent = 'Editar Proyecto';
                document.getElementById('p-edit-id').value = id;
                document.getElementById('p-nombre').value = p.nombre;
                document.getElementById('p-descripcion').value = p.descripcion || '';
                document.getElementById('p-prioridad').value = p.prioridad;
                document.getElementById('p-estado').value = p.estado;
                document.getElementById('p-responsable').value = p.responsable;
                document.getElementById('p-fecha').value = p.fecha || '';
            } else {
                document.getElementById('modal-proyecto-title').textContent = 'Nuevo Proyecto';
                document.getElementById('p-edit-id').value = '';
                document.querySelectorAll('#modal-proyecto input, #modal-proyecto textarea').forEach(function(i) { if(i.type !== 'hidden') i.value = ''; });
                document.getElementById('p-prioridad').value = 'Media';
                document.getElementById('p-estado').value = 'Activo';
                document.getElementById('p-responsable').value = currentUser;
            }
        }

        function closeProyectoModal() {
            document.getElementById('modal-proyecto').classList.remove('show');
        }

        function saveProyecto() {
            var nombre = document.getElementById('p-nombre').value.trim();
            var descripcion = document.getElementById('p-descripcion').value.trim();
            var prioridad = document.getElementById('p-prioridad').value;
            var estado = document.getElementById('p-estado').value;
            var responsable = document.getElementById('p-responsable').value;
            var fecha = document.getElementById('p-fecha').value;
            var editId = document.getElementById('p-edit-id').value;

            if (!nombre) {
                showNotif('Escribe el nombre del proyecto', true);
                return;
            }

            if (editId) {
                var idx = proyectos.findIndex(function(x) { return x.id === editId; });
                if (idx >= 0) {
                    proyectos[idx].nombre = nombre;
                    proyectos[idx].descripcion = descripcion;
                    proyectos[idx].prioridad = prioridad;
                    proyectos[idx].estado = estado;
                    proyectos[idx].responsable = responsable;
                    proyectos[idx].fecha = fecha;
                    proyectos[idx].updated = Date.now();
                }
                showNotif('Proyecto actualizado');
            } else {
                proyectos.push({
                    id: 'P' + Date.now(),
                    nombre: nombre,
                    descripcion: descripcion,
                    prioridad: prioridad,
                    estado: estado,
                    responsable: responsable,
                    fecha: fecha,
                    pendientes: [],
                    created: Date.now(),
                    updated: Date.now()
                });
                showNotif('Proyecto creado');
            }

            saveToCloud();
            renderProyectos();
            updateStats();
            closeProyectoModal();
        }

        function deleteProyecto(id) {
            if (!confirm('Eliminar este proyecto y todos sus pendientes?')) return;
            proyectos = proyectos.filter(function(x) { return x.id !== id; });
            saveToCloud();
            renderProyectos();
            updateStats();
            showNotif('Proyecto eliminado');
        }

        function addPendiente(proyId) {
            var input = document.getElementById('pend-input-' + proyId);
            if (!input) {
                // Create input
                var container = document.getElementById('pend-list-' + proyId);
                var inp = document.createElement('input');
                inp.type = 'text';
                inp.id = 'pend-input-' + proyId;
                inp.className = 'proy-add-input';
                inp.placeholder = 'Escribe el pendiente y presiona Enter...';
                inp.onkeydown = function(e) {
                    if (e.key === 'Enter' && this.value.trim()) {
                        var p = proyectos.find(function(x) { return x.id === proyId; });
                        if (p) {
                            if (!p.pendientes) p.pendientes = [];
                            p.pendientes.push({
                                id: 'T' + Date.now(),
                                texto: this.value.trim(),
                                done: false,
                                created: Date.now()
                            });
                            p.updated = Date.now();
                            saveToCloud();
                            renderProyectos();
                        }
                    }
                    if (e.key === 'Escape') {
                        renderProyectos();
                    }
                };
                container.appendChild(inp);
                inp.focus();
            } else {
                input.focus();
            }
        }

        function togglePendiente(proyId, pendId) {
            var p = proyectos.find(function(x) { return x.id === proyId; });
            if (p && p.pendientes) {
                var t = p.pendientes.find(function(x) { return x.id === pendId; });
                if (t) {
                    t.done = !t.done;
                    p.updated = Date.now();
                    saveToCloud();
                    renderProyectos();
                }
            }
        }

        function deletePendiente(proyId, pendId) {
            var p = proyectos.find(function(x) { return x.id === proyId; });
            if (p && p.pendientes) {
                p.pendientes = p.pendientes.filter(function(x) { return x.id !== pendId; });
                p.updated = Date.now();
                saveToCloud();
                renderProyectos();
            }
        }

        function getProyProgress(p) {
            if (!p.pendientes || p.pendientes.length === 0) return 0;
            var done = p.pendientes.filter(function(t) { return t.done; }).length;
            return Math.round((done / p.pendientes.length) * 100);
        }

        function prioridadClass(pri) {
            return 'proy-p-' + pri.toLowerCase();
        }

        function estadoProyClass(est) {
            return 'proy-e-' + est.toLowerCase();
        }

        function renderProyectos() {
            var grid = document.getElementById('proy-grid');
            if (!grid) return;

            var countEl = document.getElementById('count-proyectos');
            if (countEl) countEl.textContent = proyectos.length;

            if (proyectos.length === 0) {
                grid.innerHTML = '<div class="proy-empty"><div class="empty-icon">&#128204;</div><p>No hay proyectos. Crea uno nuevo para empezar.</p></div>';
                return;
            }

            // Sort: Urgente first, then by created desc
            var sorted = proyectos.slice().sort(function(a, b) {
                var priOrder = { Urgente: 0, Alta: 1, Media: 2, Baja: 3 };
                var estOrder = { Activo: 0, Pausado: 1, Completado: 2, Cancelado: 3 };
                if (estOrder[a.estado] !== estOrder[b.estado]) return estOrder[a.estado] - estOrder[b.estado];
                if (priOrder[a.prioridad] !== priOrder[b.prioridad]) return priOrder[a.prioridad] - priOrder[b.prioridad];
                return b.created - a.created;
            });

            grid.innerHTML = sorted.map(function(p) {
                var progress = getProyProgress(p);
                var totalPend = p.pendientes ? p.pendientes.length : 0;
                var donePend = p.pendientes ? p.pendientes.filter(function(t) { return t.done; }).length : 0;
                var respClass = p.responsable === 'Sebastian' ? 'resp-sebastian' :
                                p.responsable === 'Mario' ? 'resp-mario' : 'resp-sebastian';

                var pendientesHTML = '';
                if (p.pendientes && p.pendientes.length > 0) {
                    pendientesHTML = p.pendientes.map(function(t) {
                        return '<div class="proy-pendiente-item">' +
                            '<div class="proy-check ' + (t.done ? 'done' : '') + '" onclick="togglePendiente(\'' + p.id + '\',\'' + t.id + '\')">' + (t.done ? '&#10003;' : '') + '</div>' +
                            '<span class="proy-pendiente-text ' + (t.done ? 'done' : '') + '">' + t.texto + '</span>' +
                            '<button class="proy-pendiente-delete" onclick="deletePendiente(\'' + p.id + '\',\'' + t.id + '\')">&times;</button>' +
                            '</div>';
                    }).join('');
                }

                return '<div class="proy-card">' +
                    '<div class="proy-card-header">' +
                        '<div>' +
                            '<div class="proy-card-title">' + p.nombre + '</div>' +
                            (p.descripcion ? '<div class="proy-card-desc" title="' + p.descripcion + '">' + p.descripcion + '</div>' : '') +
                        '</div>' +
                        '<div class="proy-card-actions">' +
                            '<button onclick="openProyectoModal(\'' + p.id + '\')" title="Editar">&#9998;</button>' +
                            '<button class="delete" onclick="deleteProyecto(\'' + p.id + '\')" title="Eliminar">&#128465;</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="proy-status-bar">' +
                        '<span class="proy-priority ' + prioridadClass(p.prioridad) + '">' + p.prioridad + '</span>' +
                        '<span class="proy-estado ' + estadoProyClass(p.estado) + '">' + p.estado + '</span>' +
                        '<span class="responsable-tag ' + respClass + '" style="font-size:10px;">' + p.responsable + '</span>' +
                        (p.fecha ? '<span style="font-size:10px;color:var(--gray);margin-left:auto;">&#128197; ' + formatDate(p.fecha) + '</span>' : '') +
                    '</div>' +
                    '<div class="proy-progress-bar"><div class="proy-progress-fill" style="width:' + progress + '%"></div></div>' +
                    '<div class="proy-pendientes">' +
                        '<div class="proy-pendientes-header">' +
                            '<span>Pendientes <span class="proy-count">' + donePend + '/' + totalPend + '</span></span>' +
                            '<button class="proy-add-pendiente" onclick="addPendiente(\'' + p.id + '\')" title="Agregar pendiente">+</button>' +
                        '</div>' +
                        '<div id="pend-list-' + p.id + '">' + pendientesHTML + '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // ==========================================
        // CALENDARIO SEMANAL
        // ==========================================
        var calCurrentDate = new Date();
        var calHours = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22];
        var calMonths = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        var calDays = ['DOM','LUN','MAR','MIE','JUE','VIE','SAB'];
        var calWeekStart = null;
        var calPopupData = { day: 0, hour: 10, type: 'evento' };

        function calGetWeekStart(date) {
            var d = new Date(date); d.setDate(d.getDate() - d.getDay()); d.setHours(0,0,0,0); return d;
        }
        function calGoToday() { calCurrentDate = new Date(); renderCalendar(); }
        function calPrev() { calCurrentDate.setDate(calCurrentDate.getDate() - 7); renderCalendar(); }
        function calNext() { calCurrentDate.setDate(calCurrentDate.getDate() + 7); renderCalendar(); }
        function calSameDay(a, b) {
            return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
        }
        function calFormatTime12(h, m) {
            var suffix = h >= 12 ? 'pm' : 'am';
            var h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            return h12 + ':' + (m < 10 ? '0' : '') + m + suffix;
        }
        function calTimeToStr(h, m) {
            return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
        }

        // Parse time from text
        function parseTimeFromText(text) {
            if (!text) return null;
            var t = text.toLowerCase().trim();
            var patterns = [
                /(\d{1,2}):(\d{2})\s*(am|pm)/i, /(\d{1,2})\s*(am|pm)/i,
                /(\d{1,2}):(\d{2})/, /a\s*las\s*(\d{1,2}):?(\d{2})?/i, /(\d{1,2})\s*hrs?/i
            ];
            for (var i = 0; i < patterns.length; i++) {
                var m = t.match(patterns[i]);
                if (m) {
                    var hour = parseInt(m[1]), min = m[2] && !isNaN(parseInt(m[2])) ? parseInt(m[2]) : 0;
                    var ampm = m[3] ? m[3].toLowerCase() : null;
                    if (ampm === 'pm' && hour < 12) hour += 12;
                    if (ampm === 'am' && hour === 12) hour = 0;
                    if (hour >= 0 && hour <= 23) return { hour: hour, min: min };
                }
            }
            return null;
        }

        function parseDateFromText(text) {
            if (!text) return null;
            var t = text.toLowerCase().trim();
            var today = new Date();
            if (t.indexOf('hoy') >= 0) return today;
            if (t.indexOf('mana') >= 0 || t.indexOf('maana') >= 0) { var d = new Date(today); d.setDate(d.getDate()+1); return d; }
            var dn = {'lun':1,'mar':2,'mie':3,'mi':3,'jue':4,'vie':5,'sab':6,'sb':6,'dom':0};
            for (var k in dn) { if (t.indexOf(k) >= 0) { var diff = dn[k]-today.getDay(); if(diff<=0) diff+=7; var d=new Date(today); d.setDate(d.getDate()+diff); return d; } }
            var iso = t.match(/(\d{4})-(\d{2})-(\d{2})/);
            if (iso) return new Date(iso[1], parseInt(iso[2])-1, iso[3]);
            return null;
        }

        // Collect all events
        function getCalendarEvents() {
            var evs = [];

            // 1) Citas CRM
            compradores.forEach(function(c) {
                if (['Cita Confirmada','En Camino','Llego al Lugar','En Cita'].includes(c.estado) && c.citaFecha) {
                    var date = new Date(c.citaFecha + 'T00:00:00');
                    var hour = 10, min = 0;
                    if (c.citaHora) { var p = c.citaHora.split(':'); hour = parseInt(p[0])||10; min = parseInt(p[1])||0; }
                    evs.push({ type:'cita', title:'Cita: '+c.nombre, subtitle:c.vehiculo, date:date, hour:hour, min:min, duration:60, responsable:c.responsable });
                }
            });

            // 2) Pendientes con hora
            proyectos.forEach(function(p) {
                if (!p.pendientes) return;
                p.pendientes.forEach(function(t) {
                    if (t.done) return;
                    var time = parseTimeFromText(t.texto);
                    if (!time) return;
                    var date = parseDateFromText(t.texto);
                    if (!date && p.fecha) date = new Date(p.fecha+'T00:00:00');
                    if (!date) date = new Date();
                    var cleanTitle = t.texto.replace(/\d{1,2}:\d{2}\s*(am|pm)?/gi,'').replace(/\d{1,2}\s*(am|pm)/gi,'').replace(/a\s*las\s*\d+/gi,'').trim() || t.texto;
                    evs.push({ type:'pendiente', title:cleanTitle, subtitle:p.nombre, date:date, hour:time.hour, min:time.min, duration:45, responsable:p.responsable });
                });
            });

            // 3) Eventos manuales
            eventos.forEach(function(ev) {
                var date = new Date(ev.fecha + 'T00:00:00');
                var startParts = ev.horaInicio.split(':');
                var endParts = ev.horaFin.split(':');
                var h1 = parseInt(startParts[0])||10, m1 = parseInt(startParts[1])||0;
                var h2 = parseInt(endParts[0])||11, m2 = parseInt(endParts[1])||0;
                var dur = (h2*60+m2) - (h1*60+m1);
                if (dur <= 0) dur = 60;
                evs.push({ type:ev.tipo||'evento', title:ev.titulo, subtitle:ev.descripcion||'', date:date, hour:h1, min:m1, duration:dur, responsable:ev.responsable, evId:ev.id });
            });

            return evs;
        }

        // Click on slot  open popup
        function calSlotClick(dayIdx, hour, e) {
            var weekS = calGetWeekStart(calCurrentDate);
            var clickDate = new Date(weekS);
            clickDate.setDate(weekS.getDate() + dayIdx);

            calPopupData.day = dayIdx;
            calPopupData.hour = hour;
            calPopupData.date = clickDate;
            calPopupData.type = 'evento';

            // Fill popup
            document.getElementById('calev-titulo').value = '';
            document.getElementById('calev-hora-inicio').value = calTimeToStr(hour, 0);
            document.getElementById('calev-hora-fin').value = calTimeToStr(hour + 1, 0);
            document.getElementById('calev-responsable').value = currentUser;
            document.getElementById('calev-descripcion').value = '';

            var dayNames = ['Domingo','Lunes','Martes','Miercoles','Jueves','Viernes','Sabado'];
            var mNames = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
            document.getElementById('calev-fecha-display').textContent =
                dayNames[clickDate.getDay()] + ', ' + clickDate.getDate() + ' de ' + mNames[clickDate.getMonth()];

            // Type buttons reset
            calSetType('evento');

            // Position popup near click
            var popup = document.getElementById('cal-popup');
            var rect = e.target.getBoundingClientRect();
            var left = Math.min(rect.left + 10, window.innerWidth - 340);
            var top = Math.min(rect.top, window.innerHeight - 400);
            popup.style.left = Math.max(10, left) + 'px';
            popup.style.top = Math.max(10, top) + 'px';
            popup.classList.add('show');

            setTimeout(function() { document.getElementById('calev-titulo').focus(); }, 100);
        }

        function calClosePopup() {
            document.getElementById('cal-popup').classList.remove('show');
        }

        function calSetType(type) {
            calPopupData.type = type;
            document.querySelectorAll('.cal-popup-type').forEach(function(btn) {
                btn.className = 'cal-popup-type';
                if (btn.dataset.type === type) {
                    if (type === 'evento') btn.classList.add('active-ev');
                    else if (type === 'cita') btn.classList.add('active-cita');
                    else btn.classList.add('active-pend');
                }
            });
            // Change save button color
            var saveBtn = document.getElementById('calev-save-btn');
            if (type === 'cita') saveBtn.style.background = '#3b82f6';
            else if (type === 'pendiente') saveBtn.style.background = '#8b5cf6';
            else saveBtn.style.background = 'var(--cyan)';
        }

        function calSaveEvent() {
            var titulo = document.getElementById('calev-titulo').value.trim();
            if (!titulo) { showNotif('Escribe un titulo', true); return; }

            var horaInicio = document.getElementById('calev-hora-inicio').value;
            var horaFin = document.getElementById('calev-hora-fin').value;
            var responsable = document.getElementById('calev-responsable').value;
            var descripcion = document.getElementById('calev-descripcion').value.trim();

            var clickDate = calPopupData.date;
            var fecha = clickDate.getFullYear() + '-' +
                (clickDate.getMonth() + 1 < 10 ? '0' : '') + (clickDate.getMonth() + 1) + '-' +
                (clickDate.getDate() < 10 ? '0' : '') + clickDate.getDate();

            eventos.push({
                id: 'EV' + Date.now(),
                titulo: titulo,
                tipo: calPopupData.type,
                fecha: fecha,
                horaInicio: horaInicio,
                horaFin: horaFin,
                responsable: responsable,
                descripcion: descripcion,
                created: Date.now()
            });

            saveToCloud();
            renderCalendar();
            calClosePopup();
            showNotif('Evento creado: ' + titulo);
        }

        // Delete manual event
        function calDeleteEvent(evId) {
            if (!confirm('Eliminar este evento?')) return;
            eventos = eventos.filter(function(e) { return e.id !== evId; });
            saveToCloud();
            renderCalendar();
            showNotif('Evento eliminado');
        }

        // Close popup on outside click
        document.addEventListener('click', function(e) {
            var popup = document.getElementById('cal-popup');
            if (!popup || !popup.classList.contains('show')) return;
            if (!popup.contains(e.target) && !e.target.classList.contains('cal-hour-slot')) {
                calClosePopup();
            }
        });

        function renderCalendar() {
            calWeekStart = calGetWeekStart(calCurrentDate);
            var today = new Date(); today.setHours(0,0,0,0);

            var titleEl = document.getElementById('cal-month-title');
            if (titleEl) titleEl.textContent = calMonths[calCurrentDate.getMonth()] + ' de ' + calCurrentDate.getFullYear();

            var header = document.getElementById('cal-header');
            if (!header) return;
            var hHTML = '<div class="cal-gmt">GMT-06</div>';
            for (var d = 0; d < 7; d++) {
                var dd = new Date(calWeekStart); dd.setDate(calWeekStart.getDate() + d);
                var isT = calSameDay(dd, today);
                hHTML += '<div class="cal-day-header">' + calDays[d] +
                    '<div class="cal-day-num ' + (isT ? 'today' : '') + '">' + dd.getDate() + '</div></div>';
            }
            header.innerHTML = hHTML;

            // Grid
            var grid = document.getElementById('cal-grid');
            var gHTML = '';
            for (var h = 0; h < calHours.length; h++) {
                var hr = calHours[h];
                var lbl = hr < 12 ? hr + ' AM' : hr === 12 ? '12 PM' : (hr-12) + ' PM';
                gHTML += '<div class="cal-time-col"><div class="cal-time-label">' + lbl + '</div></div>';
                for (var di = 0; di < 7; di++) {
                    gHTML += '<div class="cal-day-col" data-dayidx="'+di+'" data-houridx="'+h+'">' +
                        '<div class="cal-hour-slot" data-hour="'+hr+'" data-day="'+di+'" onclick="calSlotClick('+di+','+hr+',event)"></div></div>';
                }
            }
            grid.innerHTML = gHTML;

            // Place events
            var allEvents = getCalendarEvents();
            allEvents.forEach(function(ev) {
                var evDate = new Date(ev.date); evDate.setHours(0,0,0,0);
                for (var di = 0; di < 7; di++) {
                    var colDate = new Date(calWeekStart); colDate.setDate(calWeekStart.getDate() + di); colDate.setHours(0,0,0,0);
                    if (!calSameDay(evDate, colDate)) continue;
                    if (ev.hour < calHours[0] || ev.hour > calHours[calHours.length-1]) break;

                    // Find hour row index
                    var hIdx = -1;
                    for (var hi = 0; hi < calHours.length; hi++) { if (calHours[hi] === ev.hour) { hIdx = hi; break; } }
                    if (hIdx < 0) { for (var hi2 = 0; hi2 < calHours.length; hi2++) { if (calHours[hi2] >= ev.hour) { hIdx = hi2; break; } } }
                    if (hIdx < 0) break;

                    var colIdx = hIdx * 7 + di;
                    var dayCols = grid.querySelectorAll('.cal-day-col');
                    var col = dayCols[colIdx];
                    if (!col) break;

                    var topPx = (ev.min / 60) * 60;
                    var heightPx = Math.max((ev.duration / 60) * 60, 26);
                    var cls = ev.type === 'cita' ? 'cal-event-cita' : ev.type === 'pendiente' ? 'cal-event-pendiente' : 'cal-event-manual';
                    var timeS = calFormatTime12(ev.hour, ev.min);
                    var endH = ev.hour + Math.floor((ev.min + ev.duration)/60);
                    var endM = (ev.min + ev.duration) % 60;
                    var timeE = calFormatTime12(endH, endM);

                    var el = document.createElement('div');
                    el.className = 'cal-event ' + cls;
                    el.style.top = topPx + 'px';
                    el.style.height = heightPx + 'px';
                    el.innerHTML = '<div class="cal-event-title">' + ev.title + '</div>' +
                        '<div class="cal-event-time">' + timeS + '  ' + timeE + '</div>';
                    el.title = ev.title + (ev.subtitle ? '\n' + ev.subtitle : '') + '\n' + (ev.responsable || '');

                    // Right-click to delete manual events
                    if (ev.evId) {
                        el.style.cursor = 'pointer';
                        el.onclick = function(e) { e.stopPropagation(); calDeleteEvent(ev.evId); };
                    } else {
                        el.onclick = function(e) { e.stopPropagation(); };
                    }

                    col.style.position = 'relative';
                    col.appendChild(el);
                    break;
                }
            });

            // Current time red line
            var now = new Date();
            if (now.getHours() >= calHours[0] && now.getHours() <= calHours[calHours.length-1]) {
                for (var di2 = 0; di2 < 7; di2++) {
                    var dayD = new Date(calWeekStart); dayD.setDate(calWeekStart.getDate() + di2); dayD.setHours(0,0,0,0);
                    if (calSameDay(dayD, today)) {
                        var nowHIdx = -1;
                        for (var nhi = 0; nhi < calHours.length; nhi++) { if (calHours[nhi] === now.getHours()) { nowHIdx = nhi; break; } }
                        if (nowHIdx >= 0) {
                            var nowCol = grid.querySelectorAll('.cal-day-col')[nowHIdx * 7 + di2];
                            if (nowCol) {
                                nowCol.style.position = 'relative';
                                var line = document.createElement('div');
                                line.className = 'cal-now-line';
                                line.style.top = (now.getMinutes() / 60 * 60) + 'px';
                                line.innerHTML = '<div class="cal-now-dot"></div>';
                                nowCol.appendChild(line);
                            }
                        }
                        break;
                    }
                }
            }

            // Scroll to now
            var scrollEl = document.getElementById('cal-scroll');
            if (scrollEl && !scrollEl.dataset.scrolled) {
                var scrollTo = Math.max(0, (now.getHours() - calHours[0]) * 60 - 60);
                scrollEl.scrollTop = scrollTo;
                scrollEl.dataset.scrolled = '1';
            }
        }

        // ==========================================
        // COTIZADOR - FORMULAS IDENTICAS
        // ==========================================
        var COT_TASA_ANUAL = 0.1599;
        var COT_TASA_MENSUAL = COT_TASA_ANUAL / 12;
        var COT_SEGURO_VIDA = 1800;
        var COT_COMISION = 0.0201;
        var COT_IVA = 0.16;
        var COT_DESCUENTO = 400;

        var cotReglas = {
            2025: { min: 25, max: 60 },
            2024: { min: 25, max: 60 },
            2023: { min: 25, max: 60 },
            2022: { min: 25, max: 60 },
            2021: { min: 25, max: 60 },
            2020: { min: 35, max: 48 },
            2019: { min: 35, max: 48 },
            2018: { min: 35, max: 48 }
        };

        var cotState = {
            precio: 590000,
            enganche: 147500,
            plazo: 60,
            year: 2023
        };

        function cotFormatMoney(n) {
            return '$' + Math.round(n).toLocaleString('en-US');
        }

        function cotFormatMoney2(n) {
            return '$' + n.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        function cotSetPlazo(p) {
            var r = cotReglas[cotState.year];
            if (p > r.max) return;
            cotState.plazo = p;
            cotUpdatePlazoBtns();
            cotCalcular();
        }

        function cotUpdatePlazoBtns() {
            var r = cotReglas[cotState.year];
            document.querySelectorAll('.cot-plazo-btn').forEach(function(btn) {
                var p = parseInt(btn.dataset.plazo);
                btn.classList.remove('active', 'disabled');
                if (p > r.max) {
                    btn.classList.add('disabled');
                } else if (p === cotState.plazo) {
                    btn.classList.add('active');
                }
            });
        }

        function cotUpdateEngancheDisplay() {
            var pct = (cotState.enganche / cotState.precio) * 100;
            document.getElementById('cot-engancheDisplayPct').textContent = pct.toFixed(2) + '%';
            document.getElementById('cot-engancheDisplayAmount').textContent = cotFormatMoney(cotState.enganche);
            document.getElementById('cot-engancheResumen').textContent = cotFormatMoney(cotState.enganche);

            var r = cotReglas[cotState.year];
            var warning = document.getElementById('cot-engancheWarning');
            document.getElementById('cot-minEnganche').textContent = r.min + '%';

            if (pct < r.min) {
                warning.classList.add('show');
            } else {
                warning.classList.remove('show');
            }
        }

        function cotCalcular() {
            var precio = cotState.precio;
            var enganche = cotState.enganche;
            var plazo = cotState.plazo;

            var financiamiento = precio - enganche;
            var subtotal = financiamiento + COT_SEGURO_VIDA;
            var iva = subtotal * COT_IVA;
            var montoFinanciar = subtotal + iva;

            var r = COT_TASA_MENSUAL;
            var n = plazo;
            var mensualidad = montoFinanciar * (r * Math.pow(1+r, n)) / (Math.pow(1+r, n) - 1);
            mensualidad = mensualidad - COT_DESCUENTO;

            var comision = precio * COT_COMISION;
            var desembolso = enganche + comision;
            var total = mensualidad * plazo;

            document.getElementById('cot-mensualidad').textContent = cotFormatMoney2(mensualidad);
            document.getElementById('cot-plazoTexto').textContent = plazo;
            document.getElementById('cot-precioDisplay').textContent = cotFormatMoney(precio);
            document.getElementById('cot-financiamiento').textContent = cotFormatMoney(financiamiento);
            document.getElementById('cot-iva').textContent = cotFormatMoney(iva);
            document.getElementById('cot-montoFinanciar').textContent = cotFormatMoney(montoFinanciar);
            document.getElementById('cot-comision').textContent = cotFormatMoney(comision);
            document.getElementById('cot-desembolso').textContent = cotFormatMoney(desembolso);
            document.getElementById('cot-totalPagar').textContent = cotFormatMoney(total);

            document.getElementById('cot-carNamePDF').textContent = document.getElementById('cot-carName').value + ' ' + cotState.year;

            cotUpdateEngancheDisplay();
        }

        function cotDescargarPDF() {
            var elemento = document.getElementById('tab-cotizador');
            var nombre = document.getElementById('cot-carName').value.replace(/[^a-zA-Z0-9]/g, '_');

            document.querySelectorAll('.cot-no-pdf').forEach(function(el) { el.style.display = 'none'; });
            document.getElementById('cot-carNameDisplay').style.display = 'flex';
            document.getElementById('cot-pdf-header').style.display = 'block';

            var opciones = {
                margin: 5,
                filename: 'Cotizacion_' + nombre + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opciones).from(elemento).save().then(function() {
                document.querySelectorAll('.cot-no-pdf').forEach(function(el) { el.style.display = ''; });
                document.getElementById('cot-carNameDisplay').style.display = 'none';
                document.getElementById('cot-pdf-header').style.display = 'none';
            });
        }

        // Cotizador Events
        document.getElementById('cot-carPrice').addEventListener('input', function() {
            cotState.precio = parseInt(this.value.replace(/\D/g, '')) || 0;
            var pct = parseFloat(document.getElementById('cot-enganchePct').value) || 25;
            cotState.enganche = cotState.precio * (pct / 100);
            document.getElementById('cot-enganchePesos').value = Math.round(cotState.enganche);
            cotCalcular();
        });

        document.getElementById('cot-enganchePesos').addEventListener('input', function() {
            cotState.enganche = parseInt(this.value.replace(/\D/g, '')) || 0;
            var pct = (cotState.enganche / cotState.precio) * 100;
            document.getElementById('cot-enganchePct').value = pct.toFixed(1);
            cotCalcular();
        });

        document.getElementById('cot-enganchePct').addEventListener('input', function() {
            var pct = parseFloat(this.value) || 0;
            cotState.enganche = cotState.precio * (pct / 100);
            document.getElementById('cot-enganchePesos').value = Math.round(cotState.enganche);
            cotCalcular();
        });

        document.getElementById('cot-carYear').addEventListener('change', function() {
            cotState.year = parseInt(this.value);
            var r = cotReglas[cotState.year];
            document.getElementById('cot-engancheRule').textContent = 'Minimo ' + r.min + '%';
            if (cotState.plazo > r.max) cotState.plazo = r.max;
            cotUpdatePlazoBtns();
            cotCalcular();
        });

        document.getElementById('cot-carName').addEventListener('input', cotCalcular);

        // Init cotizador
        cotCalcular();

        // ==========================================
        // SEGUIMIENTO - STATE MACHINE + CRONOMETRO REAL TIME
        // ==========================================
        var BUYER_STATES = ['Pre-Agendacion','Cita Confirmada','En Camino','Llego al Lugar','En Cita','Post-Cita','Tramite Bancario','Separado','Vendido'];
        var segCurrentId = null;
        var segCronoInterval = null;
        var segAlertInterval = null;
        var segAlertShownFor = {}; // track shown alerts

        // REGLAS DE TIEMPO: cuando alertar y que sugerir
        // horas = horas desde que entro al estado
        var SEG_TIMELINE = {
            'Pre-Agendacion': [
                { horas: 0.5, tipo: 'primer_contacto', alerta: 'Primer contacto: presentate y genera interes', desc: 'Hace 30min que llego este lead, toca romper el hielo' },
                { horas: 4, tipo: 'confirmar_hora', alerta: 'Confirma hora de cita', desc: 'Ya paso medio dia, confirma disponibilidad para agendar cita' },
                { horas: 24, tipo: 'recordatorio_interes', alerta: 'Ya paso 1 dia  manda recordatorio', desc: 'Se puede estar enfriando, reactiva el interes' },
                { horas: 48, tipo: 'urgencia_suave', alerta: '2 dias sin agendar  urgencia suave', desc: 'Menciona que hay mas interesados, incentiva a agendar' },
                { horas: 72, tipo: 'urgencia_fuerte', alerta: '3 DIAS  se esta enfriando!', desc: 'Ultimo intento estrategico, ofrecele algo extra o cotizacion' },
                { horas: 120, tipo: 'reactivacion', alerta: '5 DIAS  intento de reactivacion', desc: 'Casi perdido, intenta con enfoque diferente o descuento' }
            ],
            'Cita Confirmada': [
                { horas: 1, tipo: 'seguridad', alerta: 'Dale seguridad sobre el proceso', desc: 'Acaba de confirmar, refuerza que es un proceso seguro y serio' },
                { horas: 12, tipo: 'funfact', alerta: 'Manda un fun fact del vehiculo', desc: 'Manten el interes vivo con datos curiosos del carro' },
                { horas: 24, tipo: 'incentivo', alerta: 'Manda un incentivo', desc: 'Dale una razon extra para no faltar a la cita' },
                { horas: 48, tipo: 'recordatorio', alerta: 'Recordatorio de cita', desc: 'Confirma que sigue en pie, manda ubicacion' },
                { horas: 72, tipo: 'confirmar_asistencia', alerta: 'Confirma asistencia final', desc: 'Ya casi es la cita, necesitas confirmacion que va a ir' }
            ],
            'Post-Cita': [
                { horas: 2, tipo: 'agradecimiento', alerta: 'Agradece y pregunta que le parecio', desc: 'Post-cita inmediato: que te parecio? alguna duda?' },
                { horas: 24, tipo: 'seguimiento_suave', alerta: '1 dia post-cita  seguimiento suave', desc: 'Dale espacio pero mantenlo caliente, pregunta si tiene dudas' },
                { horas: 48, tipo: 'ofrecer_cotizacion', alerta: '2 dias  ofrece cotizacion', desc: 'Si no ha decidido, mandale los numeros del credito' },
                { horas: 72, tipo: 'cierre_urgencia', alerta: '3 DIAS  cierre con urgencia', desc: 'Hay mas interesados, es hora de decidir' },
                { horas: 120, tipo: 'negociacion', alerta: '5 DIAS  abre negociacion', desc: 'Ofrece flexibilidad, busca llegar a un acuerdo' },
                { horas: 168, tipo: 'reactivar', alerta: '7 DIAS  ultimo intento', desc: 'Sigue disponible, cambio de enfoque, nueva oportunidad' }
            ],
            'Tramite Bancario': [
                { horas: 48, tipo: 'estatus_tramite', alerta: '2 dias  pregunta estatus del banco', desc: 'Como va el tramite? necesita documentos?' },
                { horas: 120, tipo: 'apoyo', alerta: '5 dias  ofrece apoyo con tramite', desc: 'Puede estar atorado, pregunta si necesita ayuda' }
            ],
            'Separado': [
                { horas: 72, tipo: 'cierre', alerta: '3 dias separado  empuja al cierre', desc: 'Que falta para cerrar? Coordina los papeles' }
            ]
        };

        // INTENCIONES POR ESTADO
        var INTENCIONES = {
            'Pre-Agendacion': [
                {id:'confirmar_hora', emoji:'&#128197;', title:'Confirmar hora', desc:'Agendar dia y hora de cita'},
                {id:'generar_interes', emoji:'&#128293;', title:'Generar interes', desc:'Motivar que vea el vehiculo'},
                {id:'info_vehiculo', emoji:'&#128663;', title:'Info del vehiculo', desc:'Datos, fotos, detalles'},
                {id:'urgencia', emoji:'&#9200;', title:'Urgencia', desc:'Hay mas interesados, no lo pierda'},
                {id:'cotizacion', emoji:'&#128176;', title:'Ofrecer cotizacion', desc:'Enviar cotizacion de credito'},
                {id:'saludo', emoji:'&#128075;', title:'Primer contacto', desc:'Romper el hielo, presentarse'}
            ],
            'Cita Confirmada': [
                {id:'seguridad', emoji:'&#128274;', title:'Brindar seguridad', desc:'Proceso seguro y confiable'},
                {id:'incentivo', emoji:'&#127873;', title:'Incentivo', desc:'Beneficio extra por asistir'},
                {id:'funfact', emoji:'&#128161;', title:'Fun fact', desc:'Dato interesante del vehiculo'},
                {id:'recordatorio', emoji:'&#128276;', title:'Recordatorio cita', desc:'Confirmar que asistira'},
                {id:'confirmar_asistencia', emoji:'&#9989;', title:'Confirmar asistencia', desc:'Sigue en pie la cita?'},
                {id:'direccion', emoji:'&#128205;', title:'Enviar ubicacion', desc:'Donde es el punto de encuentro'}
            ],
            'En Camino': [
                {id:'retraso', emoji:'&#128337;', title:'Retraso', desc:'Avisar que va con retraso'},
                {id:'ya_casi', emoji:'&#128663;', title:'Ya casi llego', desc:'Casi en el punto'}
            ],
            'Llego al Lugar': [
                {id:'identificacion', emoji:'&#128178;', title:'Pedir token', desc:'Solicitar codigo de verificacion'},
                {id:'ubicacion_exacta', emoji:'&#128205;', title:'Ubicacion exacta', desc:'Donde estas exactamente?'}
            ],
            'En Cita': [
                {id:'todo_bien', emoji:'&#128077;', title:'Todo bien', desc:'Confirmar que va todo bien'}
            ],
            'Post-Cita': [
                {id:'seguimiento_suave', emoji:'&#128172;', title:'Seguimiento suave', desc:'Que te parecio? alguna duda?'},
                {id:'cierre_urgencia', emoji:'&#128293;', title:'Cierre con urgencia', desc:'Hay mas interesados, decide'},
                {id:'ofrecer_cotizacion', emoji:'&#128176;', title:'Ofrecer cotizacion', desc:'Te envio numeros del credito'},
                {id:'resolver_dudas', emoji:'&#129300;', title:'Resolver dudas', desc:'Cualquier pregunta estoy aqui'},
                {id:'negociacion', emoji:'&#129309;', title:'Negociacion', desc:'Podemos llegar a un acuerdo'},
                {id:'reactivar', emoji:'&#128260;', title:'Reactivar interes', desc:'Oye, sigue disponible el carro'}
            ],
            'Tramite Bancario': [
                {id:'estatus_tramite', emoji:'&#127974;', title:'Estatus tramite', desc:'Como va con el banco?'},
                {id:'documentos', emoji:'&#128196;', title:'Documentos', desc:'Necesitas algun documento?'},
                {id:'apoyo', emoji:'&#128170;', title:'Apoyo', desc:'En que te puedo ayudar?'}
            ],
            'Separado': [
                {id:'cierre', emoji:'&#128274;', title:'Cerrar venta', desc:'Cuando finalizamos?'},
                {id:'papeles', emoji:'&#128203;', title:'Papeles', desc:'Que falta para cerrar?'}
            ]
        };

        // GENERADOR DE MENSAJES
        function generarMensaje(comprador, intencionId) {
            var c = comprador;
            var nombre = c.nombre.split(' ')[0];
            var vehiculo = c.vehiculo || 'el vehiculo';
            var resp = c.responsable || 'Sebastian';
            var dias = getDiasEnEstado(c);
            var msgs = [];

            if (c.estado === 'Pre-Agendacion') {
                if (intencionId === 'saludo') msgs = [
                    'Hola ' + nombre + '! Soy ' + resp + ' de FYRADRIVE. Vi que te interesa el ' + vehiculo + '. Te gustaria agendar una cita para verlo? Estoy a tus ordenes',
                    'Que tal ' + nombre + '! Te saluda ' + resp + ' de FYRADRIVE. Tenemos el ' + vehiculo + ' disponible, cuando te queda bien para que lo conozcas?',
                    'Hola ' + nombre + '! ' + resp + ' de FYRADRIVE por aca. El ' + vehiculo + ' esta disponible, te gustaria verlo en persona? Puedo agendar una cita cuando gustes'
                ];
                else if (intencionId === 'confirmar_hora') msgs = [
                    'Hola ' + nombre + '! Para agendar tu cita con el ' + vehiculo + ', que dia y hora te funciona mejor esta semana?',
                    nombre + '! Oye, quiero apartar tu lugar para ver el ' + vehiculo + '. Que horario te queda? Tengo disponibilidad esta semana',
                    'Hola ' + nombre + ', listo para agendar tu cita! Que dia prefieres para ver el ' + vehiculo + '? Manana o pasado manana?'
                ];
                else if (intencionId === 'generar_interes') msgs = [
                    'Hola ' + nombre + '! El ' + vehiculo + ' sigue disponible, pero la verdad hay bastante interes. Si te late, conviene verlo pronto. Te lo aparto?',
                    nombre + '! Oye, el ' + vehiculo + ' esta en excelentes condiciones. Justo acabo de sacar unas fotos nuevas, te las paso? Vale mucho la pena verlo en persona',
                    'Hola ' + nombre + '! Te cuento que el ' + vehiculo + ' ha tenido varias visitas. Si te interesa te sugiero agendemos pronto, no me gustaria que se te fuera'
                ];
                else if (intencionId === 'info_vehiculo') msgs = [
                    'Hola ' + nombre + '! Te comparto los detalles del ' + vehiculo + ': esta en excelentes condiciones, verificado y listo para entregar. Quieres que te mande fotos y mas info?',
                    nombre + '! Sobre el ' + vehiculo + ', te cuento: kilometraje bajo, todo al corriente, mantenimiento en agencia. Te gustaria verlo? Puedo mandarte video tambien'
                ];
                else if (intencionId === 'urgencia') msgs = [
                    'Hola ' + nombre + '! Te aviso que esta semana he tenido varias consultas sobre el ' + vehiculo + '. Si sigue siendo de tu interes, te recomiendo que lo veas pronto para que no se te vaya',
                    nombre + '! Oye, solo para avisarte que hay movimiento en el ' + vehiculo + '. No quiero que te lo ganen, agenda tu cita y te lo aparto!'
                ];
                else if (intencionId === 'cotizacion') msgs = [
                    'Hola ' + nombre + '! Quieres que te haga una cotizacion de credito para el ' + vehiculo + '? Te puedo dar los numeros exactos de mensualidad y enganche. Solo necesito que me confirmes el monto de enganche que tienes en mente',
                    nombre + '! Si te interesa financiar el ' + vehiculo + ', puedo cotizarte ahorita mismo. Las tasas estan buenas. Te mando los numeros?'
                ];
            }
            else if (c.estado === 'Cita Confirmada') {
                var citaStr = c.citaFecha ? formatDate(c.citaFecha) : 'el dia de la cita';
                var horaStr = c.citaHora || '';
                if (intencionId === 'seguridad') msgs = [
                    'Hola ' + nombre + '! Quiero que sepas que en FYRADRIVE manejamos un proceso totalmente seguro. El dia de la cita generamos un token de seguridad para verificar identidades. Tu tranquilo, estas en buenas manos',
                    nombre + '! Para tu tranquilidad: el dia de la cita tendras un codigo de seguridad unico, boton de panico y seguimiento en vivo. En FYRADRIVE la seguridad es prioridad',
                    'Hola ' + nombre + '! Solo queria comentarte que nuestro proceso de citas es 100% seguro. Contamos con verificacion por token, ubicacion en vivo y asistencia inmediata. Nos vemos el ' + citaStr + '!'
                ];
                else if (intencionId === 'incentivo') msgs = [
                    'Hola ' + nombre + '! Tengo una buena noticia: por asistir puntual a tu cita del ' + citaStr + ', tenemos un detalle especial para ti. Nos vemos!',
                    nombre + '! Oye, si concretas la compra del ' + vehiculo + ' esta semana, tenemos condiciones especiales de financiamiento. Te cuento en la cita!'
                ];
                else if (intencionId === 'funfact') msgs = [
                    'Hola ' + nombre + '! Sabias que el ' + vehiculo + ' es uno de los mas buscados este 2026? Su valor de reventa se mantiene super bien. Buena eleccion!',
                    nombre + '! Dato curioso: el ' + vehiculo + ' tiene una de las mejores calificaciones en seguridad de su categoria. Vas a estar muy contento con tu compra'
                ];
                else if (intencionId === 'recordatorio') msgs = [
                    'Hola ' + nombre + '! Te recuerdo que tenemos cita el ' + citaStr + (horaStr ? ' a las ' + horaStr : '') + ' para ver el ' + vehiculo + '. Todo confirmado? Te esperamos!',
                    nombre + '! Solo para confirmar: nos vemos el ' + citaStr + (horaStr ? ' a las ' + horaStr : '') + ' para el ' + vehiculo + '. Si necesitas cambiar algo, avisame con confianza',
                    'Hola ' + nombre + '! Ya casi es el dia! Cita ' + citaStr + (horaStr ? ' ' + horaStr : '') + ' para ver el ' + vehiculo + '. Vas a poder llegar? Estoy listo para recibirte'
                ];
                else if (intencionId === 'confirmar_asistencia') msgs = [
                    'Hola ' + nombre + '! Solo paso a confirmar, sigue en pie nuestra cita del ' + citaStr + ' para el ' + vehiculo + '?',
                    nombre + '! Manana es el gran dia! Confirmas que nos vemos ' + citaStr + (horaStr ? ' a las ' + horaStr : '') + '? El ' + vehiculo + ' te espera'
                ];
                else if (intencionId === 'direccion') msgs = [
                    'Hola ' + nombre + '! Te comparto la ubicacion del punto de encuentro para la cita del ' + vehiculo + '. Cualquier duda del camino me marcas directo'
                ];
            }
            else if (c.estado === 'En Camino') {
                if (intencionId === 'retraso') msgs = [
                    'Hola ' + nombre + '! Vamos con un poco de retraso, pero ya estamos en camino. En unos minutos llegamos. Disculpa la demora!',
                    nombre + ', ya casi llegamos! Hay un poco de trafico pero calculo ' + (15 + Math.floor(Math.random()*15)) + ' minutos. Gracias por tu paciencia'
                ];
                else if (intencionId === 'ya_casi') msgs = [
                    nombre + '! Ya vamos llegando, estamos a unos minutos. Listo para conocer el ' + vehiculo + '?',
                    'Hola ' + nombre + '! Ya estoy cerca, en unos 5 minutitos llego. Nos vemos ahi!'
                ];
            }
            else if (c.estado === 'Llego al Lugar') {
                if (intencionId === 'identificacion') msgs = [
                    nombre + '! Ya llegue. Mi codigo de verificacion es el que te llego al momento de activar "En Camino". Me puedes confirmar tu codigo para identificarnos?',
                    'Hola ' + nombre + ', ya estoy en el punto. Para verificar identidades, cual es tu token de seguridad?'
                ];
                else if (intencionId === 'ubicacion_exacta') msgs = [
                    nombre + '! Ya estoy aqui. Donde te encuentras exactamente? Estoy junto a...',
                    'Hola ' + nombre + ', ya llegue al punto de encuentro. Dime donde estas para ubicarte'
                ];
            }
            else if (c.estado === 'Post-Cita') {
                var resultado = c.postcita || 'Lo va a pensar';
                if (intencionId === 'seguimiento_suave') msgs = [
                    'Hola ' + nombre + '! Que gusto haberte visto. Que te parecio el ' + vehiculo + '? Si tienes alguna duda o quieres platicar de numeros, estoy para servirte',
                    nombre + '! Espero que te haya gustado el ' + vehiculo + '. Si necesitas mas info o quieres una segunda vuelta, con toda confianza. Estoy al pendiente',
                    'Hola ' + nombre + '! Ya van ' + dias + ' dias desde que viste el ' + vehiculo + '. Como vas con la decision? Estoy aqui para cualquier duda'
                ];
                else if (intencionId === 'cierre_urgencia') msgs = [
                    'Hola ' + nombre + '! Te platico que el ' + vehiculo + ' ha tenido mas visitas desde la tuya. Si sigue siendo de tu interes, te sugiero que tomemos una decision pronto para no perderlo',
                    nombre + '! Oye, te aviso que el ' + vehiculo + ' tiene otro prospecto serio. Si lo quieres asegurar, hoy es buen momento para separarlo. Que dices?'
                ];
                else if (intencionId === 'ofrecer_cotizacion') msgs = [
                    'Hola ' + nombre + '! Te gustaria que te mande la cotizacion de credito del ' + vehiculo + '? Puedo darte numeros exactos de mensualidad, enganche y plazos',
                    nombre + '! Para que tomes tu decision con todos los datos, quieres que te cotice el financiamiento del ' + vehiculo + '? Las condiciones estan muy buenas'
                ];
                else if (intencionId === 'resolver_dudas') msgs = [
                    'Hola ' + nombre + '! Si te quedo alguna duda del ' + vehiculo + ' o del proceso de compra, con toda confianza preguntame. Estoy para ayudarte a tomar la mejor decision',
                    nombre + '! Oye, por si tienes dudas: el ' + vehiculo + ' cuenta con garantia, esta verificado y tiene todos los papeles en orden. En que mas te puedo apoyar?'
                ];
                else if (intencionId === 'negociacion') msgs = [
                    'Hola ' + nombre + '! Oye, si el tema es el precio del ' + vehiculo + ', platiquemos. Estoy seguro de que podemos llegar a algo que funcione para los dos',
                    nombre + '! Sobre el ' + vehiculo + ': estoy abierto a platicar las condiciones. Que tienes en mente? Vamos a buscarle'
                ];
                else if (intencionId === 'reactivar') msgs = [
                    'Hola ' + nombre + '! Ya paso un rato desde que viste el ' + vehiculo + '. Sigue disponible y en las mismas condiciones. Te gustaria reconsiderarlo?',
                    nombre + '! Oye, el ' + vehiculo + ' sigue aqui. Si cambias de opinion o quieres verlo de nuevo, nomas dime. Sin compromiso'
                ];
            }
            else if (c.estado === 'Tramite Bancario') {
                if (intencionId === 'estatus_tramite') msgs = [
                    'Hola ' + nombre + '! Como va tu tramite bancario para el ' + vehiculo + '? Si necesitas apoyo con algo del banco, estoy aqui',
                    nombre + '! Solo para dar seguimiento: ya hay avance con el credito del ' + vehiculo + '? Cualquier cosa que necesites, cuentas conmigo'
                ];
                else if (intencionId === 'documentos') msgs = [
                    'Hola ' + nombre + '! El banco necesita algun documento adicional para tu tramite del ' + vehiculo + '? Te ayudo a conseguirlo',
                    nombre + '! Revisa si el banco te pidio algo extra. Si necesitas algun documento de nuestra parte, te lo tengo listo'
                ];
                else if (intencionId === 'apoyo') msgs = [
                    'Hola ' + nombre + '! Estoy al pendiente de tu tramite para el ' + vehiculo + '. Si hay cualquier cuestion con el banco, yo te apoyo para agilizar'
                ];
            }
            else if (c.estado === 'Separado') {
                if (intencionId === 'cierre') msgs = [
                    'Hola ' + nombre + '! El ' + vehiculo + ' esta separado para ti. Cuando podemos cerrar? Estoy listo para finalizar',
                    nombre + '! Ya falta poco para que el ' + vehiculo + ' sea tuyo. Que necesitas para que cerremos esta semana?'
                ];
                else if (intencionId === 'papeles') msgs = [
                    'Hola ' + nombre + '! Que falta para finalizar la compra del ' + vehiculo + '? Tengo todo listo de mi lado, solo dime cuando',
                    nombre + '! Los papeles del ' + vehiculo + ' estan listos. Falta algo de tu parte? Coordinamos para cerrar'
                ];
            }

            if (msgs.length === 0) msgs = ['Hola ' + nombre + '! ' + resp + ' de FYRADRIVE. Como vas con lo del ' + vehiculo + '? Estoy al pendiente'];
            return msgs[Math.floor(Math.random() * msgs.length)];
        }

        var segCurrentIntencion = null;
        var segCurrentMensaje = '';

        // ===== GET CURRENT SUGGESTED ACTION based on elapsed time =====
        function getTimelineAction(c) {
            var timeline = SEG_TIMELINE[c.estado];
            if (!timeline) return null;
            var cambio = c.estadoCambio || c.created || Date.now();
            var horasTranscurridas = (Date.now() - cambio) / 3600000;
            var lastMsg = (c.mensajesEnviados && c.mensajesEnviados.length > 0) ? c.mensajesEnviados[c.mensajesEnviados.length - 1].fecha : 0;
            var horasDesdeUltimoMsg = lastMsg ? (Date.now() - lastMsg) / 3600000 : 9999;

            // Find the current action: the latest milestone we've passed
            var currentAction = null;
            for (var i = timeline.length - 1; i >= 0; i--) {
                if (horasTranscurridas >= timeline[i].horas) {
                    currentAction = timeline[i];
                    break;
                }
            }
            if (!currentAction && timeline.length > 0) currentAction = timeline[0];

            // Find next action (for countdown progress)
            var nextAction = null;
            for (var j = 0; j < timeline.length; j++) {
                if (horasTranscurridas < timeline[j].horas) { nextAction = timeline[j]; break; }
            }

            // Should alert? If >2hrs since last message sent
            var shouldAlert = horasDesdeUltimoMsg > 2 && currentAction;

            return { action: currentAction, next: nextAction, horas: horasTranscurridas, shouldAlert: shouldAlert };
        }

        function openSeguimiento(id) {
            segCurrentId = id;
            var c = compradores.find(function(x) { return x.id === id; });
            if (!c) return;

            document.getElementById('seg-overlay').classList.add('show');
            document.getElementById('seg-panel').classList.add('open');
            document.getElementById('seg-title').textContent = c.nombre + '  ' + c.vehiculo;

            renderSeguimiento(c);
            startCrono();
            startChatPolling();
        }

        function closeSeguimiento() {
            document.getElementById('seg-overlay').classList.remove('show');
            document.getElementById('seg-panel').classList.remove('open');
            segCurrentId = null;
            segCurrentIntencion = null;
            if (segCronoInterval) { clearInterval(segCronoInterval); segCronoInterval = null; }
            stopChatPolling();
        }

        function startCrono() {
            if (segCronoInterval) clearInterval(segCronoInterval);
            segCronoInterval = setInterval(function() {
                if (!segCurrentId) return;
                var c = compradores.find(function(x) { return x.id === segCurrentId; });
                if (!c) return;
                updateCrono(c);
            }, 1000);
        }

        function updateCrono(c) {
            var cambio = c.estadoCambio || c.created || Date.now();
            var elapsed = Date.now() - cambio;
            var d = Math.floor(elapsed / 86400000);
            var h = Math.floor((elapsed % 86400000) / 3600000);
            var m = Math.floor((elapsed % 3600000) / 60000);
            var s = Math.floor((elapsed % 60000) / 1000);

            var timeStr = (d > 0 ? d + 'd ' : '') +
                (h < 10 ? '0' : '') + h + ':' +
                (m < 10 ? '0' : '') + m + ':' +
                (s < 10 ? '0' : '') + s;

            document.getElementById('seg-crono-time').textContent = timeStr;

            var horas = elapsed / 3600000;
            var cls = horas < 12 ? 'fresh' : horas < 48 ? 'attention' : 'urgent';
            document.getElementById('seg-crono').className = 'seg-crono ' + cls;

            // Cita countdown sub-text
            var subText = '';
            if (c.estado === 'Cita Confirmada' && c.citaFecha) {
                var citaDate = new Date(c.citaFecha + 'T' + (c.citaHora || '12:00'));
                var diff = citaDate - new Date();
                if (diff > 0) {
                    var dd = Math.floor(diff / 86400000);
                    var hh = Math.floor((diff % 86400000) / 3600000);
                    subText = 'Faltan ' + (dd > 0 ? dd + 'd ' : '') + hh + 'h para la cita';
                } else { subText = 'LA CITA YA PASO'; }
            }
            document.getElementById('seg-crono-sub').textContent = subText;

            // Progress bar
            var tl = getTimelineAction(c);
            if (tl && tl.next) {
                var pct = Math.min(100, (horas / tl.next.horas) * 100);
                document.getElementById('seg-crono-fill').style.width = pct + '%';
            } else {
                document.getElementById('seg-crono-fill').style.width = '100%';
            }
        }

        function renderSeguimiento(c) {
            // State flow
            var flowHTML = '';
            var currentIdx = BUYER_STATES.indexOf(c.estado);
            if (currentIdx < 0) currentIdx = 0;
            BUYER_STATES.forEach(function(st, i) {
                var cls = i < currentIdx ? 'done' : i === currentIdx ? 'active' : '';
                flowHTML += '<div class="seg-state-dot ' + cls + '">' + st + '</div>';
            });
            document.getElementById('seg-flow').innerHTML = flowHTML;

            // Initial crono update
            updateCrono(c);
            document.getElementById('seg-crono-label').textContent = 'en ' + c.estado;

            // Timeline action & alert
            var tl = getTimelineAction(c);
            var alertSec = document.getElementById('seg-alerta-section');
            if (tl && tl.action && tl.shouldAlert) {
                alertSec.style.display = 'block';
                document.getElementById('seg-alerta-title-text').textContent = tl.action.alerta;
                document.getElementById('seg-alerta-desc').textContent = tl.action.desc;
            } else {
                alertSec.style.display = 'none';
            }

            // Token & security
            var showSecurity = ['En Camino','Llego al Lugar','En Cita'].includes(c.estado);
            document.getElementById('seg-token-section').style.display = showSecurity ? 'block' : 'none';
            document.getElementById('seg-panico-section').style.display = showSecurity ? 'block' : 'none';
            document.getElementById('seg-liveloc-section').style.display = c.estado === 'En Camino' ? 'block' : 'none';
            if (showSecurity) document.getElementById('seg-token-code').textContent = c.tokenSeguridad || '----';

            // Post-cita resultado
            var postcitaSec = document.getElementById('seg-postcita-section');
            if (c.estado === 'Post-Cita') {
                postcitaSec.style.display = 'block';
                var resultados = ['Lo va a pensar','Quiere credito','Quiere separar','Negociacion','No interesado'];
                document.getElementById('seg-postcita-btns').innerHTML = resultados.map(function(r) {
                    return '<button class="seg-postcita-btn ' + (c.postcita === r ? 'selected' : '') + '" onclick="setPostCitaResultado(\'' + r + '\')">' + r + '</button>';
                }).join('');
            } else { postcitaSec.style.display = 'none'; }

            // OPTIONS: show alternative message types based on time
            var opciones = [];
            var timeline = SEG_TIMELINE[c.estado] || [];
            var horas = (Date.now() - (c.estadoCambio || c.created || Date.now())) / 3600000;
            // Show the current + nearby options as chips
            timeline.forEach(function(t) {
                if (Math.abs(horas - t.horas) < t.horas * 1.5 || horas >= t.horas) {
                    opciones.push(t);
                }
            });
            // Also include from INTENCIONES as fallback
            var intenciones = INTENCIONES[c.estado] || [];

            var opcionesHTML = '';
            var activeType = (tl && tl.action) ? tl.action.tipo : (intenciones[0] ? intenciones[0].id : 'saludo');

            // Show timeline options + extra intenciones
            var allOps = [];
            opciones.forEach(function(o) { allOps.push({ id: o.tipo, label: o.alerta.split('  ').pop() || o.tipo.replace(/_/g,' ') }); });
            intenciones.forEach(function(int) {
                if (!allOps.find(function(x) { return x.id === int.id; })) {
                    allOps.push({ id: int.id, label: int.title });
                }
            });

            document.getElementById('seg-opciones').innerHTML = allOps.map(function(op) {
                return '<button class="seg-opcion-btn ' + (op.id === activeType ? 'active' : '') + '" onclick="selectOpcion(\'' + op.id + '\')">' + op.label + '</button>';
            }).join('');

            // Auto-generate the suggested message
            segCurrentIntencion = activeType;
            segCurrentMensaje = generarMensaje(c, activeType);
            document.getElementById('seg-mensaje-textarea').value = segCurrentMensaje;

            var msgLabel = 'Mensaje Sugerido';
            if (tl && tl.action) msgLabel = 'Sugerencia: ' + tl.action.alerta;
            document.getElementById('seg-msg-label').textContent = msgLabel;

            // Avanzar btn
            var nextIdx = currentIdx + 1;
            var avanzarBtn = document.getElementById('seg-btn-avanzar');
            if (nextIdx < BUYER_STATES.length && !['Vendido','Venta Fallida'].includes(c.estado)) {
                avanzarBtn.style.display = 'flex';
                avanzarBtn.innerHTML = 'Avanzar a: ' + BUYER_STATES[nextIdx] + ' &#10132;';
            } else { avanzarBtn.style.display = 'none'; }

            // Historial
            var histHTML = '';
            if (c.mensajesEnviados && c.mensajesEnviados.length > 0) {
                histHTML = c.mensajesEnviados.slice().reverse().slice(0, 10).map(function(m) {
                    var dt = new Date(m.fecha);
                    return '<div class="seg-historial-item"><div class="seg-hist-dot"></div><div>' +
                        '<div class="seg-hist-time">' + dt.toLocaleDateString('es-MX') + ' ' + dt.toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'}) + '  ' + (m.intencion||'').replace(/_/g,' ') + '</div>' +
                        '<div class="seg-hist-msg">' + (m.mensaje||'').substring(0,80) + '...</div></div></div>';
                }).join('');
            } else { histHTML = '<div style="font-size:12px;color:var(--gray);text-align:center;padding:12px;">Sin mensajes enviados aun</div>'; }
            document.getElementById('seg-historial').innerHTML = histHTML;
        }

        function selectOpcion(tipo) {
            var c = compradores.find(function(x) { return x.id === segCurrentId; });
            if (!c) return;
            segCurrentIntencion = tipo;
            segCurrentMensaje = generarMensaje(c, tipo);
            document.getElementById('seg-mensaje-textarea').value = segCurrentMensaje;
            // Update active chip
            document.querySelectorAll('.seg-opcion-btn').forEach(function(b) { b.classList.remove('active'); });
            if (event && event.target) event.target.classList.add('active');
        }

        function regenerarMensaje() {
            var c = compradores.find(function(x) { return x.id === segCurrentId; });
            if (!c || !segCurrentIntencion) return;
            segCurrentMensaje = generarMensaje(c, segCurrentIntencion);
            document.getElementById('seg-mensaje-textarea').value = segCurrentMensaje;
        }

        // Enviar DIRECTO por API (WhatsApp o Messenger segn contacto)
        function enviarWhatsAppAPI() {
            var c = compradores.find(function(x) { return x.id === segCurrentId; });
            if (!c) return;
            var msg = document.getElementById('seg-mensaje-textarea').value.trim();
            if (!msg) { showNotif('Escribe un mensaje', true); return; }
            var tel = c.telefono || c.telComprador || '';
            if (!tel) { showNotif('No tiene telefono registrado', true); return; }

            var isMessenger = tel.startsWith('fb_');
            var statusEl = document.getElementById('seg-wa-status');
            statusEl.style.display = 'block';
            statusEl.style.background = '#fff3cd';
            statusEl.style.color = '#856404';
            statusEl.textContent = ' Enviando mensaje directo...';

            var btnApi = document.getElementById('seg-btn-wa-api');
            btnApi.disabled = true;
            btnApi.textContent = ' Enviando...';

            var apiUrl = isMessenger ? '/api/messenger-send' : '/api/whatsapp';
            var bodyData = isMessenger
                ? { psid: tel, mensaje: msg, nombre: c.nombre }
                : { telefono: tel, mensaje: msg, nombre: c.nombre };

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': 'fyradrive2026' },
                body: JSON.stringify(bodyData)
            })
            .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
            .then(function(result) {
                btnApi.disabled = false;
                btnApi.textContent = ' Enviar Directo';
                if (result.ok && result.data.enviado) {
                    var viaLabel = isMessenger ? 'Messenger' : 'WhatsApp';
                    statusEl.style.background = '#d4edda';
                    statusEl.style.color = '#155724';
                    statusEl.textContent = ' Mensaje enviado directo por FYRADRIVE ' + viaLabel;
                    // Registrar en historial
                    if (!c.mensajesEnviados) c.mensajesEnviados = [];
                    c.mensajesEnviados.push({ fecha: Date.now(), intencion: segCurrentIntencion || 'manual', mensaje: msg, via: isMessenger ? 'messenger' : 'api', waId: result.data.mensaje_id || result.data.message_id });
                    c.updated = Date.now();
                    saveToCloud();
                    renderSeguimiento(c);
                    renderCompradores();
                    showNotif(' Mensaje enviado directo por ' + viaLabel);
                } else {
                    var errMsg = result.data.error || 'Error desconocido';
                    statusEl.style.background = '#f8d7da';
                    statusEl.style.color = '#721c24';
                    statusEl.textContent = ' Error: ' + errMsg;
                    showNotif('Error al enviar: ' + errMsg, true);
                }
                setTimeout(function() { statusEl.style.display = 'none'; }, 8000);
            })
            .catch(function(err) {
                btnApi.disabled = false;
                btnApi.textContent = ' Enviar Directo';
                statusEl.style.background = '#f8d7da';
                statusEl.style.color = '#721c24';
                statusEl.textContent = ' Error de conexion: ' + err.message;
                showNotif('Error de conexion', true);
                setTimeout(function() { statusEl.style.display = 'none'; }, 8000);
            });
        }

        // Enviar por wa.me (abre WhatsApp en otra ventana)  solo WhatsApp, para Messenger usa API directo
        function enviarWhatsApp() {
            var c = compradores.find(function(x) { return x.id === segCurrentId; });
            if (!c) return;
            var msg = document.getElementById('seg-mensaje-textarea').value.trim();
            if (!msg) { showNotif('Escribe un mensaje', true); return; }
            var tel = c.telefono || c.telComprador || '';
            if (!tel) { showNotif('No tiene telefono registrado', true); return; }
            // Messenger no tiene wa.me link  usar API directo
            if (tel.startsWith('fb_')) {
                showNotif('Contacto de Messenger  usa Enviar Directo', true);
                return;
            }
            var url = waLink(tel, msg);
            window.open(url, '_blank');

            if (!c.mensajesEnviados) c.mensajesEnviados = [];
            c.mensajesEnviados.push({ fecha: Date.now(), intencion: segCurrentIntencion || 'manual', mensaje: msg, via: 'wame' });
            c.updated = Date.now();
            saveToCloud();
            renderSeguimiento(c);
            renderCompradores();
            showNotif('WhatsApp abierto con el mensaje');
        }

        function copiarMensaje() {
            var msg = document.getElementById('seg-mensaje-textarea').value.trim();
            if (!msg) return;
            navigator.clipboard.writeText(msg).then(function() { showNotif('Mensaje copiado'); });
        }

        // ===== MINI CHAT WhatsApp =====
        var chatPollingInterval = null;

        function cargarChat() {
            var c = compradores.find(function(x) { return x.id === segCurrentId; });
            if (!c) return;
            var tel = c.telefono || c.telComprador || '';
            if (!tel) {
                document.getElementById('seg-chat-messages').innerHTML = '<div style="text-align:center;color:#888;font-size:12px;padding:20px;">Sin telefono registrado</div>';
                return;
            }

            // Detectar plataforma por prefijo fb_
            var isMessenger = tel.startsWith('fb_');
            var chatTitle = document.getElementById('seg-chat-title');
            if (chatTitle) chatTitle.textContent = isMessenger ? ' Chat Messenger' : ' Chat WhatsApp';

            fetch('/api/messages?telefono=' + encodeURIComponent(tel), {
                headers: { 'x-api-key': 'fyradrive2026' }
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                var container = document.getElementById('seg-chat-messages');
                if (!data.messages || data.messages.length === 0) {
                    container.innerHTML = '<div style="text-align:center;color:#888;font-size:12px;padding:20px;">No hay mensajes aun. Envia el primer mensaje!</div>';
                    return;
                }

                // Ordenar por timestamp ascendente
                var msgs = data.messages.sort(function(a, b) { return a.timestamp - b.timestamp; });
                var html = '';
                msgs.forEach(function(m) {
                    var isOut = m.direccion === 'out';
                    var isAI = m.ai_generated === 1 || m.ai_generated === '1';
                    var msgPlatform = m.platform || 'whatsapp';
                    var platformIcon = msgPlatform === 'messenger' ? '' : '';
                    var time = new Date(m.timestamp * 1000);
                    var timeStr = time.getHours() + ':' + (time.getMinutes() < 10 ? '0' : '') + time.getMinutes();
                    var align = isOut ? 'flex-end' : 'flex-start';
                    var bg = isOut ? (isAI ? '#e0f2fe' : '#dcf8c6') : '#fff';
                    var label = isOut ? (isAI ? ' FYRA-IA' : 'FYRADRIVE') : (platformIcon + ' ' + (m.nombre || m.telefono));
                    var labelColor = isOut ? (isAI ? '#0369a1' : '#128c7e') : '#e74c3c';

                    html += '<div style="align-self:' + align + ';max-width:80%;background:' + bg + ';padding:6px 10px;border-radius:8px;box-shadow:0 1px 1px rgba(0,0,0,0.1);">';
                    html += '<div style="font-size:10px;color:' + labelColor + ';font-weight:bold;margin-bottom:2px;">' + label + '</div>';
                    html += '<div style="font-size:13px;word-break:break-word;">' + m.mensaje + '</div>';
                    html += '<div style="font-size:9px;color:#999;text-align:right;margin-top:2px;">' + timeStr + '</div>';
                    html += '</div>';
                });
                container.innerHTML = html;

                // Auto scroll al final
                var chatContainer = document.getElementById('seg-chat-container');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            })
            .catch(function(err) {
                console.error('Error cargando chat:', err);
            });
        }

        function enviarChatDirecto() {
            var c = compradores.find(function(x) { return x.id === segCurrentId; });
            if (!c) return;
            var input = document.getElementById('seg-chat-input');
            var msg = input.value.trim();
            if (!msg) return;
            var tel = c.telefono || c.telComprador || '';
            if (!tel) { showNotif('No tiene telefono registrado', true); return; }

            input.disabled = true;
            input.value = 'Enviando...';

            // Detectar plataforma: fb_ = Messenger, otro = WhatsApp
            var isMessenger = tel.startsWith('fb_');
            var apiUrl = isMessenger ? '/api/messenger-send' : '/api/whatsapp';
            var bodyData = isMessenger
                ? { psid: tel, mensaje: msg, nombre: c.nombre }
                : { telefono: tel, mensaje: msg, nombre: c.nombre };

            fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': 'fyradrive2026' },
                body: JSON.stringify(bodyData)
            })
            .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
            .then(function(result) {
                input.disabled = false;
                if (result.ok && result.data.enviado) {
                    input.value = '';
                    // Agregar mensaje al chat visualmente de inmediato
                    var container = document.getElementById('seg-chat-messages');
                    var noMsg = container.querySelector('div[style*="text-align:center"]');
                    if (noMsg && noMsg.textContent.includes('No hay')) container.innerHTML = '';
                    var now = new Date();
                    var timeStr = now.getHours() + ':' + (now.getMinutes() < 10 ? '0' : '') + now.getMinutes();
                    var div = document.createElement('div');
                    div.style.cssText = 'align-self:flex-end;max-width:80%;background:#dcf8c6;padding:6px 10px;border-radius:8px;box-shadow:0 1px 1px rgba(0,0,0,0.1);';
                    div.innerHTML = '<div style="font-size:10px;color:#128c7e;font-weight:bold;margin-bottom:2px;">FYRADRIVE</div><div style="font-size:13px;word-break:break-word;">' + msg + '</div><div style="font-size:9px;color:#999;text-align:right;margin-top:2px;">' + timeStr + ' </div>';
                    container.appendChild(div);
                    var chatContainer = document.getElementById('seg-chat-container');
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    showNotif(isMessenger ? ' Mensaje enviado por Messenger' : ' Mensaje enviado por WhatsApp');
                } else {
                    input.value = msg;
                    showNotif('Error: ' + (result.data.error || 'No enviado'), true);
                }
            })
            .catch(function(err) {
                input.disabled = false;
                input.value = msg;
                showNotif('Error de conexion', true);
            });
        }

        // Iniciar polling de chat cada 10 segundos cuando el panel esta abierto
        function startChatPolling() {
            if (chatPollingInterval) clearInterval(chatPollingInterval);
            cargarChat();
            chatPollingInterval = setInterval(cargarChat, 10000);
        }

        function stopChatPolling() {
            if (chatPollingInterval) {
                clearInterval(chatPollingInterval);
                chatPollingInterval = null;
            }
        }

        // ===== CRM ALERT SYSTEM: check all compradores every 30s =====
        function checkCRMAlerts() {
            var alertEl = document.getElementById('seg-crm-alert');
            var alertText = document.getElementById('seg-crm-alert-text');
            var foundAlert = null;

            compradores.forEach(function(c) {
                if (['Vendido','Venta Fallida','En Camino','Llego al Lugar','En Cita'].includes(c.estado)) return;
                var tl = getTimelineAction(c);
                if (tl && tl.action && tl.shouldAlert) {
                    var key = c.id + '_' + tl.action.tipo;
                    // Only alert once per action per comprador per session unless >4hrs
                    if (!segAlertShownFor[key] || (Date.now() - segAlertShownFor[key]) > 14400000) {
                        foundAlert = { comprador: c, action: tl.action };
                    }
                }
            });

            if (foundAlert && !segCurrentId) {
                alertText.textContent = foundAlert.comprador.nombre + ': ' + foundAlert.action.alerta;
                alertEl.classList.add('show');
                alertEl.dataset.compradorId = foundAlert.comprador.id;
                segAlertShownFor[foundAlert.comprador.id + '_' + foundAlert.action.tipo] = Date.now();
            } else if (!foundAlert) {
                alertEl.classList.remove('show');
            }
        }

        function handleCRMAlert() {
            var alertEl = document.getElementById('seg-crm-alert');
            var id = alertEl.dataset.compradorId;
            alertEl.classList.remove('show');
            if (id) openSeguimiento(id);
        }

        // Start alert checker
        setInterval(checkCRMAlerts, 30000);
        setTimeout(checkCRMAlerts, 5000); // first check after 5s

        function avanzarEstado() {
            var c = compradores.find(function(x) { return x.id === segCurrentId; });
            if (!c) return;
            var idx = BUYER_STATES.indexOf(c.estado);
            if (idx < 0 || idx >= BUYER_STATES.length - 1) return;

            var nextState = BUYER_STATES[idx + 1];
            if (!confirm('Avanzar a "' + nextState + '"?')) return;

            c.estado = nextState;
            c.estadoCambio = Date.now();
            c.updated = Date.now();

            // Generate token when entering En Camino
            if (nextState === 'En Camino' && !c.tokenSeguridad) {
                c.tokenSeguridad = String(Math.floor(1000 + Math.random() * 9000));
            }

            saveToCloud();
            renderCompradores();
            updateStats();
            renderSeguimiento(c);
            showNotif('Estado cambiado a: ' + nextState);
        }

        function setPostCitaResultado(resultado) {
            var c = compradores.find(function(x) { return x.id === segCurrentId; });
            if (!c) return;
            c.postcita = resultado;
            c.updated = Date.now();
            saveToCloud();
            renderSeguimiento(c);
            showNotif('Resultado: ' + resultado);
        }

        function activarPanico() {
            var c = compradores.find(function(x) { return x.id === segCurrentId; });
            if (!c) return;
            if (!confirm('ACTIVAR ALERTA DE PANICO? Se enviara mensaje de emergencia por WhatsApp')) return;

            var tel = c.telResponsable || c.telefono || '';
            if (!tel) { showNotif('No hay telefono de responsable', true); return; }
            var msg = 'ALERTA DE PANICO FYRADRIVE\nComprador: ' + c.nombre + '\nVehiculo: ' + c.vehiculo + '\nEstado: ' + c.estado + '\nToken: ' + (c.tokenSeguridad || 'N/A') + '\nACCION INMEDIATA REQUERIDA';
            var url = waLink(tel, msg);
            window.open(url, '_blank');
            showNotif('ALERTA DE PANICO ACTIVADA', true);
        }

        function compartirUbicacion() {
            var c = compradores.find(function(x) { return x.id === segCurrentId; });
            if (!c) return;
            var tel = c.telDueno || c.telComprador || c.telefono || '';
            if (!tel) { showNotif('No hay telefono para compartir', true); return; }
            var url = waLink(tel, 'Te comparto mi ubicacion en vivo para la cita del ' + c.vehiculo + '. Token de seguridad: ' + (c.tokenSeguridad || 'N/A'));
            window.open(url, '_blank');
            showNotif('Abre WhatsApp y comparte tu ubicacion en vivo');
        }

        // ==========================================
        //  BOLA MGICA FUNCTIONS
        // ==========================================
        var bmPollingInterval = null;

        function startBMPolling() {
            if (bmPollingInterval) clearInterval(bmPollingInterval);
            cargarBolaMagica();
            cargarAIConfig();
            bmPollingInterval = setInterval(cargarBolaMagica, 5000);
        }

        function stopBMPolling() {
            if (bmPollingInterval) {
                clearInterval(bmPollingInterval);
                bmPollingInterval = null;
            }
        }

        // ===== AI CONFIG FUNCTIONS =====
        function cargarAIConfig() {
            fetch('/api/ai-config', { headers: { 'x-api-key': 'fyradrive2026' } })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.config) {
                    var doc = document.getElementById('ai-sales-doc');
                    if (doc) doc.value = data.config.sales_document || '';
                    var btn = document.getElementById('ai-toggle-btn');
                    if (btn) {
                        var enabled = data.config.ai_enabled;
                        btn.textContent = enabled ? ' ACTIVO' : ' DESACTIVADO';
                        btn.style.background = enabled ? '#d4edda' : '#f8d7da';
                        btn.style.color = enabled ? '#155724' : '#721c24';
                    }
                }
            })
            .catch(function(err) {
                console.error('Error cargando AI config:', err);
            });
        }

        function toggleAI() {
            var btn = document.getElementById('ai-toggle-btn');
            var currentlyActive = btn.textContent.includes('ACTIVO');
            var newState = currentlyActive ? 0 : 1;
            btn.textContent = '...';
            fetch('/api/ai-config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'x-api-key': 'fyradrive2026' },
                body: JSON.stringify({ ai_enabled: newState })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.ok) {
                    btn.textContent = newState ? ' ACTIVO' : ' DESACTIVADO';
                    btn.style.background = newState ? '#d4edda' : '#f8d7da';
                    btn.style.color = newState ? '#155724' : '#721c24';
                    showNotif(newState ? ' IA activada' : ' IA desactivada');
                }
            })
            .catch(function() { btn.textContent = ' Error'; });
        }

        // ===== DRAG & DROP PARA ARCHIVOS IA =====
        (function() {
            document.addEventListener('DOMContentLoaded', function() {
                var dropZone = document.getElementById('ai-drop-zone');
                if (!dropZone) return;
                var overlay = document.getElementById('ai-drop-overlay');
                var dragCounter = 0;

                dropZone.addEventListener('dragenter', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dragCounter++;
                    dropZone.style.borderColor = 'var(--cyan)';
                    dropZone.style.background = 'rgba(8,145,178,0.03)';
                    overlay.style.display = 'flex';
                });

                dropZone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dragCounter--;
                    if (dragCounter <= 0) {
                        dragCounter = 0;
                        dropZone.style.borderColor = 'var(--border)';
                        dropZone.style.background = '';
                        overlay.style.display = 'none';
                    }
                });

                dropZone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                });

                dropZone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dragCounter = 0;
                    dropZone.style.borderColor = 'var(--border)';
                    dropZone.style.background = '';
                    overlay.style.display = 'none';

                    var files = e.dataTransfer.files;
                    if (files.length > 0) {
                        procesarArchivoDrop(files[0]);
                    }
                });
            });
        })();

        function procesarArchivoDrop(file) {
            var fakeInput = { files: [file], value: 'drop' };
            cargarArchivoAI(fakeInput);
        }

        function cargarArchivoAI(input) {
            if (!input.files || !input.files[0]) return;
            var file = input.files[0];
            var statusEl = document.getElementById('ai-config-status');
            var maxSize = 5 * 1024 * 1024; // 5MB max

            if (file.size > maxSize) {
                showNotif('Archivo muy grande (max 5MB)', true);
                input.value = '';
                return;
            }

            statusEl.textContent = ' Leyendo ' + file.name + '...';

            // PDF: usar pdf.js para extraer texto
            if (file.name.toLowerCase().endsWith('.pdf')) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var typedarray = new Uint8Array(e.target.result);
                    if (typeof pdfjsLib === 'undefined') {
                        // Cargar pdf.js dinmicamente
                        var script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                        script.onload = function() {
                            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                            extraerTextoPDF(typedarray, file.name, statusEl);
                        };
                        document.head.appendChild(script);
                    } else {
                        extraerTextoPDF(typedarray, file.name, statusEl);
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // TXT, CSV, MD, DOC: leer como texto
                var reader = new FileReader();
                reader.onload = function(e) {
                    var contenido = e.target.result;
                    var doc = document.getElementById('ai-sales-doc');
                    var existing = doc.value.trim();
                    doc.value = existing ? existing + '\n\n--- ' + file.name + ' ---\n' + contenido : contenido;
                    statusEl.textContent = ' ' + file.name + ' cargado (' + contenido.length + ' caracteres)';
                    showNotif(' Archivo cargado: ' + file.name + '. Dale Guardar para aplicar.');
                    setTimeout(function() { statusEl.textContent = ''; }, 5000);
                };
                reader.onerror = function() {
                    statusEl.textContent = ' Error leyendo archivo';
                    showNotif('Error al leer el archivo', true);
                };
                reader.readAsText(file);
            }
            input.value = '';
        }

        function extraerTextoPDF(typedarray, filename, statusEl) {
            pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                var totalPages = pdf.numPages;
                var textoCompleto = '';
                var pagesProcessed = 0;
                statusEl.textContent = ' Extrayendo texto de ' + totalPages + ' pginas...';

                for (var i = 1; i <= totalPages; i++) {
                    pdf.getPage(i).then(function(page) {
                        page.getTextContent().then(function(textContent) {
                            var pageText = textContent.items.map(function(item) { return item.str; }).join(' ');
                            textoCompleto += pageText + '\n';
                            pagesProcessed++;

                            if (pagesProcessed === totalPages) {
                                var doc = document.getElementById('ai-sales-doc');
                                var existing = doc.value.trim();
                                doc.value = existing ? existing + '\n\n--- ' + filename + ' ---\n' + textoCompleto : textoCompleto;
                                statusEl.textContent = ' ' + filename + ' cargado (' + textoCompleto.length + ' chars, ' + totalPages + ' pginas)';
                                showNotif(' PDF cargado: ' + filename + '. Dale Guardar para aplicar.');
                                setTimeout(function() { statusEl.textContent = ''; }, 5000);
                            }
                        });
                    });
                }
            }).catch(function(err) {
                statusEl.textContent = ' Error leyendo PDF';
                showNotif('Error al leer PDF: ' + err.message, true);
            });
        }

        function guardarAIConfig() {
            var doc = document.getElementById('ai-sales-doc').value;
            var statusEl = document.getElementById('ai-config-status');
            statusEl.textContent = ' Guardando...';
            fetch('/api/ai-config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'x-api-key': 'fyradrive2026' },
                body: JSON.stringify({ sales_document: doc })
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.ok) {
                    statusEl.textContent = ' Guardado';
                    showNotif(' Documento de ventas guardado');
                    setTimeout(function() { statusEl.textContent = ''; }, 3000);
                } else {
                    statusEl.textContent = ' Error';
                }
            })
            .catch(function() { statusEl.textContent = ' Error de conexin'; });
        }

        function cargarBolaMagica() {
            var periodo = document.getElementById('bm-periodo').value;
            fetch('/api/bola-magica?periodo=' + periodo, {
                headers: { 'x-api-key': 'fyradrive2026' }
            })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                if (!res.ok || !res.data) return;
                var d = res.data;
                var m = d.metricas;

                // Mtricas duras
                document.getElementById('bm-total-convs').textContent = m.conversaciones_total;
                document.getElementById('bm-cotizaciones').textContent = m.llegaron_cotizacion;
                document.getElementById('bm-completadas').textContent = m.completaron_cotizacion;
                document.getElementById('bm-tasa-cot').textContent = m.tasa_cotizacion + '% de conversaciones';
                document.getElementById('bm-tasa-comp').textContent = m.tasa_completado + '% de los que pidieron';
                document.getElementById('bm-seriedad').textContent = d.emocional.seriedad_promedio || '';
                var seriedadEl = document.getElementById('bm-seriedad');
                var sp = d.emocional.seriedad_promedio;
                seriedadEl.style.color = sp >= 7 ? 'var(--green)' : sp >= 4 ? 'var(--orange)' : 'var(--red)';

                // Emociones
                var emoHtml = '';
                var emoEmojis = { interes: '', miedo: '', duda: '', entusiasmo: '', desconfianza: '', frustracion: '', urgencia: '', indiferencia: '' };
                d.emocional.emociones.forEach(function(e) {
                    emoHtml += '<div>' + (emoEmojis[e.nombre] || '') + ' <strong>' + e.nombre + '</strong>  ' + e.total + ' veces</div>';
                });
                document.getElementById('bm-emociones').innerHTML = emoHtml || '<em style="color:var(--gray)">Sin datos an</em>';

                // Miedos
                var miedoHtml = '';
                var miedoEmojis = { financiero: '', compromiso: '', 'engao': '', rechazo: '', familiar: '', ninguno: '' };
                d.emocional.miedos.forEach(function(e) {
                    miedoHtml += '<div>' + (miedoEmojis[e.nombre] || '') + ' <strong>' + e.nombre + '</strong>  ' + e.total + ' veces</div>';
                });
                document.getElementById('bm-miedos').innerHTML = miedoHtml || '<em style="color:var(--gray)">Sin datos an</em>';

                // Deseos
                var deseoHtml = '';
                var deseoEmojis = { auto: '', estatus: '', solucion_transporte: '', independencia: '', mejor_vida: '', ninguno: '' };
                d.emocional.deseos.forEach(function(e) {
                    deseoHtml += '<div>' + (deseoEmojis[e.nombre] || '') + ' <strong>' + e.nombre + '</strong>  ' + e.total + ' veces</div>';
                });
                document.getElementById('bm-deseos').innerHTML = deseoHtml || '<em style="color:var(--gray)">Sin datos an</em>';

                // Seales
                var senalHtml = '';
                var senalEmojis = { compra: '', abandono: '', neutral: '' };
                var senalLabels = { compra: 'Seales de compra', abandono: 'Seales de abandono', neutral: 'Neutrales' };
                d.emocional.senales.forEach(function(e) {
                    senalHtml += '<div>' + (senalEmojis[e.tipo] || '') + ' <strong>' + (senalLabels[e.tipo] || e.tipo) + '</strong>  ' + e.total + '</div>';
                });
                document.getElementById('bm-senales').innerHTML = senalHtml || '<em style="color:var(--gray)">Sin datos an</em>';

                // Intenciones
                var intHtml = '';
                var intEmojis = { informarse: '', negociar: '', cerrar: '', huir: '', validar: '', comparar: '' };
                d.emocional.intenciones.forEach(function(e) {
                    intHtml += '<div>' + (intEmojis[e.nombre] || '') + ' <strong>' + e.nombre + '</strong>  ' + e.total + '</div>';
                });
                document.getElementById('bm-intenciones').innerHTML = intHtml || '<em style="color:var(--gray)">Sin datos an</em>';

                // ltimos anlisis IA
                var anaHtml = '';
                d.ultimos_analisis.forEach(function(a) {
                    var serColor = a.seriedad >= 7 ? '#10b981' : a.seriedad >= 4 ? '#f59e0b' : '#ef4444';
                    anaHtml += '<div style="padding:12px;margin-bottom:8px;border-radius:8px;background:#f9fafb;border-left:4px solid ' + serColor + ';">';
                    anaHtml += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">';
                    anaHtml += '<strong style="font-size:12px;"> ' + (a.telefono || 'Desconocido') + '</strong>';
                    anaHtml += '<span style="font-size:11px;background:' + serColor + '22;color:' + serColor + ';padding:2px 8px;border-radius:12px;font-weight:700;">Seriedad: ' + a.seriedad + '/10</span>';
                    anaHtml += '</div>';
                    anaHtml += '<div style="font-size:13px;color:#374151;margin-bottom:6px;">"' + a.mensaje + '"</div>';
                    anaHtml += '<div style="font-size:12px;color:#6b7280;margin-bottom:4px;"> ' + a.resumen + '</div>';
                    anaHtml += '<div style="font-size:12px;color:var(--purple);font-weight:600;"> ' + a.sugerencia + '</div>';
                    anaHtml += '</div>';
                });
                document.getElementById('bm-analisis').innerHTML = anaHtml || '<em style="color:var(--gray)">Cuando lleguen mensajes de clientes, aqu vers el anlisis emocional de cada uno</em>';

                // Intuiciones
                renderIntuiciones(d.intuiciones);
            })
            .catch(function(err) {
                console.error('Error cargando Bola Mgica:', err);
            });
        }

        function renderIntuiciones(lista) {
            var html = '';
            if (lista && lista.length > 0) {
                var tipoEmojis = { general: '', cliente: '', mercado: '', objecion: '', cierre: '', producto: '' };
                lista.forEach(function(i) {
                    var fecha = new Date(i.fecha || Date.now());
                    var fechaStr = fecha.toLocaleDateString('es-MX', { day: 'numeric', month: 'short' });
                    html += '<div style="padding:8px 12px;margin-bottom:6px;border-radius:8px;background:white;border:1px solid #e5e7eb;font-size:13px;">';
                    html += '<span>' + (tipoEmojis[i.tipo] || '') + '</span> ';
                    html += '<strong style="color:var(--purple);">' + i.texto + '</strong>';
                    if (i.telefono) html += ' <span style="color:var(--gray);font-size:11px;">(' + i.telefono + ')</span>';
                    html += ' <span style="color:var(--gray-light);font-size:10px;float:right;">' + fechaStr + '</span>';
                    html += '</div>';
                });
            }
            document.getElementById('intuiciones-lista').innerHTML = html || '<em style="color:var(--gray);font-size:12px;">Tus intuiciones aparecern aqu...</em>';
        }

        function guardarIntuicion() {
            var texto = document.getElementById('intuicion-texto').value.trim();
            if (!texto) { showNotif('Escribe algo primero', true); return; }

            var tipo = document.getElementById('intuicion-tipo').value;
            var telefono = document.getElementById('intuicion-telefono').value.trim();

            fetch('/api/intuiciones', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': 'fyradrive2026' },
                body: JSON.stringify({ texto: texto, tipo: tipo, telefono: telefono })
            })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                if (res.ok) {
                    showNotif(' Intuicin guardada');
                    document.getElementById('intuicion-texto').value = '';
                    document.getElementById('intuicion-telefono').value = '';
                    cargarBolaMagica();
                } else {
                    showNotif('Error guardando', true);
                }
            })
            .catch(function() { showNotif('Error de conexin', true); });
        }

        function generarLicuadora() {
            var btn = event.target;
            btn.disabled = true;
            btn.textContent = ' Generando reporte...';
            document.getElementById('bm-licuadora').innerHTML = '<em style="color:var(--gray);">La IA est analizando todos los datos de la semana... Esto toma 15-30 segundos.</em>';

            fetch('/api/bola-magica', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': 'fyradrive2026' }
            })
            .then(function(r) { return r.json(); })
            .then(function(res) {
                btn.disabled = false;
                btn.textContent = ' Generar Licuadora Semanal';
                if (res.ok && res.reporte) {
                    document.getElementById('bm-licuadora').textContent = res.reporte;
                    showNotif(' Licuadora Semanal generada');
                } else {
                    document.getElementById('bm-licuadora').innerHTML = '<em style="color:var(--red);">Error generando reporte: ' + (res.error || 'Intenta de nuevo') + '</em>';
                }
            })
            .catch(function(err) {
                btn.disabled = false;
                btn.textContent = ' Generar Licuadora Semanal';
                document.getElementById('bm-licuadora').innerHTML = '<em style="color:var(--red);">Error de conexin</em>';
            });
        }

        // ==========================================
        // INIT
        // ==========================================
        document.getElementById('user-name-display').textContent = currentUser;
        startPolling();
    </script>

</body>
</html>
