<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAW - FyraDrive</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#09090b;--s1:#111113;--s2:#18181b;--s3:#222225;
            --b1:#27272a;--b2:#3f3f46;
            --t1:#fafafa;--t2:#a1a1aa;--t3:#71717a;
            --green:#22c55e;--green2:#16a34a;--green-bg:rgba(34,197,94,.1);
            --orange:#f59e0b;--orange-bg:rgba(245,158,11,.1);
            --red:#ef4444;--red-bg:rgba(239,68,68,.1);
            --blue:#3b82f6;--blue-bg:rgba(59,130,246,.1);
            --purple:#a855f7;--purple-bg:rgba(168,85,247,.1);
            --cyan:#06b6d4;--cyan-bg:rgba(6,182,212,.1);
        }
        body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh;overflow-x:hidden}

        /* ===== TOPBAR ===== */
        .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:var(--s1);border-bottom:1px solid var(--b1);position:sticky;top:0;z-index:100}
        .top-left{display:flex;align-items:center;gap:10px}
        .logo{font-size:15px;font-weight:900;letter-spacing:-.5px}
        .logo em{font-style:normal;color:var(--green)}
        .dot{width:7px;height:7px;border-radius:50%;background:var(--green);animation:blink 2s infinite}
        .dot.off{background:var(--red);animation:none}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
        .top-right{display:flex;gap:8px;align-items:center}
        .pill{font-size:10px;font-weight:600;padding:3px 8px;border-radius:10px;background:var(--s2);color:var(--t2)}

        /* ===== NAV ===== */
        .nav{display:flex;gap:0;background:var(--s1);border-bottom:1px solid var(--b1);padding:0 20px;overflow-x:auto}
        .nav-item{padding:10px 16px;font-size:12px;font-weight:600;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:.15s}
        .nav-item:hover{color:var(--t2)}
        .nav-item.on{color:var(--green);border-color:var(--green)}
        .badge{font-size:10px;padding:1px 6px;border-radius:8px;background:var(--s3);margin-left:5px}

        /* ===== LAYOUT ===== */
        .page{display:none;padding:16px 20px;max-width:1400px;margin:0 auto}
        .page.on{display:block}

        /* ===== PIPELINE (funnel visual) ===== */
        .pipeline{display:flex;gap:12px;overflow-x:auto;padding-bottom:12px}
        .pipe-col{min-width:280px;flex:1;background:var(--s1);border:1px solid var(--b1);border-radius:10px;max-height:calc(100vh - 150px);display:flex;flex-direction:column}
        .pipe-head{padding:10px 12px;border-bottom:1px solid var(--b1);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--s1);border-radius:10px 10px 0 0}
        .pipe-title{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
        .pipe-count{font-size:11px;color:var(--t3);font-weight:600}
        .pipe-body{padding:8px;overflow-y:auto;flex:1}

        /* ===== CONTACT CARD ===== */
        .cc{background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px;margin-bottom:8px;cursor:pointer;transition:.15s}
        .cc:hover{border-color:var(--green)}
        .cc-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
        .cc-name{font-size:13px;font-weight:700}
        .cc-tag{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;text-transform:uppercase;letter-spacing:.3px}
        .tag-vendedor{background:var(--purple-bg);color:var(--purple)}
        .tag-comprador{background:var(--blue-bg);color:var(--blue)}
        .cc-tel{font-size:11px;color:var(--t3);margin-bottom:4px}
        .cc-tel a{color:var(--green);text-decoration:none}
        .cc-interest{font-size:11px;color:var(--t2);padding:4px 8px;background:var(--s3);border-radius:4px;margin-bottom:6px}
        .cc-bottom{display:flex;justify-content:space-between;align-items:center}
        .cc-time{font-size:10px;color:var(--t3)}
        .cc-signal{font-size:9px;font-weight:600;padding:2px 6px;border-radius:4px}
        .sig-hot{background:var(--red-bg);color:var(--red)}
        .sig-warm{background:var(--orange-bg);color:var(--orange)}
        .sig-cold{background:var(--blue-bg);color:var(--blue)}
        .cc-notes{font-size:10px;color:var(--t3);margin-top:6px;padding-top:6px;border-top:1px solid var(--b1)}
        .cc-photos{display:flex;gap:2px;margin-top:4px}
        .cc-photos span{font-size:10px;color:var(--green)}

        /* ===== CITA SEGURA ===== */
        .deal-card{background:var(--s2);border:1px solid var(--b1);border-radius:8px;padding:10px;margin-bottom:8px;transition:.15s}
        .deal-card:hover{border-color:var(--green)}
        .deal-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
        .deal-name{font-size:13px;font-weight:700}
        .deal-auto{font-size:11px;color:var(--t2);margin-bottom:4px}
        .deal-tel{font-size:11px;color:var(--t3);margin-bottom:6px}
        .deal-tel a{color:var(--green);text-decoration:none}
        .deal-cd{font-size:20px;font-weight:800;text-align:center;padding:8px;background:var(--s3);border-radius:6px;margin-bottom:8px;letter-spacing:-.5px}
        .deal-cd.soon{color:var(--orange)}
        .deal-cd.now{color:var(--green);animation:blink 1s infinite}
        .deal-cd.past{color:var(--red)}
        .deal-fecha{font-size:10px;color:var(--t3);text-align:center;margin-bottom:8px}
        .deal-lugar{font-size:10px;color:var(--t2);margin-bottom:6px;padding:4px 8px;background:var(--s3);border-radius:4px}
        .deal-draft{background:var(--s1);border:1px solid var(--b1);border-radius:6px;padding:8px;margin-bottom:8px}
        .deal-draft-label{font-size:9px;font-weight:700;text-transform:uppercase;color:var(--t3);margin-bottom:4px;display:flex;align-items:center;gap:4px}
        .deal-draft-ta{width:100%;padding:6px;background:var(--s2);border:1px solid var(--b1);border-radius:4px;color:var(--t1);font-family:inherit;font-size:11px;resize:vertical;min-height:40px}
        .deal-draft-ta:focus{outline:none;border-color:var(--green)}
        .deal-btns{display:flex;gap:4px;flex-wrap:wrap}
        .deal-btns .btn{font-size:10px;padding:4px 8px}
        .deal-source{font-size:9px;font-weight:600;padding:2px 6px;border-radius:4px}
        .src-wa{background:var(--green-bg);color:var(--green)}
        .src-msg{background:var(--blue-bg);color:var(--blue)}
        .deal-notas{font-size:10px;color:var(--t3);margin-top:6px;padding-top:6px;border-top:1px solid var(--b1)}
        .cs-state-btn{font-size:10px;padding:4px 10px;border-radius:4px;border:1px solid var(--b1);background:var(--s2);color:var(--t3);cursor:pointer;transition:.15s}
        .cs-state-btn:hover{border-color:var(--green);color:var(--t1)}
        .cs-state-btn.active{border-color:var(--green);color:var(--green);font-weight:700}

        /* ===== BUTTONS ===== */
        .btn{padding:7px 14px;border-radius:6px;font-size:11px;font-weight:600;border:none;cursor:pointer;transition:.15s}
        .btn-g{background:var(--green);color:#000}
        .btn-g:hover{background:var(--green2)}
        .btn-o{background:var(--orange);color:#000}
        .btn-r{background:var(--red-bg);color:var(--red);border:1px solid rgba(239,68,68,.2)}
        .btn-x{background:var(--s2);color:var(--t2);border:1px solid var(--b1)}
        .btn-x:hover{border-color:var(--green);color:var(--t1)}

        /* ===== BOSS PANEL ===== */
        .boss{background:var(--s1);border:1px solid var(--b1);border-radius:10px;padding:16px;margin-bottom:14px}
        .boss h3{font-size:13px;font-weight:700;margin-bottom:10px}
        .boss h3 em{font-style:normal;color:var(--orange)}
        .boss-ta{width:100%;padding:10px;background:var(--s2);border:1px solid var(--b1);border-radius:6px;color:var(--t1);font-family:inherit;font-size:12px;resize:vertical}
        .boss-ta:focus{outline:none;border-color:var(--green)}
        .boss-row{display:flex;gap:6px;margin-top:8px;align-items:center;flex-wrap:wrap}
        .boss-quick{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
        .boss-status{font-size:11px;color:var(--t3)}

        /* ===== EMPTY ===== */
        .empty{text-align:center;padding:50px 20px;color:var(--t3)}
        .empty-i{font-size:40px;margin-bottom:8px}
        .empty-t{font-size:13px}

        /* ===== TOAST ===== */
        .toast{position:fixed;bottom:16px;right:16px;padding:10px 18px;background:var(--green);color:#000;font-weight:600;font-size:12px;border-radius:6px;z-index:9999;transform:translateY(80px);transition:.3s;box-shadow:0 4px 20px rgba(34,197,94,.3)}
        .toast.on{transform:translateY(0)}

        /* ===== DETAIL MODAL ===== */
        .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
        .modal-bg.on{display:flex}
        .modal{background:var(--s1);border:1px solid var(--b1);border-radius:12px;width:100%;max-width:480px;max-height:85vh;overflow-y:auto;padding:20px}
        .modal-close{float:right;background:none;border:none;color:var(--t3);font-size:18px;cursor:pointer}
        .modal h2{font-size:16px;font-weight:800;margin-bottom:12px}
        .modal-section{margin-bottom:14px}
        .modal-label{font-size:10px;color:var(--t3);text-transform:uppercase;font-weight:700;margin-bottom:4px}
        .modal-val{font-size:13px;color:var(--t1)}
        .modal-history{max-height:200px;overflow-y:auto}
        .modal-msg{padding:6px 0;border-bottom:1px solid var(--b1);font-size:12px}
        .modal-msg .dir{font-size:10px;font-weight:600;color:var(--green)}
        .modal-msg .dir.in{color:var(--blue)}

        @media(max-width:768px){
            .pipeline{flex-direction:column}
            .pipe-col{min-width:auto;max-height:none}
            .deal-btns{flex-direction:column}
            .topbar{flex-wrap:wrap}
        }
    </style>
</head>
<body>

<div class="topbar">
    <div class="top-left">
        <div class="dot" id="dot"></div>
        <div class="logo">CLAW <em>FYRADRIVE</em></div>
    </div>
    <div class="top-right">
        <span class="pill" id="pVer">v9</span>
        <span class="pill" id="pTools">12</span>
        <span class="pill" id="pIn">0 in</span>
        <span class="pill" id="pOut">0 out</span>
    </div>
</div>

<div class="nav">
    <div class="nav-item on" data-p="pipeline">Pipeline<span class="badge" id="bPipe">0</span></div>
    <div class="nav-item" data-p="citasegura">Cita Segura<span class="badge" id="bCitaSeg">0</span></div>
    <div class="nav-item" data-p="boss">Boss Mode</div>
    <div class="nav-item" data-p="log">Actividad</div>
</div>

<!-- ===== PIPELINE ===== -->
<div class="page on" id="p-pipeline">
    <div class="pipeline" id="pipelineView"></div>
</div>

<!-- ===== CITA SEGURA ===== -->
<div class="page" id="p-citasegura">
    <div class="pipeline" id="citaSeguraView"></div>
    <div class="empty" id="emptyCS" style="display:none"><div class="empty-i">üîí</div><div class="empty-t">No hay deals en pipeline de citas</div></div>
</div>

<!-- ===== BOSS ===== -->
<div class="page" id="p-boss">
    <div class="boss">
        <h3>‚ö° <em>Orden directa</em> a Claw</h3>
        <p style="font-size:11px;color:var(--t3);margin-bottom:8px">Escribe como si le hablaras por WhatsApp. Claw lo recibe como instruccion.</p>
        <textarea class="boss-ta" id="bossMsg" rows="3" placeholder='Ej: "publica el BMW de Juan a $400,000" o "agenda cita ma√±ana 4pm"'></textarea>
        <div class="boss-row">
            <button class="btn btn-g" onclick="bossOrder()">Enviar</button>
            <span class="boss-status" id="bossStatus"></span>
        </div>
        <div class="boss-quick" id="quickBtns">
            <button class="btn btn-x" onclick="bq('status')">Status</button>
            <button class="btn btn-x" onclick="bq('contactos nuevos hoy')">Nuevos hoy</button>
            <button class="btn btn-x" onclick="bq('citas pendientes')">Citas</button>
            <button class="btn btn-x" onclick="bq('inventario actual')">Inventario</button>
            <button class="btn btn-x" onclick="bq('metricas semana')">Metricas</button>
        </div>
    </div>
    <div class="boss">
        <h3>üß† <em>Instrucciones</em> permanentes</h3>
        <p style="font-size:11px;color:var(--t3);margin-bottom:8px">Reglas que Claw sigue siempre con clientes.</p>
        <textarea class="boss-ta" id="instrMsg" rows="2" placeholder='Ej: "cuando pregunten por garantia diles que damos 6 meses"'></textarea>
        <div class="boss-row">
            <button class="btn btn-o" onclick="addInstr()">Agregar</button>
            <button class="btn btn-r" onclick="clearInstr()">Limpiar todas</button>
        </div>
        <div id="instrList" style="margin-top:10px;font-size:11px;color:var(--t3)"></div>
    </div>
</div>

<!-- ===== LOG ===== -->
<div class="page" id="p-log">
    <div id="logView"></div>
    <div class="empty" id="emptyLog" style="display:none"><div class="empty-i">üìã</div><div class="empty-t">Sin actividad reciente</div></div>
</div>

<!-- ===== DETAIL MODAL ===== -->
<div class="modal-bg" id="modalBg" onclick="if(event.target===this)closeModal()">
    <div class="modal" id="modalContent"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===== CONFIG =====
const CLAW = 'http://134.209.51.172:3000';
const TURSO = 'https://crm-fyradrive-739458di.aws-us-west-2.turso.io';
const TURSO_T = 'eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3NzA4MjUwMDYsImlkIjoiYTczOTliMjctYWFlNi00YjhmLWJmYjktODQ2M2JmMWU1MzljIiwicmlkIjoiNWVhMDBiM2QtNzNiNS00Njg3LWFjN2YtMTNhMGQzZmJlZmM1In0.ZVnn2UF2WdEw_yvQYGGB9Eyvbh_JRniPhkByn6Vxiavki0FkHVM8Xb0cwu1Ijrhti_j3iiOxS5jtt2IwCRWvDA';

/*
PIPELINE DE CLAW ‚Äî Estados por comportamiento detectado:

NUEVO        ‚Üí Primer contacto. Claw detecta que es alguien nuevo.
EXPLORANDO   ‚Üí Pregunt√≥ por un auto, pidi√≥ info, mostr√≥ curiosidad.
INTERESADO   ‚Üí Pidi√≥ cotizaci√≥n, pregunt√≥ precio, enganche, cr√©dito.
NEGOCIANDO   ‚Üí Discute precio, objeciones, comparando opciones.
CITA         ‚Üí Cita agendada o en proceso de agendar.
CIERRE       ‚Üí Enganche, transferencia, firma pendiente.
CERRADO      ‚Üí Venta completada.
PERDIDO      ‚Üí Dej√≥ de responder, dijo que no, se fue.

Claw mueve a los contactos entre fases seg√∫n el comportamiento que detecta.
El CRM solo MUESTRA el estado actual. Sebastian puede forzar cambios.
*/
const FASES = [
    { id:'nuevo',      label:'Nuevo',      color:'var(--cyan)',   bg:'var(--cyan-bg)' },
    { id:'explorando', label:'Explorando', color:'var(--blue)',   bg:'var(--blue-bg)' },
    { id:'interesado', label:'Interesado', color:'var(--purple)', bg:'var(--purple-bg)' },
    { id:'negociando', label:'Negociando', color:'var(--orange)', bg:'var(--orange-bg)' },
    { id:'cita',       label:'Cita',       color:'var(--green)',  bg:'var(--green-bg)' },
    { id:'cierre',     label:'Cierre',     color:'var(--green)',  bg:'var(--green-bg)' },
    { id:'cerrado',    label:'Cerrado',    color:'var(--t3)',     bg:'var(--s3)' },
    { id:'perdido',    label:'Perdido',    color:'var(--red)',    bg:'var(--red-bg)' }
];

/*
CITA SEGURA ‚Äî Pipeline post-agendamiento:
Cita Agendada    ‚Üí Se agend√≥ la cita, esperando el d√≠a
D√≠a de Cita      ‚Üí Hoy es el d√≠a de la cita
En Camino        ‚Üí El comprador va en camino (FyraTrack activo)
Ya en la Cita    ‚Üí El comprador lleg√≥ al punto
*/
const CS_FASES = [
    { id:'cita_agendada', label:'Cita Agendada', icon:'üìÖ', color:'var(--green)',  bg:'var(--green-bg)' },
    { id:'dia_cita',      label:'D√≠a de Cita',   icon:'üåÖ', color:'var(--orange)', bg:'var(--orange-bg)' },
    { id:'en_camino',     label:'En Camino',      icon:'üöó', color:'var(--blue)',   bg:'var(--blue-bg)' },
    { id:'ya_en_cita',    label:'Ya en la Cita',  icon:'üìç', color:'var(--purple)', bg:'var(--purple-bg)' }
];

var contactos = [];
var deals = [];
var mensajes = [];

// ===== TURSO =====
async function tq(sql) {
    try {
        var r = await fetch(TURSO + '/v3/pipeline', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + TURSO_T, 'Content-Type': 'application/json' },
            body: JSON.stringify({ requests: [{ type: 'execute', stmt: { sql, args: [] } }, { type: 'close' }] })
        });
        var d = await r.json();
        if (d.results && d.results[0] && d.results[0].response && d.results[0].response.result) {
            var res = d.results[0].response.result;
            var cols = res.cols || [];
            return (res.rows || []).map(function(row) {
                var o = {};
                for (var i = 0; i < cols.length; i++) o[cols[i].name] = row[i] ? row[i].value : null;
                return o;
            });
        }
    } catch(e) { console.log('tq err:', e); }
    return [];
}
async function te(sql) {
    return fetch(TURSO + '/v3/pipeline', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + TURSO_T, 'Content-Type': 'application/json' },
        body: JSON.stringify({ requests: [{ type: 'execute', stmt: { sql, args: [] } }, { type: 'close' }] })
    });
}

// ===== LOAD =====
async function load() {
    // Status
    try {
        var sr = await fetch(CLAW + '/status');
        var s = await sr.json();
        el('dot').className = 'dot' + (s.status === 'connected' ? '' : ' off');
        el('pVer').textContent = s.version || 'v9';
        el('pTools').textContent = (s.tools || 0) + ' tools';
        el('pIn').textContent = (s.msgs ? s.msgs.in : 0) + ' in';
        el('pOut').textContent = (s.msgs ? s.msgs.out : 0) + ' out';
    } catch(e) { el('dot').className = 'dot off'; }

    // Contactos
    contactos = await tq('SELECT * FROM claw_contactos ORDER BY updated_at DESC LIMIT 100');
    el('bPipe').textContent = contactos.length;
    renderPipeline();

    // Deals (Cita Segura pipeline)
    deals = await tq("SELECT d.*, ct.fecha as joined_fecha, ct.lugar as joined_lugar, ct.auto as joined_auto FROM claw_deals d LEFT JOIN claw_citas ct ON d.cita_id = ct.id WHERE d.estado IN ('cita_agendada','dia_cita','en_camino','ya_en_cita','momento_cita') ORDER BY d.updated_at DESC LIMIT 50");
    // Normalize: map momento_cita ‚Üí ya_en_cita, merge cita data
    deals = deals.map(function(d) {
        if (d.estado === 'momento_cita') d.estado = 'ya_en_cita';
        // Use joined cita data or deal's own columns
        d.cita_fecha = d.cita_fecha || d.joined_fecha || null;
        d.cita_lugar = d.cita_lugar || d.joined_lugar || null;
        d.nombre = d.comprador_nombre || 'Sin nombre';
        d.telefono = d.comprador_telefono || '';
        d.interes = d.auto_nombre || d.joined_auto || '';
        return d;
    });
    el('bCitaSeg').textContent = deals.length;
    renderCitaSegura();

    // Log - √∫ltimos mensajes
    mensajes = await tq("SELECT telefono, nombre, mensaje, direccion, timestamp FROM wa_messages ORDER BY timestamp DESC LIMIT 40");
    renderLog();

    // Instrucciones
    var instr = await tq("SELECT value FROM claw_config WHERE key = 'boss_instructions'");
    if (instr.length && instr[0].value) {
        el('instrList').innerHTML = '<strong style="color:var(--orange)">Activas:</strong><br>' + instr[0].value.replace(/\n/g, '<br>');
    } else {
        el('instrList').innerHTML = '<em>Ninguna instruccion activa</em>';
    }
}

// ===== PIPELINE =====
function renderPipeline() {
    // Mapear fases del viejo sistema al nuevo
    var mapped = contactos.map(function(c) {
        var fase = (c.fase || 'nuevo').toLowerCase();
        // Mapear fases viejas a nuevas
        if (fase === 'interes') fase = 'explorando';
        if (fase === 'confianza') fase = 'interesado';
        if (fase === 'accion') fase = 'negociando';
        return Object.assign({}, c, { fase: fase });
    });

    var html = FASES.map(function(f) {
        var items = mapped.filter(function(c) { return c.fase === f.id; });
        return '<div class="pipe-col">' +
            '<div class="pipe-head">' +
                '<span class="pipe-title" style="color:' + f.color + '">' + f.label + '</span>' +
                '<span class="pipe-count">' + items.length + '</span>' +
            '</div>' +
            '<div class="pipe-body">' +
                (items.length ? items.map(function(c) { return renderCard(c, f); }).join('') : '<div style="padding:20px;text-align:center;color:var(--t3);font-size:11px">‚Äî</div>') +
            '</div>' +
        '</div>';
    }).join('');
    el('pipelineView').innerHTML = html;
}

function renderCard(c, fase) {
    var t = ago(Number(c.updated_at || c.created_at));
    var typeClass = c.tipo === 'vendedor' ? 'tag-vendedor' : 'tag-comprador';
    var signal = getSignal(c);
    return '<div class="cc" onclick="showDetail(\'' + (c.telefono||'') + '\')">' +
        '<div class="cc-top">' +
            '<span class="cc-name">' + (c.nombre || 'Sin nombre') + '</span>' +
            '<span class="cc-tag ' + typeClass + '">' + (c.tipo || '?') + '</span>' +
        '</div>' +
        '<div class="cc-tel"><a href="https://wa.me/' + (c.telefono||'') + '" target="_blank" onclick="event.stopPropagation()">+' + (c.telefono||'') + '</a></div>' +
        (c.interes ? '<div class="cc-interest">' + c.interes + '</div>' : '') +
        '<div class="cc-bottom">' +
            '<span class="cc-time">' + t + '</span>' +
            (signal ? '<span class="cc-signal ' + signal.cls + '">' + signal.txt + '</span>' : '') +
        '</div>' +
        (c.notas ? '<div class="cc-notes">' + truncate(c.notas, 80) + '</div>' : '') +
        (c.fotos_count > 0 ? '<div class="cc-photos"><span>üì∑ ' + c.fotos_count + ' fotos</span></div>' : '') +
    '</div>';
}

function getSignal(c) {
    var updated = Number(c.updated_at || 0);
    var diffH = (Date.now() - updated) / 3600000;
    if (diffH < 1) return { cls: 'sig-hot', txt: 'HOT' };
    if (diffH < 24) return { cls: 'sig-warm', txt: 'WARM' };
    if (diffH > 72) return { cls: 'sig-cold', txt: 'COLD' };
    return null;
}

// ===== CITA SEGURA =====
function renderCitaSegura() {
    if (!deals.length) {
        el('citaSeguraView').innerHTML = '';
        el('emptyCS').style.display = 'block';
        return;
    }
    el('emptyCS').style.display = 'none';

    var html = CS_FASES.map(function(f) {
        var items = deals.filter(function(d) { return d.estado === f.id; });
        return '<div class="pipe-col">' +
            '<div class="pipe-head">' +
                '<span class="pipe-title" style="color:' + f.color + '">' + f.icon + ' ' + f.label + '</span>' +
                '<span class="pipe-count">' + items.length + '</span>' +
            '</div>' +
            '<div class="pipe-body">' +
                (items.length ? items.map(function(d) { return renderDealCard(d, f); }).join('') : '<div style="padding:20px;text-align:center;color:var(--t3);font-size:11px">‚Äî</div>') +
            '</div>' +
        '</div>';
    }).join('');
    el('citaSeguraView').innerHTML = html;
}

function renderDealCard(d, fase) {
    var nombre = d.nombre || d.comprador_nombre || 'Sin nombre';
    var tel = d.telefono || '';
    var isFb = tel.startsWith('fb_');
    var waLink = isFb ? '#' : 'https://wa.me/' + tel;
    var telDisplay = isFb ? 'üìò Messenger' : '+' + tel;
    var src = d.fuente || (isFb ? 'messenger' : 'whatsapp');
    var srcClass = isFb ? 'src-msg' : 'src-wa';
    var srcLabel = isFb ? 'MSG' : 'WA';

    // Countdown to cita
    var cd = countdown(d.cita_fecha);

    // Fecha legible
    var fechaStr = '';
    if (d.cita_fecha) {
        try {
            var fd = new Date(d.cita_fecha);
            fechaStr = fd.toLocaleDateString('es-MX', { weekday:'short', day:'numeric', month:'short' }) + ' ' +
                       fd.toLocaleTimeString('es-MX', { hour:'2-digit', minute:'2-digit' });
        } catch(e) { fechaStr = d.cita_fecha; }
    }

    // Next state button
    var nextState = '';
    var nextLabel = '';
    if (d.estado === 'cita_agendada') { nextState = 'dia_cita'; nextLabel = '‚Üí D√≠a de Cita'; }
    else if (d.estado === 'dia_cita') { nextState = 'en_camino'; nextLabel = 'üöó En Camino'; }
    else if (d.estado === 'en_camino') { nextState = 'ya_en_cita'; nextLabel = 'üìç Ya en Cita'; }

    // Draft section (editable notification)
    var draftHtml = '';
    if (d.estado === 'cita_agendada') {
        var defaultDraft = '¬°Hey ' + nombre.split(' ')[0] + '! Recuerda que tienes cita ' + (fechaStr || 'pronto') + '. ¬øTodo en pie? üí™';
        draftHtml = '<div class="deal-draft">' +
            '<div class="deal-draft-label">‚úèÔ∏è Recordatorio (editable)</div>' +
            '<textarea class="deal-draft-ta" id="draft_' + d.id + '">' + (d.draft_msg || defaultDraft) + '</textarea>' +
            '<div style="display:flex;gap:4px;margin-top:4px">' +
                '<button class="btn btn-g" style="font-size:10px;padding:3px 8px" onclick="sendDealDraft(\'' + d.id + '\',\'' + tel + '\')">Enviar</button>' +
                '<button class="btn btn-x" style="font-size:10px;padding:3px 8px" onclick="saveDealDraft(\'' + d.id + '\')">Guardar</button>' +
            '</div>' +
        '</div>';
    } else if (d.estado === 'dia_cita') {
        var morningMsg = '¬°Buenos d√≠as ' + nombre.split(' ')[0] + '! Hoy es el gran d√≠a üî• Nos vemos ' + (fechaStr || '') + '. ¬øListo?';
        draftHtml = '<div class="deal-draft">' +
            '<div class="deal-draft-label">üåÖ Mensaje del d√≠a</div>' +
            '<textarea class="deal-draft-ta" id="draft_' + d.id + '">' + (d.draft_msg || morningMsg) + '</textarea>' +
            '<div style="display:flex;gap:4px;margin-top:4px">' +
                '<button class="btn btn-g" style="font-size:10px;padding:3px 8px" onclick="sendDealDraft(\'' + d.id + '\',\'' + tel + '\')">Enviar</button>' +
                '<button class="btn btn-x" style="font-size:10px;padding:3px 8px" onclick="saveDealDraft(\'' + d.id + '\')">Guardar</button>' +
            '</div>' +
        '</div>';
    } else if (d.estado === 'en_camino') {
        draftHtml = '<div class="deal-draft">' +
            '<div class="deal-draft-label">üöó FyraTrack activo</div>' +
            '<div style="font-size:11px;color:var(--green);padding:4px 0">Tracking en vivo enviado al comprador</div>' +
        '</div>';
    }

    // Force state buttons
    var stateButtons = CS_FASES.map(function(f) {
        var isActive = d.estado === f.id;
        return '<button class="cs-state-btn' + (isActive ? ' active' : '') + '" onclick="moveDealState(\'' + d.id + '\',\'' + f.id + '\')">' + f.icon + '</button>';
    }).join('');

    return '<div class="deal-card">' +
        '<div class="deal-top">' +
            '<span class="deal-name">' + nombre + '</span>' +
            '<span class="deal-source ' + srcClass + '">' + srcLabel + '</span>' +
        '</div>' +
        (d.interes ? '<div class="deal-auto">' + truncate(d.interes, 60) + '</div>' : '') +
        '<div class="deal-tel"><a href="' + waLink + '" target="_blank" onclick="event.stopPropagation()">' + telDisplay + '</a></div>' +
        (d.cita_fecha ? '<div class="deal-cd ' + cd.cls + '">' + cd.txt + '</div>' : '') +
        (fechaStr ? '<div class="deal-fecha">üìÖ ' + fechaStr + '</div>' : '') +
        (d.cita_lugar ? '<div class="deal-lugar">üìç ' + d.cita_lugar + '</div>' : '') +
        draftHtml +
        '<div class="deal-btns">' +
            (nextState ? '<button class="btn btn-g" onclick="moveDealState(\'' + d.id + '\',\'' + nextState + '\')">' + nextLabel + '</button>' : '') +
            '<button class="btn btn-r" onclick="cancelDeal(\'' + d.id + '\')">Cancelar</button>' +
        '</div>' +
        '<div style="display:flex;gap:4px;margin-top:6px;justify-content:center">' + stateButtons + '</div>' +
        (d.notas ? '<div class="deal-notas">' + truncate(d.notas, 80) + '</div>' : '') +
    '</div>';
}

// ===== LOG =====
function renderLog() {
    if (!mensajes.length) { el('logView').innerHTML = ''; el('emptyLog').style.display = 'block'; return; }
    el('emptyLog').style.display = 'none';
    el('logView').innerHTML = mensajes.map(function(m) {
        var isOut = m.direccion === 'out';
        var time = new Date(Number(m.timestamp) * 1000);
        var timeStr = time.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
        var dateStr = time.toLocaleDateString('es-MX', { day: '2-digit', month: 'short' });
        return '<div style="padding:8px 10px;border-bottom:1px solid var(--b1);display:flex;gap:10px;align-items:flex-start">' +
            '<div style="min-width:50px;font-size:10px;color:var(--t3);padding-top:2px">' + dateStr + '<br>' + timeStr + '</div>' +
            '<div style="flex:1">' +
                '<div style="font-size:11px;margin-bottom:2px"><span style="font-weight:700;color:' + (isOut ? 'var(--green)' : 'var(--blue)') + '">' + (isOut ? 'SEB ‚Üí' : '‚Üê ' + (m.nombre || m.telefono)) + '</span>' +
                (!isOut ? ' <span style="color:var(--t3);font-size:10px">+' + m.telefono + '</span>' : '') + '</div>' +
                '<div style="font-size:12px;color:var(--t2)">' + truncate(m.mensaje, 120) + '</div>' +
            '</div>' +
        '</div>';
    }).join('');
}

// ===== DETAIL MODAL =====
async function showDetail(tel) {
    if (!tel) return;
    var c = contactos.find(function(x) { return x.telefono === tel; });
    if (!c) return;

    // Cargar historial de mensajes
    var msgs = await tq("SELECT mensaje, direccion, nombre, timestamp FROM wa_messages WHERE telefono = '" + tel + "' ORDER BY timestamp DESC LIMIT 20");

    var html = '<button class="modal-close" onclick="closeModal()">‚úï</button>' +
        '<h2>' + (c.nombre || 'Sin nombre') + '</h2>' +
        '<div class="modal-section"><div class="modal-label">Telefono</div><div class="modal-val"><a href="https://wa.me/' + tel + '" target="_blank" style="color:var(--green)">' + tel + '</a></div></div>' +
        '<div class="modal-section"><div class="modal-label">Tipo</div><div class="modal-val">' + (c.tipo || '?') + '</div></div>' +
        '<div class="modal-section"><div class="modal-label">Fase actual</div><div class="modal-val">' + (c.fase || 'nuevo') + '</div></div>' +
        '<div class="modal-section"><div class="modal-label">Interes</div><div class="modal-val">' + (c.interes || '‚Äî') + '</div></div>' +
        (c.notas ? '<div class="modal-section"><div class="modal-label">Notas de Claw</div><div class="modal-val" style="font-size:12px">' + c.notas + '</div></div>' : '') +

        '<div class="modal-section"><div class="modal-label">Mover fase</div><div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:4px">' +
        FASES.map(function(f) {
            return '<button class="btn btn-x" style="font-size:10px;padding:4px 8px' + (c.fase === f.id ? ';border-color:var(--green);color:var(--green)' : '') + '" onclick="moveFase(\'' + tel + '\',\'' + f.id + '\')">' + f.label + '</button>';
        }).join('') +
        '</div></div>' +

        '<div class="modal-section"><div class="modal-label">Historial (' + msgs.length + ')</div><div class="modal-history">' +
        (msgs.length ? msgs.reverse().map(function(m) {
            var isOut = m.direccion === 'out';
            return '<div class="modal-msg"><span class="dir' + (isOut ? '' : ' in') + '">' + (isOut ? 'SEB' : m.nombre || 'CLIENTE') + '</span> ' + truncate(m.mensaje, 100) + '</div>';
        }).join('') : '<div style="color:var(--t3);font-size:12px">Sin mensajes</div>') +
        '</div></div>';

    el('modalContent').innerHTML = html;
    el('modalBg').classList.add('on');
}

function closeModal() { el('modalBg').classList.remove('on'); }

async function moveFase(tel, fase) {
    await te("UPDATE claw_contactos SET fase = '" + fase + "', updated_at = " + Date.now() + " WHERE telefono = '" + tel + "'");
    toast('Fase cambiada a ' + fase);
    closeModal();
    load();
}

// ===== CITA SEGURA ACTIONS =====
async function moveDealState(id, estado) {
    await te("UPDATE claw_deals SET estado = '" + estado + "', updated_at = " + Date.now() + " WHERE id = " + id);
    var label = CS_FASES.find(function(f) { return f.id === estado; });
    toast('‚Üí ' + (label ? label.icon + ' ' + label.label : estado));
    load();
}

async function cancelDeal(id) {
    if (!confirm('¬øCancelar este deal?')) return;
    await te("UPDATE claw_deals SET estado = 'perdido', updated_at = " + Date.now() + " WHERE id = " + id);
    toast('Deal cancelado');
    load();
}

async function sendDealDraft(id, tel) {
    var ta = el('draft_' + id);
    if (!ta) return;
    var msg = ta.value.trim();
    if (!msg) return toast('Escribe un mensaje');
    try {
        var isFb = tel.startsWith('fb_');
        if (isFb) {
            await fetch(CLAW + '/api/messenger-send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ psid: tel.replace('fb_',''), mensaje: msg })
            });
        } else {
            await fetch(CLAW + '/api/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ telefono: tel, mensaje: msg, api_key: 'fyradrive2026' })
            });
        }
        // Save draft as sent
        await te("UPDATE claw_deals SET draft_msg = '" + msg.replace(/'/g, "''") + "', updated_at = " + Date.now() + " WHERE id = " + id);
        toast('Mensaje enviado ‚úì');
    } catch(e) {
        toast('Error: ' + e.message);
    }
}

async function saveDealDraft(id) {
    var ta = el('draft_' + id);
    if (!ta) return;
    var msg = ta.value.trim();
    await te("UPDATE claw_deals SET draft_msg = '" + msg.replace(/'/g, "''") + "', updated_at = " + Date.now() + " WHERE id = " + id);
    toast('Draft guardado ‚úì');
}

// ===== BOSS =====
async function bossOrder() {
    var msg = el('bossMsg').value.trim();
    if (!msg) return;
    el('bossStatus').textContent = 'Enviando...';
    try {
        var cur = await tq("SELECT value FROM claw_config WHERE key = 'boss_instructions'");
        var existing = (cur.length && cur[0].value) ? cur[0].value : '';
        var ts = new Date().toLocaleDateString('es-MX', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
        var updated = existing + '\n[' + ts + ' ORDEN] ' + msg;
        await te("INSERT OR REPLACE INTO claw_config (key, value, updated_at) VALUES ('boss_instructions', '" + updated.replace(/'/g, "''") + "', unixepoch())");
        el('bossStatus').textContent = 'Orden registrada';
        el('bossMsg').value = '';
        toast('Orden enviada');
        load();
    } catch(e) { el('bossStatus').textContent = 'Error: ' + e.message; }
}
function bq(msg) { el('bossMsg').value = msg; bossOrder(); }

async function addInstr() {
    var msg = el('instrMsg').value.trim();
    if (!msg) return;
    var cur = await tq("SELECT value FROM claw_config WHERE key = 'boss_instructions'");
    var existing = (cur.length && cur[0].value) ? cur[0].value : '';
    var ts = new Date().toLocaleDateString('es-MX', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
    var updated = existing + '\n[' + ts + '] ' + msg;
    await te("INSERT OR REPLACE INTO claw_config (key, value, updated_at) VALUES ('boss_instructions', '" + updated.replace(/'/g, "''") + "', unixepoch())");
    el('instrMsg').value = '';
    toast('Instruccion agregada');
    load();
}

async function clearInstr() {
    if (!confirm('Limpiar TODAS las instrucciones?')) return;
    await te("INSERT OR REPLACE INTO claw_config (key, value, updated_at) VALUES ('boss_instructions', '', unixepoch())");
    toast('Instrucciones limpiadas');
    load();
}

// ===== UTILS =====
function el(id) { return document.getElementById(id); }
function truncate(s, n) { return (s||'').length > n ? s.substring(0, n) + '...' : (s||''); }
function ago(ts) {
    if (!ts) return '';
    var d = Date.now() - ts, m = Math.floor(d/60000);
    if (m < 1) return 'ahora';
    if (m < 60) return m + 'min';
    var h = Math.floor(m/60);
    if (h < 24) return h + 'h';
    return Math.floor(h/24) + 'd';
}
function countdown(f) {
    if (!f) return { txt:'Sin fecha', cls:'' };
    try {
        var d = new Date(f); if (isNaN(d)) return { txt:f, cls:'' };
        var diff = d - new Date(), abs = Math.abs(diff);
        var mins = Math.floor(abs/60000), hrs = Math.floor(mins/60), days = Math.floor(hrs/24);
        if (diff < 0) {
            if (days > 0) return { txt:'Hace ' + days + 'd', cls:'past' };
            if (hrs > 0) return { txt:'Hace ' + hrs + 'h', cls:'past' };
            return { txt:'Hace ' + mins + 'min', cls:'past' };
        }
        if (days > 0) return { txt:'En ' + days + 'd ' + (hrs%24) + 'h', cls:'' };
        if (hrs > 0) return { txt:'En ' + hrs + 'h ' + (mins%60) + 'min', cls: hrs < 2 ? 'soon' : '' };
        if (mins > 0) return { txt:'En ' + mins + 'min', cls:'now' };
        return { txt:'AHORA', cls:'now' };
    } catch(e) { return { txt:f, cls:'' }; }
}
function toast(msg) { var t = el('toast'); t.textContent = msg; t.classList.add('on'); setTimeout(function() { t.classList.remove('on'); }, 2500); }

// ===== NAV =====
document.querySelectorAll('.nav-item').forEach(function(n) {
    n.addEventListener('click', function() {
        document.querySelectorAll('.nav-item').forEach(function(x) { x.classList.remove('on'); });
        document.querySelectorAll('.page').forEach(function(x) { x.classList.remove('on'); });
        this.classList.add('on');
        el('p-' + this.dataset.p).classList.add('on');
    });
});

// ===== INIT =====
load();
setInterval(load, 12000);
setInterval(renderCitaSegura, 60000);
</script>
</body>
</html>
