<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLAW - FyraDrive</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --surface2: #1e1e1e;
            --border: #2a2a2a;
            --text: #e5e5e5;
            --text2: #888;
            --accent: #22c55e;
            --accent2: #16a34a;
            --orange: #f59e0b;
            --red: #ef4444;
            --blue: #3b82f6;
            --purple: #8b5cf6;
            --cyan: #06b6d4;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

        /* TOP BAR */
        .topbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px 24px; border-bottom: 1px solid var(--border);
            background: var(--surface);
        }
        .topbar-left { display: flex; align-items: center; gap: 12px; }
        .topbar-left h1 { font-size: 18px; font-weight: 800; letter-spacing: -0.5px; }
        .topbar-left h1 span { color: var(--accent); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); animation: pulse 2s infinite; }
        .status-dot.offline { background: var(--red); animation: none; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .topbar-right { display: flex; align-items: center; gap: 12px; font-size: 12px; color: var(--text2); }
        .stat-pill { background: var(--surface2); padding: 4px 10px; border-radius: 20px; font-weight: 600; }

        /* TABS */
        .tabs { display: flex; gap: 0; border-bottom: 1px solid var(--border); background: var(--surface); padding: 0 24px; }
        .tab {
            padding: 12px 20px; font-size: 13px; font-weight: 600; cursor: pointer;
            color: var(--text2); border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab .count { background: var(--surface2); padding: 2px 7px; border-radius: 10px; font-size: 11px; margin-left: 6px; }

        /* CONTENT */
        .content { padding: 20px 24px; max-width: 1400px; margin: 0 auto; }
        .section { display: none; }
        .section.active { display: block; }

        /* CARDS GRID */
        .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 12px; }
        .card {
            background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
            padding: 16px; transition: all 0.2s; cursor: default;
        }
        .card:hover { border-color: var(--accent); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .card-name { font-weight: 700; font-size: 15px; }
        .card-type {
            font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .type-vendedor { background: rgba(139,92,246,0.15); color: var(--purple); }
        .type-comprador { background: rgba(59,130,246,0.15); color: var(--blue); }
        .card-phone { font-size: 13px; color: var(--text2); margin-bottom: 8px; }
        .card-phone a { color: var(--accent); text-decoration: none; }
        .card-interest { font-size: 12px; color: var(--text2); margin-bottom: 10px; padding: 6px 10px; background: var(--surface2); border-radius: 6px; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; }
        .fase-badge {
            font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 12px;
        }
        .fase-interes { background: rgba(6,182,212,0.15); color: var(--cyan); }
        .fase-confianza { background: rgba(245,158,11,0.15); color: var(--orange); }
        .fase-accion { background: rgba(139,92,246,0.15); color: var(--purple); }
        .fase-cierre { background: rgba(34,197,94,0.15); color: var(--accent); }
        .card-time { font-size: 11px; color: var(--text2); }
        .card-notes { font-size: 11px; color: var(--text2); margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }

        /* CITAS */
        .cita-card {
            background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
            padding: 16px; margin-bottom: 12px; transition: all 0.2s;
        }
        .cita-card:hover { border-color: var(--orange); }
        .cita-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .cita-auto { font-weight: 700; font-size: 15px; }
        .cita-estado {
            font-size: 10px; font-weight: 700; padding: 3px 10px; border-radius: 12px;
            text-transform: uppercase;
        }
        .estado-pendiente { background: rgba(245,158,11,0.15); color: var(--orange); }
        .estado-confirmada { background: rgba(34,197,94,0.15); color: var(--accent); }
        .estado-completada { background: rgba(59,130,246,0.15); color: var(--blue); }
        .estado-cancelada { background: rgba(239,68,68,0.15); color: var(--red); }
        .cita-people { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .cita-person { padding: 8px 10px; background: var(--surface2); border-radius: 8px; }
        .cita-person-label { font-size: 10px; color: var(--text2); text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }
        .cita-person-name { font-size: 13px; font-weight: 600; }
        .cita-person-tel { font-size: 12px; color: var(--accent); }
        .cita-details { display: flex; gap: 16px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
        .cita-detail { display: flex; align-items: center; gap: 4px; font-size: 12px; color: var(--text2); }
        .cita-countdown {
            font-size: 24px; font-weight: 800; text-align: center; padding: 12px;
            background: var(--surface2); border-radius: 8px; margin-bottom: 12px;
        }
        .cita-countdown.soon { color: var(--orange); }
        .cita-countdown.now { color: var(--accent); animation: pulse 1s infinite; }
        .cita-countdown.past { color: var(--red); }
        .cita-map {
            width: 100%; height: 180px; border-radius: 8px; overflow: hidden;
            border: 1px solid var(--border); margin-bottom: 12px;
        }
        .cita-map iframe { width: 100%; height: 100%; border: none; }
        .cita-actions { display: flex; gap: 8px; }
        .btn {
            padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600;
            border: none; cursor: pointer; transition: all 0.2s;
        }
        .btn-accent { background: var(--accent); color: #000; }
        .btn-accent:hover { background: var(--accent2); }
        .btn-orange { background: var(--orange); color: #000; }
        .btn-red { background: rgba(239,68,68,0.15); color: var(--red); border: 1px solid rgba(239,68,68,0.3); }
        .btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
        .btn-ghost:hover { border-color: var(--accent); }

        /* FORCE ACTION PANEL */
        .force-panel {
            background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
            padding: 20px; margin-bottom: 20px;
        }
        .force-panel h3 { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--orange); }
        .force-input {
            width: 100%; padding: 10px 14px; background: var(--surface2); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text); font-family: inherit; font-size: 13px; resize: none;
        }
        .force-input:focus { outline: none; border-color: var(--accent); }
        .force-row { display: flex; gap: 8px; margin-top: 10px; align-items: center; }
        .force-select {
            padding: 8px 12px; background: var(--surface2); border: 1px solid var(--border);
            border-radius: 8px; color: var(--text); font-size: 12px;
        }

        /* EMPTY STATE */
        .empty { text-align: center; padding: 60px 20px; color: var(--text2); }
        .empty-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-text { font-size: 14px; }

        /* TOAST */
        .toast {
            position: fixed; bottom: 20px; right: 20px; padding: 12px 20px;
            background: var(--accent); color: #000; font-weight: 600; font-size: 13px;
            border-radius: 8px; z-index: 9999; transform: translateY(100px);
            transition: transform 0.3s; box-shadow: 0 4px 20px rgba(34,197,94,0.3);
        }
        .toast.show { transform: translateY(0); }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .cards { grid-template-columns: 1fr; }
            .topbar { flex-direction: column; gap: 10px; }
            .cita-people { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="topbar">
    <div class="topbar-left">
        <div class="status-dot" id="statusDot"></div>
        <h1>CLAW <span>FYRADRIVE</span></h1>
    </div>
    <div class="topbar-right">
        <span class="stat-pill" id="statVersion">v9</span>
        <span class="stat-pill" id="statTools">12 tools</span>
        <span class="stat-pill" id="statMsgs">0 msgs</span>
        <span class="stat-pill" id="statModel">sonnet</span>
    </div>
</div>

<div class="tabs">
    <div class="tab active" data-tab="contactos">Contactos <span class="count" id="countContactos">0</span></div>
    <div class="tab" data-tab="citas">Citas <span class="count" id="countCitas">0</span></div>
    <div class="tab" data-tab="forzar">Forzar Accion</div>
</div>

<div class="content">
    <!-- CONTACTOS -->
    <div class="section active" id="sec-contactos">
        <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
            <button class="btn btn-ghost filter-btn active" data-filter="todos">Todos</button>
            <button class="btn btn-ghost filter-btn" data-filter="vendedor">Vendedores</button>
            <button class="btn btn-ghost filter-btn" data-filter="comprador">Compradores</button>
        </div>
        <div class="cards" id="contactosList"></div>
        <div class="empty" id="emptyContactos" style="display:none">
            <div class="empty-icon">üì≠</div>
            <div class="empty-text">Claw no ha registrado contactos todavia</div>
        </div>
    </div>

    <!-- CITAS -->
    <div class="section" id="sec-citas">
        <div id="citasList"></div>
        <div class="empty" id="emptyCitas" style="display:none">
            <div class="empty-icon">üìÖ</div>
            <div class="empty-text">No hay citas agendadas</div>
        </div>
    </div>

    <!-- FORZAR ACCION -->
    <div class="section" id="sec-forzar">
        <div class="force-panel">
            <h3>‚ö° Enviar orden a Claw via Boss Mode</h3>
            <p style="font-size:12px;color:var(--text2);margin-bottom:12px;">Esto envia un mensaje como si fuera Sebastian por WhatsApp. Claw lo recibe como orden directa.</p>
            <textarea class="force-input" id="forceMsg" rows="3" placeholder='Ejemplo: "publica el BMW M3 2023 de Juan Garcia a $450,000"'></textarea>
            <div class="force-row">
                <button class="btn btn-accent" onclick="sendForceAction()">Enviar Orden</button>
                <span style="font-size:11px;color:var(--text2)" id="forceStatus"></span>
            </div>
        </div>

        <div class="force-panel">
            <h3>üìã Acciones rapidas</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-ghost" onclick="quickAction('dame el status de hoy')">Status del dia</button>
                <button class="btn btn-ghost" onclick="quickAction('cuantos contactos nuevos hay')">Contactos nuevos</button>
                <button class="btn btn-ghost" onclick="quickAction('que citas hay pendientes')">Citas pendientes</button>
                <button class="btn btn-ghost" onclick="quickAction('que autos tenemos publicados')">Inventario</button>
                <button class="btn btn-ghost" onclick="quickAction('dame las metricas de la semana')">Metricas semana</button>
            </div>
        </div>

        <div class="force-panel">
            <h3>üîß Modificar comportamiento</h3>
            <textarea class="force-input" id="instructionMsg" rows="2" placeholder='Ejemplo: "cuando alguien pregunte por garantia, dile que incluimos 6 meses"'></textarea>
            <div class="force-row">
                <button class="btn btn-orange" onclick="sendInstruction()">Agregar Instruccion</button>
                <button class="btn btn-red" onclick="clearInstructions()">Limpiar todas</button>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
const CLAW_SERVER = 'http://134.209.51.172:3000';
const CLAW_API = CLAW_SERVER;
// WhatsApp Boss ‚Äî Para forzar acciones, mandamos via la API de WA de Vercel
// PERO como Claw NO tiene API de forzar, usamos el endpoint de status para verificar
// y mostramos datos de las tablas de Turso directamente

const TURSO_URL = 'https://crm-fyradrive-739458di.aws-us-west-2.turso.io';
const TURSO_TOKEN = 'eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3NzA4MjUwMDYsImlkIjoiYTczOTliMjctYWFlNi00YjhmLWJmYjktODQ2M2JmMWU1MzljIiwicmlkIjoiNWVhMDBiM2QtNzNiNS00Njg3LWFjN2YtMTNhMGQzZmJlZmM1In0.ZVnn2UF2WdEw_yvQYGGB9Eyvbh_JRniPhkByn6Vxiavki0FkHVM8Xb0cwu1Ijrhti_j3iiOxS5jtt2IwCRWvDA';

var currentFilter = 'todos';
var contactos = [];
var citas = [];

// ===== TURSO QUERY =====
async function tursoQuery(sql) {
    try {
        var args = [];
        var resp = await fetch(TURSO_URL + '/v3/pipeline', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + TURSO_TOKEN, 'Content-Type': 'application/json' },
            body: JSON.stringify({ requests: [{ type: 'execute', stmt: { sql: sql, args: [] } }, { type: 'close' }] })
        });
        var data = await resp.json();
        if (data.results && data.results[0] && data.results[0].response && data.results[0].response.result) {
            var r = data.results[0].response.result;
            var cols = r.cols || [];
            return (r.rows || []).map(function(row) {
                var obj = {};
                for (var i = 0; i < cols.length; i++) obj[cols[i].name] = row[i] ? row[i].value : null;
                return obj;
            });
        }
    } catch(e) { console.log('Turso error:', e); }
    return [];
}

// ===== LOAD DATA =====
async function loadData() {
    try {
        // Status del servidor
        var statusResp = await fetch(CLAW_SERVER + '/status');
        var status = await statusResp.json();
        document.getElementById('statusDot').className = 'status-dot' + (status.status === 'connected' ? '' : ' offline');
        document.getElementById('statVersion').textContent = status.version || 'v9';
        document.getElementById('statTools').textContent = (status.tools || 12) + ' tools';
        document.getElementById('statMsgs').textContent = (status.msgs ? status.msgs.in + status.msgs.out : 0) + ' msgs';
        document.getElementById('statModel').textContent = (status.model || 'sonnet').split('-').pop().substring(0,6);
    } catch(e) {
        document.getElementById('statusDot').className = 'status-dot offline';
    }

    // Contactos desde Turso
    contactos = await tursoQuery('SELECT * FROM claw_contactos ORDER BY updated_at DESC LIMIT 50');
    document.getElementById('countContactos').textContent = contactos.length;
    renderContactos();

    // Citas desde Turso
    citas = await tursoQuery('SELECT * FROM claw_citas ORDER BY created_at DESC LIMIT 50');
    document.getElementById('countCitas').textContent = citas.length;
    renderCitas();
}

// ===== RENDER CONTACTOS =====
function renderContactos() {
    var filtered = contactos;
    if (currentFilter !== 'todos') {
        filtered = contactos.filter(function(c) { return c.tipo === currentFilter; });
    }

    var container = document.getElementById('contactosList');
    var empty = document.getElementById('emptyContactos');

    if (!filtered.length) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    empty.style.display = 'none';

    container.innerHTML = filtered.map(function(c) {
        var timeAgo = getTimeAgo(Number(c.updated_at || c.created_at));
        var faseClass = 'fase-' + (c.fase || 'interes');
        var typeClass = 'type-' + (c.tipo || 'comprador');
        return '<div class="card">' +
            '<div class="card-header">' +
                '<div class="card-name">' + (c.nombre || 'Sin nombre') + '</div>' +
                '<span class="card-type ' + typeClass + '">' + (c.tipo || '?') + '</span>' +
            '</div>' +
            '<div class="card-phone"><a href="https://wa.me/' + (c.telefono || '') + '" target="_blank">+' + (c.telefono || '') + '</a></div>' +
            (c.interes ? '<div class="card-interest">' + c.interes + '</div>' : '') +
            '<div class="card-footer">' +
                '<span class="fase-badge ' + faseClass + '">' + (c.fase || 'interes') + '</span>' +
                '<span class="card-time">' + timeAgo + '</span>' +
            '</div>' +
            (c.notas ? '<div class="card-notes">' + c.notas + '</div>' : '') +
            (c.fotos_count > 0 ? '<div class="card-notes">üì∑ ' + c.fotos_count + ' fotos</div>' : '') +
        '</div>';
    }).join('');
}

// ===== RENDER CITAS =====
function renderCitas() {
    var container = document.getElementById('citasList');
    var empty = document.getElementById('emptyCitas');

    if (!citas.length) {
        container.innerHTML = '';
        empty.style.display = 'block';
        return;
    }
    empty.style.display = 'none';

    container.innerHTML = citas.map(function(c) {
        var estadoClass = 'estado-' + (c.estado || 'pendiente');
        var countdown = getCountdown(c.fecha);
        var countdownClass = countdown.class;
        var lat = c.lat || 25.6614;
        var lng = c.lng || -100.3491;
        var mapUrl = 'https://www.google.com/maps/embed/v1/place?key=AIzaSyBFw0Qbyq9zTFTd-tUY6dZWTgaQzuU17R8&q=' + lat + ',' + lng + '&zoom=15';
        var mapsLink = 'https://www.google.com/maps?q=' + lat + ',' + lng;

        return '<div class="cita-card">' +
            '<div class="cita-header">' +
                '<div class="cita-auto">' + (c.auto || 'Auto no especificado') + '</div>' +
                '<span class="cita-estado ' + estadoClass + '">' + (c.estado || 'pendiente') + '</span>' +
            '</div>' +
            '<div class="cita-countdown ' + countdownClass + '">' + countdown.text + '</div>' +
            '<div class="cita-people">' +
                '<div class="cita-person">' +
                    '<div class="cita-person-label">Comprador</div>' +
                    '<div class="cita-person-name">' + (c.comprador_nombre || '‚Äî') + '</div>' +
                    '<div class="cita-person-tel"><a href="https://wa.me/' + (c.comprador_telefono || '') + '" target="_blank" style="color:var(--accent);text-decoration:none">+' + (c.comprador_telefono || '') + '</a></div>' +
                '</div>' +
                '<div class="cita-person">' +
                    '<div class="cita-person-label">Vendedor</div>' +
                    '<div class="cita-person-name">' + (c.vendedor_nombre || '‚Äî') + '</div>' +
                    '<div class="cita-person-tel"><a href="https://wa.me/' + (c.vendedor_telefono || '') + '" target="_blank" style="color:var(--accent);text-decoration:none">+' + (c.vendedor_telefono || '') + '</a></div>' +
                '</div>' +
            '</div>' +
            '<div class="cita-details">' +
                '<div class="cita-detail">üìÖ ' + (c.fecha || 'Sin fecha') + '</div>' +
                '<div class="cita-detail">üìç ' + (c.lugar || 'Sin lugar') + '</div>' +
            '</div>' +
            '<div class="cita-map"><iframe src="' + mapUrl + '" loading="lazy"></iframe></div>' +
            '<div class="cita-actions">' +
                '<a href="' + mapsLink + '" target="_blank" class="btn btn-accent">Abrir Maps</a>' +
                '<button class="btn btn-ghost" onclick="forceCita(\'' + c.id + '\', \'confirmar\')">Confirmar</button>' +
                '<button class="btn btn-red" onclick="forceCita(\'' + c.id + '\', \'cancelar\')">Cancelar</button>' +
            '</div>' +
        '</div>';
    }).join('');
}

// ===== COUNTDOWN =====
function getCountdown(fechaStr) {
    if (!fechaStr) return { text: 'Sin fecha', class: '' };
    try {
        var fecha = new Date(fechaStr);
        if (isNaN(fecha.getTime())) {
            // Intentar parsear formatos comunes
            return { text: fechaStr, class: '' };
        }
        var now = new Date();
        var diff = fecha - now;
        var absDiff = Math.abs(diff);
        var mins = Math.floor(absDiff / 60000);
        var hours = Math.floor(mins / 60);
        var days = Math.floor(hours / 24);

        if (diff < 0) {
            if (days > 0) return { text: 'Hace ' + days + 'd ' + (hours%24) + 'h', class: 'past' };
            if (hours > 0) return { text: 'Hace ' + hours + 'h ' + (mins%60) + 'min', class: 'past' };
            return { text: 'Hace ' + mins + ' min', class: 'past' };
        }
        if (days > 0) return { text: 'En ' + days + 'd ' + (hours%24) + 'h', class: '' };
        if (hours > 0) return { text: 'En ' + hours + 'h ' + (mins%60) + 'min', class: hours < 2 ? 'soon' : '' };
        if (mins > 0) return { text: 'En ' + mins + ' min', class: 'now' };
        return { text: 'AHORA', class: 'now' };
    } catch(e) { return { text: fechaStr, class: '' }; }
}

function getTimeAgo(ts) {
    if (!ts) return '';
    var diff = Date.now() - ts;
    var mins = Math.floor(diff / 60000);
    if (mins < 1) return 'ahora';
    if (mins < 60) return mins + 'min';
    var hours = Math.floor(mins / 60);
    if (hours < 24) return hours + 'h';
    var days = Math.floor(hours / 24);
    return days + 'd';
}

// ===== FORCE ACTIONS =====
async function sendForceAction() {
    var msg = document.getElementById('forceMsg').value.trim();
    if (!msg) return;
    document.getElementById('forceStatus').textContent = 'Enviando...';

    // Enviar como mensaje de boss via la API de WhatsApp del servidor Claw
    // El servidor de Claw recibe mensajes del boss por WhatsApp
    // Desde aqui insertamos directamente la instruccion en Turso
    try {
        await tursoExec("INSERT OR REPLACE INTO claw_config (key, value, updated_at) VALUES ('pending_boss_order', '" + msg.replace(/'/g, "''") + "', unixepoch())");
        document.getElementById('forceStatus').textContent = 'Orden guardada. Claw la ejecutara en su proximo ciclo.';
        showToast('Orden enviada a Claw');
        document.getElementById('forceMsg').value = '';
    } catch(e) {
        document.getElementById('forceStatus').textContent = 'Error: ' + e.message;
    }
}

function quickAction(msg) {
    document.getElementById('forceMsg').value = msg;
    sendForceAction();
}

async function sendInstruction() {
    var msg = document.getElementById('instructionMsg').value.trim();
    if (!msg) return;
    try {
        var current = await tursoQuery("SELECT value FROM claw_config WHERE key = 'boss_instructions'");
        var cur = (current.length && current[0].value) ? current[0].value : '';
        var ts = new Date().toLocaleDateString('es-MX', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
        var updated = cur + '\n[' + ts + '] ' + msg;
        await tursoExec("INSERT OR REPLACE INTO claw_config (key, value, updated_at) VALUES ('boss_instructions', '" + updated.replace(/'/g, "''") + "', unixepoch())");
        showToast('Instruccion agregada');
        document.getElementById('instructionMsg').value = '';
    } catch(e) { showToast('Error: ' + e.message); }
}

async function clearInstructions() {
    if (!confirm('Limpiar TODAS las instrucciones de Claw?')) return;
    await tursoExec("INSERT OR REPLACE INTO claw_config (key, value, updated_at) VALUES ('boss_instructions', '', unixepoch())");
    showToast('Instrucciones limpiadas');
}

async function forceCita(citaId, accion) {
    var estado = accion === 'confirmar' ? 'confirmada' : 'cancelada';
    await tursoExec("UPDATE claw_citas SET estado = '" + estado + "', updated_at = " + Date.now() + " WHERE id = '" + citaId + "'");
    showToast('Cita ' + estado);
    loadData();
}

async function tursoExec(sql) {
    var resp = await fetch(TURSO_URL + '/v3/pipeline', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + TURSO_TOKEN, 'Content-Type': 'application/json' },
        body: JSON.stringify({ requests: [{ type: 'execute', stmt: { sql: sql, args: [] } }, { type: 'close' }] })
    });
    return resp.json();
}

function showToast(msg) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(function() { t.classList.remove('show'); }, 3000);
}

// ===== TABS =====
document.querySelectorAll('.tab').forEach(function(tab) {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
        document.querySelectorAll('.section').forEach(function(s) { s.classList.remove('active'); });
        this.classList.add('active');
        document.getElementById('sec-' + this.dataset.tab).classList.add('active');
    });
});

// ===== FILTERS =====
document.querySelectorAll('.filter-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');
        currentFilter = this.dataset.filter;
        renderContactos();
    });
});

// ===== INIT =====
loadData();
setInterval(loadData, 15000); // refresh cada 15s
setInterval(function() { renderCitas(); }, 60000); // actualizar countdowns cada minuto
</script>
</body>
</html>
